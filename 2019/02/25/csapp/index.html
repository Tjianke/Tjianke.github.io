<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-Hans,en,default">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta name="description" content="Short intro to C:Warm up1234#include &amp;lt; studio.h&amp;gt;                // C way of importinglong unsigned sizeof(a)             //returns the num of byteint main(int argc, char** argv)     // argc for">
<meta property="og:type" content="article">
<meta property="og:title" content="csapp">
<meta property="og:url" content="http://yoursite.com/2019/02/25/csapp/index.html">
<meta property="og:site_name" content="My personal website">
<meta property="og:description" content="Short intro to C:Warm up1234#include &amp;lt; studio.h&amp;gt;                // C way of importinglong unsigned sizeof(a)             //returns the num of byteint main(int argc, char** argv)     // argc for">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="http://yoursite.com/2019/02/25/csapp/E:/hexo/Hexo_Repository/source/_posts/csapp/1558495002048.png">
<meta property="og:image" content="http://yoursite.com/2019/02/25/csapp/E:/hexo/Hexo_Repository/source/_posts/csapp/1558495120915.png">
<meta property="og:image" content="http://yoursite.com/2019/02/25/csapp/E:/hexo/Hexo_Repository/source/_posts/csapp/1558495772633.png">
<meta property="og:image" content="http://yoursite.com/2019/02/25/csapp/E:/hexo/Hexo_Repository/source/_posts/csapp/1560335013589.png">
<meta property="og:image" content="http://yoursite.com/2019/02/25/csapp/E:/hexo/Hexo_Repository/source/_posts/csapp/1560343352359.png">
<meta property="og:image" content="http://yoursite.com/2019/02/25/csapp/E:/hexo/Hexo_Repository/source/_posts/csapp/1560344330982.png">
<meta property="og:image" content="http://yoursite.com/2019/02/25/csapp/E:/hexo/Hexo_Repository/source/_posts/csapp/1560344434529.png">
<meta property="og:image" content="http://yoursite.com/2019/02/25/csapp/E:/hexo/Hexo_Repository/source/_posts/csapp/1560345549422.png">
<meta property="og:image" content="http://yoursite.com/2019/02/25/csapp/E:/hexo/Hexo_Repository/source/_posts/csapp/1560345938057.png">
<meta property="og:image" content="http://yoursite.com/2019/02/25/csapp/E:/hexo/Hexo_Repository/source/_posts/csapp/1560346646317.png">
<meta property="og:image" content="http://yoursite.com/2019/02/25/csapp/E:/hexo/Hexo_Repository/source/_posts/csapp/1560348122146.png">
<meta property="og:image" content="http://yoursite.com/2019/02/25/csapp/E:/hexo/Hexo_Repository/source/_posts/csapp/1560350182293.png">
<meta property="og:image" content="http://yoursite.com/2019/02/25/csapp/E:/hexo/Hexo_Repository/source/_posts/csapp/1560350965464.png">
<meta property="og:image" content="http://yoursite.com/2019/02/25/csapp/E:/hexo/Hexo_Repository/source/_posts/csapp/1560399933478.png">
<meta property="og:image" content="http://yoursite.com/2019/02/25/csapp/E:/hexo/Hexo_Repository/source/_posts/csapp/1560400108755.png">
<meta property="og:image" content="http://yoursite.com/2019/02/25/csapp/E:/hexo/Hexo_Repository/source/_posts/csapp/1560400290401.png">
<meta property="og:image" content="http://yoursite.com/2019/02/25/csapp/E:/hexo/Hexo_Repository/source/_posts/csapp/1560423316129.png">
<meta property="og:image" content="http://yoursite.com/2019/02/25/csapp/E:/hexo/Hexo_Repository/source/_posts/csapp/1560424704158.png">
<meta property="og:image" content="http://yoursite.com/2019/02/25/csapp/E:/hexo/Hexo_Repository/source/_posts/csapp/1560425740286.png">
<meta property="og:image" content="http://yoursite.com/2019/02/25/csapp/E:/hexo/Hexo_Repository/source/_posts/csapp/1560426317712.png">
<meta property="og:image" content="http://yoursite.com/2019/02/25/csapp/E:/hexo/Hexo_Repository/source/_posts/csapp/1560427408612.png">
<meta property="og:image" content="http://yoursite.com/2019/02/25/csapp/E:/hexo/Hexo_Repository/source/_posts/csapp/1560430208810.png">
<meta property="og:image" content="http://yoursite.com/2019/02/25/csapp/E:/hexo/Hexo_Repository/source/_posts/csapp/1560430993670.png">
<meta property="og:image" content="http://yoursite.com/2019/02/25/csapp/E:/hexo/Hexo_Repository/source/_posts/csapp/1560431180311.png">
<meta property="og:image" content="http://yoursite.com/2019/02/25/csapp/E:/hexo/Hexo_Repository/source/_posts/csapp/1560477553237.png">
<meta property="og:image" content="http://yoursite.com/2019/02/25/csapp/E:/hexo/Hexo_Repository/source/_posts/csapp/1560478712185.png">
<meta property="og:image" content="http://yoursite.com/2019/02/25/csapp/E:/hexo/Hexo_Repository/source/_posts/csapp/1560480296358.png">
<meta property="og:image" content="http://yoursite.com/2019/02/25/csapp/E:/hexo/Hexo_Repository/source/_posts/csapp/1560480304485.png">
<meta property="og:image" content="http://yoursite.com/2019/02/25/csapp/E:/hexo/Hexo_Repository/source/_posts/csapp/1560493564916.png">
<meta property="og:image" content="http://yoursite.com/2019/02/25/csapp/E:/hexo/Hexo_Repository/source/_posts/csapp/1560496558818.png">
<meta property="og:image" content="http://yoursite.com/2019/02/25/csapp/E:/hexo/Hexo_Repository/source/_posts/csapp/1560497897246.png">
<meta property="og:image" content="http://yoursite.com/2019/02/25/csapp/E:/hexo/Hexo_Repository/source/_posts/csapp/1560504247006.png">
<meta property="og:image" content="http://yoursite.com/2019/02/25/csapp/E:/hexo/Hexo_Repository/source/_posts/csapp/1560507496128.png">
<meta property="og:image" content="http://yoursite.com/2019/02/25/csapp/E:/hexo/Hexo_Repository/source/_posts/csapp/1560507505522.png">
<meta property="og:image" content="http://yoursite.com/2019/02/25/csapp/E:/hexo/Hexo_Repository/source/_posts/csapp/1560507677175.png">
<meta property="og:image" content="http://yoursite.com/2019/02/25/csapp/E:/hexo/Hexo_Repository/source/_posts/csapp/1560520777830.png">
<meta property="og:image" content="http://yoursite.com/2019/02/25/csapp/E:/hexo/Hexo_Repository/source/_posts/csapp/1560521603442.png">
<meta property="og:image" content="http://yoursite.com/2019/02/25/csapp/E:/hexo/Hexo_Repository/source/_posts/csapp/1560566014389.png">
<meta property="og:image" content="http://yoursite.com/2019/02/25/csapp/E:/hexo/Hexo_Repository/source/_posts/csapp/1560567735198.png">
<meta property="og:image" content="http://yoursite.com/2019/02/25/csapp/E:/hexo/Hexo_Repository/source/_posts/csapp/1560568165125.png">
<meta property="og:image" content="http://yoursite.com/2019/02/25/csapp/E:/hexo/Hexo_Repository/source/_posts/csapp/1560569143286.png">
<meta property="og:image" content="http://yoursite.com/2019/02/25/csapp/E:/hexo/Hexo_Repository/source/_posts/csapp/1560570644642.png">
<meta property="og:image" content="http://yoursite.com/2019/02/25/csapp/E:/hexo/Hexo_Repository/source/_posts/csapp/1560571578269.png">
<meta property="og:image" content="http://yoursite.com/2019/02/25/csapp/E:/hexo/Hexo_Repository/source/_posts/csapp/1560571842639.png">
<meta property="og:image" content="http://yoursite.com/2019/02/25/csapp/E:/hexo/Hexo_Repository/source/_posts/csapp/1560576948821.png">
<meta property="og:image" content="http://yoursite.com/2019/02/25/csapp/E:/hexo/Hexo_Repository/source/_posts/csapp/1560577693402.png">
<meta property="og:image" content="http://yoursite.com/2019/02/25/csapp/E:/hexo/Hexo_Repository/source/_posts/csapp/1560579478163.png">
<meta property="og:image" content="http://yoursite.com/2019/02/25/csapp/E:/hexo/Hexo_Repository/source/_posts/csapp/1560579494545.png">
<meta property="og:image" content="http://yoursite.com/2019/02/25/csapp/E:/hexo/Hexo_Repository/source/_posts/csapp/1560580541718.png">
<meta property="og:image" content="http://yoursite.com/2019/02/25/csapp/E:/hexo/Hexo_Repository/source/_posts/csapp/1560580518019.png">
<meta property="og:image" content="http://yoursite.com/2019/02/25/csapp/E:/hexo/Hexo_Repository/source/_posts/csapp/1560580648596.png">
<meta property="og:image" content="http://yoursite.com/2019/02/25/csapp/E:/hexo/Hexo_Repository/source/_posts/csapp/1560582003136.png">
<meta property="og:image" content="http://yoursite.com/2019/02/25/csapp/E:/hexo/Hexo_Repository/source/_posts/csapp/1560582814217.png">
<meta property="og:image" content="http://yoursite.com/2019/02/25/csapp/E:/hexo/Hexo_Repository/source/_posts/csapp/1560653477782.png">
<meta property="og:image" content="http://yoursite.com/2019/02/25/csapp/E:/hexo/Hexo_Repository/source/_posts/csapp/1560655874458.png">
<meta property="og:image" content="http://yoursite.com/2019/02/25/csapp/E:/hexo/Hexo_Repository/source/_posts/csapp/1560671412242.png">
<meta property="og:image" content="http://yoursite.com/2019/02/25/csapp/E:/hexo/Hexo_Repository/source/_posts/csapp/1560673225212.png">
<meta property="og:image" content="http://yoursite.com/2019/02/25/csapp/E:/hexo/Hexo_Repository/source/_posts/csapp/1560679326460.png">
<meta property="og:image" content="http://yoursite.com/2019/02/25/csapp/E:/hexo/Hexo_Repository/source/_posts/csapp/1560690030413.png">
<meta property="og:image" content="http://yoursite.com/2019/02/25/csapp/E:/hexo/Hexo_Repository/source/_posts/csapp/1560690050562.png">
<meta property="og:image" content="http://yoursite.com/2019/02/25/csapp/E:/hexo/Hexo_Repository/source/_posts/csapp/1560741893644.png">
<meta property="og:image" content="http://yoursite.com/2019/02/25/csapp/E:/hexo/Hexo_Repository/source/_posts/csapp/1560745947054.png">
<meta property="og:image" content="http://yoursite.com/2019/02/25/csapp/E:/hexo/Hexo_Repository/source/_posts/csapp/1560746416307.png">
<meta property="og:image" content="http://yoursite.com/2019/02/25/csapp/E:/hexo/Hexo_Repository/source/_posts/csapp/1560747692644.png">
<meta property="og:image" content="http://yoursite.com/2019/02/25/csapp/E:/hexo/Hexo_Repository/source/_posts/csapp/1560748017060.png">
<meta property="og:image" content="http://yoursite.com/2019/02/25/csapp/E:/hexo/Hexo_Repository/source/_posts/csapp/1560748175647.png">
<meta property="og:image" content="http://yoursite.com/2019/02/25/csapp/E:/hexo/Hexo_Repository/source/_posts/csapp/1560749709931.png">
<meta property="og:image" content="http://yoursite.com/2019/02/25/csapp/E:/hexo/Hexo_Repository/source/_posts/csapp/1560750391440.png">
<meta property="og:image" content="http://yoursite.com/2019/02/25/csapp/E:/hexo/Hexo_Repository/source/_posts/csapp/1560750498446.png">
<meta property="og:image" content="http://yoursite.com/2019/02/25/csapp/E:/hexo/Hexo_Repository/source/_posts/csapp/1560756705612.png">
<meta property="og:image" content="http://yoursite.com/2019/02/25/csapp/E:/hexo/Hexo_Repository/source/_posts/csapp/1560757475911.png">
<meta property="og:image" content="http://yoursite.com/2019/02/25/csapp/E:/hexo/Hexo_Repository/source/_posts/csapp/1560758603026.png">
<meta property="og:image" content="http://yoursite.com/2019/02/25/csapp/E:/hexo/Hexo_Repository/source/_posts/csapp/1560825894299.png">
<meta property="og:image" content="http://yoursite.com/2019/02/25/csapp/E:/hexo/Hexo_Repository/source/_posts/csapp/1560825914298.png">
<meta property="og:image" content="http://yoursite.com/2019/02/25/csapp/E:/hexo/Hexo_Repository/source/_posts/csapp/1560826327207.png">
<meta property="og:image" content="http://yoursite.com/2019/02/25/csapp/E:/hexo/Hexo_Repository/source/_posts/csapp/1560833381591.png">
<meta property="og:image" content="http://yoursite.com/2019/02/25/csapp/E:/hexo/Hexo_Repository/source/_posts/csapp/1563751635095.png">
<meta property="og:image" content="http://yoursite.com/2019/02/25/csapp/E:/hexo/Hexo_Repository/source/_posts/csapp/1563751961497.png">
<meta property="og:image" content="http://yoursite.com/2019/02/25/csapp/E:/hexo/Hexo_Repository/source/_posts/csapp/1563760011492.png">
<meta property="og:image" content="http://yoursite.com/2019/02/25/csapp/E:/hexo/Hexo_Repository/source/_posts/csapp/1563760934847.png">
<meta property="og:image" content="http://yoursite.com/2019/02/25/csapp/E:/hexo/Hexo_Repository/source/_posts/csapp/1563761140726.png">
<meta property="og:image" content="http://yoursite.com/2019/02/25/csapp/E:/hexo/Hexo_Repository/source/_posts/csapp/1563761497450.png">
<meta property="og:image" content="http://yoursite.com/2019/02/25/csapp/E:/hexo/Hexo_Repository/source/_posts/csapp/1563761520452.png">
<meta property="og:image" content="http://yoursite.com/2019/02/25/csapp/E:/hexo/Hexo_Repository/source/_posts/csapp/1563761794068.png">
<meta property="og:image" content="http://yoursite.com/2019/02/25/csapp/E:/hexo/Hexo_Repository/source/_posts/csapp/1563762566741.png">
<meta property="og:image" content="http://yoursite.com/2019/02/25/csapp/E:/hexo/Hexo_Repository/source/_posts/csapp/1563762894345.png">
<meta property="og:image" content="http://yoursite.com/2019/02/25/csapp/E:/hexo/Hexo_Repository/source/_posts/csapp/1563765783645.png">
<meta property="og:image" content="http://yoursite.com/2019/02/25/csapp/E:/hexo/Hexo_Repository/source/_posts/csapp/1563766005968.png">
<meta property="og:image" content="http://yoursite.com/2019/02/25/csapp/E:/hexo/Hexo_Repository/source/_posts/csapp/1563766322762.png">
<meta property="og:image" content="http://yoursite.com/2019/02/25/csapp/E:/hexo/Hexo_Repository/source/_posts/csapp/1563766731916.png">
<meta property="og:image" content="http://yoursite.com/2019/02/25/csapp/E:/hexo/Hexo_Repository/source/_posts/csapp/1563766826752.png">
<meta property="og:image" content="http://yoursite.com/2019/02/25/csapp/E:/hexo/Hexo_Repository/source/_posts/csapp/1563767460550.png">
<meta property="og:image" content="http://yoursite.com/2019/02/25/csapp/E:/hexo/Hexo_Repository/source/_posts/csapp/1563767825001.png">
<meta property="og:image" content="http://yoursite.com/2019/02/25/csapp/E:/hexo/Hexo_Repository/source/_posts/csapp/1563776600389.png">
<meta property="og:image" content="http://yoursite.com/2019/02/25/csapp/E:/hexo/Hexo_Repository/source/_posts/csapp/1563777930990.png">
<meta property="og:image" content="http://yoursite.com/2019/02/25/csapp/E:/hexo/Hexo_Repository/source/_posts/csapp/1563778655082.png">
<meta property="og:image" content="http://yoursite.com/2019/02/25/csapp/E:/hexo/Hexo_Repository/source/_posts/csapp/1563778926907.png">
<meta property="og:image" content="http://yoursite.com/2019/02/25/csapp/E:/hexo/Hexo_Repository/source/_posts/csapp/1563779517929.png">
<meta property="og:image" content="http://yoursite.com/2019/02/25/csapp/E:/hexo/Hexo_Repository/source/_posts/csapp/1563779590515.png">
<meta property="og:image" content="http://yoursite.com/2019/02/25/csapp/E:/hexo/Hexo_Repository/source/_posts/csapp/1563783631648.png">
<meta property="og:image" content="http://yoursite.com/2019/02/25/csapp/E:/hexo/Hexo_Repository/source/_posts/csapp/1563783980026.png">
<meta property="og:image" content="http://yoursite.com/2019/02/25/csapp/E:/hexo/Hexo_Repository/source/_posts/csapp/1563788820191.png">
<meta property="og:image" content="http://yoursite.com/2019/02/25/csapp/E:/hexo/Hexo_Repository/source/_posts/csapp/1563844561570.png">
<meta property="og:image" content="http://yoursite.com/2019/02/25/csapp/E:/hexo/Hexo_Repository/source/_posts/csapp/1563846132235.png">
<meta property="og:image" content="http://yoursite.com/2019/02/25/csapp/E:/hexo/Hexo_Repository/source/_posts/csapp/1563847297212.png">
<meta property="og:image" content="http://yoursite.com/2019/02/25/csapp/E:/hexo/Hexo_Repository/source/_posts/csapp/1563850674809.png">
<meta property="og:image" content="http://yoursite.com/2019/02/25/csapp/E:/hexo/Hexo_Repository/source/_posts/csapp/1563850882406.png">
<meta property="og:image" content="http://yoursite.com/2019/02/25/csapp/E:/hexo/Hexo_Repository/source/_posts/csapp/1563852372009.png">
<meta property="og:image" content="http://yoursite.com/2019/02/25/csapp/E:/hexo/Hexo_Repository/source/_posts/csapp/1563632301500.png">
<meta property="og:image" content="http://yoursite.com/2019/02/25/csapp/E:/hexo/Hexo_Repository/source/_posts/csapp/1563636975851.png">
<meta property="og:image" content="http://yoursite.com/2019/02/25/csapp/E:/hexo/Hexo_Repository/source/_posts/csapp/1563637039885.png">
<meta property="og:image" content="http://yoursite.com/2019/02/25/csapp/E:/hexo/Hexo_Repository/source/_posts/csapp/1563697958177.png">
<meta property="og:image" content="http://yoursite.com/2019/02/25/csapp/E:/hexo/Hexo_Repository/source/_posts/csapp/1563699189182.png">
<meta property="og:image" content="http://yoursite.com/2019/02/25/csapp/E:/hexo/Hexo_Repository/source/_posts/csapp/1563723325660.png">
<meta property="og:image" content="http://yoursite.com/2019/02/25/csapp/E:/hexo/Hexo_Repository/source/_posts/csapp/1563853815998.png">
<meta property="og:image" content="http://yoursite.com/2019/02/25/csapp/E:/hexo/Hexo_Repository/source/_posts/csapp/1563854246085.png">
<meta property="og:image" content="http://yoursite.com/2019/02/25/csapp/E:/hexo/Hexo_Repository/source/_posts/csapp/1563854464651.png">
<meta property="og:image" content="http://yoursite.com/2019/02/25/csapp/E:/hexo/Hexo_Repository/source/_posts/csapp/1563854729008.png">
<meta property="og:image" content="http://yoursite.com/2019/02/25/csapp/E:/hexo/Hexo_Repository/source/_posts/csapp/1563856908510.png">
<meta property="og:image" content="http://yoursite.com/2019/02/25/csapp/E:/hexo/Hexo_Repository/source/_posts/csapp/1563864397707.png">
<meta property="og:image" content="http://yoursite.com/2019/02/25/csapp/E:/hexo/Hexo_Repository/source/_posts/csapp/1563864914850.png">
<meta property="og:image" content="http://yoursite.com/2019/02/25/csapp/E:/hexo/Hexo_Repository/source/_posts/csapp/1563875014665.png">
<meta property="og:image" content="http://yoursite.com/2019/02/25/csapp/E:/hexo/Hexo_Repository/source/_posts/csapp/1563875460751.png">
<meta property="og:image" content="http://yoursite.com/2019/02/25/csapp/E:/hexo/Hexo_Repository/source/_posts/csapp/1563892016776.png">
<meta property="og:image" content="http://yoursite.com/2019/02/25/csapp/E:/hexo/Hexo_Repository/source/_posts/csapp/1563936585085.png">
<meta property="og:image" content="http://yoursite.com/2019/02/25/csapp/E:/hexo/Hexo_Repository/source/_posts/csapp/1564455376725.png">
<meta property="og:image" content="http://yoursite.com/2019/02/25/csapp/E:/hexo/Hexo_Repository/source/_posts/csapp/1564468705023.png">
<meta property="og:image" content="http://yoursite.com/2019/02/25/csapp/E:/hexo/Hexo_Repository/source/_posts/csapp/1564470802877.png">
<meta property="og:image" content="https://wdxtub.com/images/14613541138958.jpg">
<meta property="og:image" content="http://yoursite.com/2019/02/25/csapp/Physical%20Addressing.png">
<meta property="og:image" content="http://yoursite.com/2019/02/25/csapp/Virtual%20Addressing.png">
<meta property="og:image" content="http://yoursite.com/2019/02/25/csapp/Allocate%20and%20free.png">
<meta property="og:updated_time" content="2019-08-13T12:27:31.991Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="csapp">
<meta name="twitter:description" content="Short intro to C:Warm up1234#include &amp;lt; studio.h&amp;gt;                // C way of importinglong unsigned sizeof(a)             //returns the num of byteint main(int argc, char** argv)     // argc for">
<meta name="twitter:image" content="http://yoursite.com/2019/02/25/csapp/E:/hexo/Hexo_Repository/source/_posts/csapp/1558495002048.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2019/02/25/csapp/"/>





  <title>csapp | My personal website</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">My personal website</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/02/25/csapp/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Tjianke">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="My personal website">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">csapp</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-02-25T23:05:17+08:00">
                2019-02-25
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h3 id="Short-intro-to-C"><a href="#Short-intro-to-C" class="headerlink" title="Short intro to C:"></a>Short intro to C:</h3><h4 id="Warm-up"><a href="#Warm-up" class="headerlink" title="Warm up"></a>Warm up</h4><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt; studio.h&gt;                // C way of importing</span></span></span><br><span class="line"><span class="function"><span class="keyword">long</span> <span class="keyword">unsigned</span> <span class="title">sizeof</span><span class="params">(a)</span>             <span class="comment">//returns the num of byte</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>** argv)</span>     <span class="comment">// argc for num of param, argv is the array(0:function name)</span></span></span><br><span class="line">int* ptr_a, ptr_b;                  // bzzt! Fails, leads to one being ptr, other being Integer</span><br></pre></td></tr></table></figure>
<p>The smallest unit in computer world is bit, two status (0 or 1)</p>
<p>8 bits = 1 byte </p>
<p>Hexadecimals begin with 0x</p>
<p>delimiter : <code>\n \t</code></p>
<p><code>size_t</code> : type returned by <code>sizeof()</code>, represent non-negative size</p>
<p><code>static variable</code> : stored not in stack, global variable</p>
<p><code>static function</code> : private function</p>
<p><strong>Directives :</strong><br>|Symbol |Meaning      |   |<br>|——-|————-|—|<br>|d      |digital      |   |<br>|lu     |long unsiged |   |<br>|p      |pointer      |   |<br>|%c| char |single character.|<br>|%d| (%i) |int signed integer.|<br>|%e |(%E) |float or double exponential format.|<br>|%f |float| or double signed decimal.|<br>|%g |(%G) |float or double use %f or %e as required.|<br>|%o |int |unsigned octal value.|<br>|%p| pointer |address stored in pointer.|</p>
<p>8 C numeric type (in Bytes)</p>
<table>
<thead>
<tr>
<th>C declaration</th>
<th>32-bit</th>
<th>64-bit</th>
<th>range</th>
</tr>
</thead>
<tbody>
<tr>
<td>char</td>
<td>1</td>
<td>1</td>
<td>2^8</td>
</tr>
<tr>
<td>short int</td>
<td>2</td>
<td>2</td>
<td>2^16</td>
</tr>
<tr>
<td>int</td>
<td>4</td>
<td>4</td>
<td>2^32</td>
</tr>
<tr>
<td>long int</td>
<td>4</td>
<td>8</td>
<td>2^64</td>
</tr>
<tr>
<td>long long int</td>
<td>8</td>
<td>8</td>
<td>2^64</td>
</tr>
<tr>
<td>char*(regardless of type)</td>
<td>4</td>
<td>8</td>
<td>2^64</td>
</tr>
<tr>
<td>float</td>
<td>4</td>
<td>8</td>
<td>2^64</td>
</tr>
<tr>
<td>double</td>
<td>8</td>
<td>8</td>
<td>2^64</td>
</tr>
</tbody>
</table>
<p><strong>BYTE ORDERING</strong> : Big endian vs Small endian argues the order in which a byte is arranged</p>
<p>Typedef helps to define certain type for brevity</p>
<h4 id="Noisy-pointer"><a href="#Noisy-pointer" class="headerlink" title="Noisy pointer"></a>Noisy pointer</h4><p><a href="https://boredzo.org/pointers/" target="_blank" rel="noopener">An article i highly recommend to read about pointer</a></p>
<p>Pointer points to the address of certain variable.</p>
<p><strong>Addition in pointer</strong> : </p>
<p><strong>Dereference </strong> : pointer with * on, assigns value (<strong>A common ptr mistake </strong>: dereference uninitialized pointer)</p>
<p><strong>Pointing </strong> : pointer without *, points and only accepts an adress</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> *int_ptr = <span class="literal">NULL</span>; <span class="comment">// ptr current addres is 0X0;</span></span><br><span class="line"><span class="keyword">int</span> *array_ptr = <span class="built_in">array</span>;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">" first element: %i\n"</span>, *(array_ptr++));</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"second element: %i\n"</span>, *(array_ptr++)); <span class="comment">// same as %d</span></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">" third element: %i\n"</span>, *array_ptr);</span><br></pre></td></tr></table></figure>
<p>Hex to bin : XXXX - HH</p>
<h4 id="String-representation"><a href="#String-representation" class="headerlink" title="String representation"></a>String representation</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//String in C is represented as </span></span><br><span class="line"><span class="keyword">char</span>* char_ptr = <span class="string">"abcde"</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// another formal way is, NULL character is automatically added</span></span><br><span class="line"><span class="keyword">char</span> char_array[] = <span class="string">"Look Here"</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// equivalent to (Same as JAVA )</span></span><br><span class="line"><span class="keyword">char</span> char_array[] = &#123; <span class="string">'L'</span>, <span class="string">'o'</span>, <span class="string">'o'</span>, <span class="string">'k'</span>, <span class="string">' '</span>, <span class="string">'H'</span>, <span class="string">'e'</span>, <span class="string">'r'</span>, <span class="string">'e'</span>, <span class="string">'\0'</span> &#125;;</span><br><span class="line"><span class="comment">// char CHAR[] equivalent to char* CHAR;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// a more efficient way </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ARRAY_SIZE 15</span></span><br><span class="line"><span class="keyword">char</span> char_array[ARRAY_SIZE] = <span class="string">"Look Here"</span>;</span><br></pre></td></tr></table></figure>
<p>Each string in C is ended with 00s, and the most famous ones are ASCII character code.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">show_bytes(<span class="string">"12345"</span>, <span class="number">6</span>);         <span class="comment">//output: 31 32 33 34 35 00(terminal)</span></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">char</span> *s = <span class="string">"abcdef"</span>;</span><br><span class="line">show_bytes((byte_pointer) s, <span class="built_in">strlen</span>(s));  <span class="comment">// output :61 62 63 64 65 66</span></span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">man ASCII // for ascii character code</span><br></pre></td></tr></table></figure>
<caption text-align="center"> Operations of Boolean algebra</caption>

<table>
<thead>
<tr>
<th>~</th>
<th>^</th>
<th>&amp;</th>
<th>slash</th>
</tr>
</thead>
<tbody>
<tr>
<td>NOT</td>
<td>XOR</td>
<td>AND</td>
<td>OR</td>
</tr>
</tbody>
</table>
<p><a href="https://darkdust.net/files/GDB%20Cheat%20Sheet.pdf" target="_blank" rel="noopener">GDB cheat sheet</a></p>
<p>Fancy stuff here: swap two values without useing the third extra variable</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// properties used: a^a = 0 &amp;&amp; XOR is commutative </span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">exchange</span><span class="params">(<span class="keyword">int</span> a, <span class="keyword">int</span> b)</span></span>&#123; <span class="comment">// a = 12 10010 b = 32 = 110010</span></span><br><span class="line">    a = a ^ b;                 <span class="comment">// a^b = 10000</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"The output is %d \n"</span>,a);</span><br><span class="line">    b = a ^ b;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"The output is %d \n"</span>,b);</span><br><span class="line">    a = a ^ b;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"The output is %d \n"</span>,a);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Follow up:<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">reverse_array</span><span class="params">(<span class="keyword">int</span> a[], <span class="keyword">int</span> cnt)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> first, last;</span><br><span class="line">    <span class="keyword">for</span> (first = <span class="number">0</span>, last = cnt<span class="number">-1</span>;</span><br><span class="line">    first &lt;= last;</span><br><span class="line">    first++,last--)</span><br><span class="line">    inplace_swap(&amp;a[first], &amp;a[last]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><strong> Masking operation </strong>: </p>
<h4 id="Shift-operation-in-C"><a href="#Shift-operation-in-C" class="headerlink" title="Shift operation in C:"></a>Shift operation in C:</h4><p>Logic : unsigned<br>Algorithmetic : signed one</p>
<p>Casting is actually based on bit level operation</p>
<p>explicit casting is possible as well:<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span> <span class="keyword">int</span> tx, ty;</span><br><span class="line"><span class="number">2</span> <span class="keyword">unsigned</span> ux, uy;</span><br><span class="line"><span class="number">3</span></span><br><span class="line"><span class="number">4</span> tx = ux; <span class="comment">/* Cast to signed */</span></span><br><span class="line"><span class="number">5</span> uy = ty; <span class="comment">/* Cast to unsigned */</span></span><br></pre></td></tr></table></figure></p>
<p>Operand tend perform implicit casting to unsigned.</p>
<p>Extension</p>
<p>Truncating</p>
<p>Division in bit-level : first increment then right shift</p>
<p>A quick way to negate a number : 1.complement 2.increment</p>
<p><strong><em>Common mistake with unsigned</em></strong>: sizeof() actually returns unsigned words</p>
<p>C retro time :</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span></span></span><br><span class="line"><span class="keyword">typedef</span></span><br></pre></td></tr></table></figure>
<p>word size: 32 bit / 64 bit</p>
<p>Floating point:</p>
<p>Discard the fractional binary representation.</p>
<p>IEEE 744 standard :</p>
<p>$V = (-1)^s \; M \; 2^E​$</p>
<p>$bias = 2^{k-1} - 1$ (where k is number of bits in exponent field)</p>
<ol>
<li><p>Denoramlized : exponent field being all zero, denotes number [-1, 1]</p>
<p>$E = 1 - bias$  for smooth switch between denorm and norm </p>
<p>$M = f​$</p>
</li>
</ol>
<ol>
<li><p>Normalized : exponent field != 0 || != 2^k</p>
<p>$E = exp - bias​$</p>
<p>$M = 1 + f$</p>
</li>
</ol>
<p><img src="/2019/02/25/csapp/E:/hexo\Hexo_Repository\source\_posts\csapp\1558495002048.png" alt="1558495002048"></p>
<p><img src="/2019/02/25/csapp/E:/hexo\Hexo_Repository\source\_posts\csapp\1558495120915.png" alt="Floating Category"></p>
<p>IEEE 4 modes for rounding, Default rounding : find the closest one</p>
<p><img src="/2019/02/25/csapp/E:/hexo\Hexo_Repository\source\_posts\csapp\1558495772633.png" alt="1558495772633"></p>
<p>$$(-1)^{s_1}\; M_1 \; 2^{E_1} + (-1)^{s_2}\; M_2 \; 2^{E_2}$$ 这里假设 $E_1 &gt; E_2$，结果是 $(-1)^{s}\; M \; 2^{E}$ ，其中 $s = s_1 \land s_2, M = M_1 + M_2, E = E_1​$</p>
<p><a href="https://www.youtube.com/watch?v=mKJiD2ZAlwM" target="_blank" rel="noopener">Video Explanation</a>.</p>
<h1 id="1-A-tour-to-computer-System"><a href="#1-A-tour-to-computer-System" class="headerlink" title="1. A tour to computer System"></a>1. A tour to computer System</h1><h2 id="1-1-Information-is-Bits-Context"><a href="#1-1-Information-is-Bits-Context" class="headerlink" title="1.1 Information is Bits + Context"></a>1.1 Information is Bits + Context</h2><ol>
<li><strong><em>Source.c</em></strong> file is stored in bits representing characters according to ASCII, each ending line is marked by ‘\n’(10)</li>
<li>Everything in computer world is represented in bits, only difference is the context in which they are viewed.</li>
</ol>
<h2 id="1-2-Programs-are-translated-by-other-Programs-into-Different-forms"><a href="#1-2-Programs-are-translated-by-other-Programs-into-Different-forms" class="headerlink" title="1.2 Programs are translated by other Programs into Different forms"></a>1.2 Programs are translated by other Programs into Different forms</h2><ol>
<li><p><strong><em>Source</em></strong> file must be transformed by other programs to be <strong><em>executable</em></strong> (Source.o)  in binary format.</p>
<ol>
<li><figure class="highlight plain"><figcaption><span>-o executable.o hello.c``` to generate executable file</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">2. Generating an executable file takes 4 steps : ***Preprocessor***, ***Compiler***, ***Assembler*** and ***Linker***, known collectively as ***compilation system***</span><br><span class="line">   1. ![1560259176678](E:\hexo\Hexo_Repository\source\_posts\csapp\1560259176678.png)</span><br><span class="line">   2. Preprocessing :  introduce header files according to &apos;#&apos; directive, e.g. ```#include &lt;stdio.h&gt;``` </span><br><span class="line">   3. Assembling : each is a low-level machine language instruction(***Notice*** : Same content regardless of languages and compiler)</span><br><span class="line">   4. Linking : link pre-compiled  executable and merge</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">## 1.3 It pays to understand How compilation system works</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">## 1.4 Processors Read and Interpret Instructions Stored in Memory</span><br><span class="line"></span><br><span class="line">1. Running an *executable file* : ``` unix&gt;  ./hello</span><br></pre></td></tr></table></figure>
</li>
</ol>
</li>
<li><p>Hardware organization of a system(Intel Pentium):</p>
<ol>
<li><img src="/2019/02/25/csapp/E:/hexo\Hexo_Repository\source\_posts\csapp\1560335013589.png" alt="1560335013589"></li>
<li><strong>Buses</strong> : channels that carry info between components. <ol>
<li>Used to transfer fixed size of data(word, either 32-bit or 64-bit)</li>
</ol>
</li>
<li><strong>I/O devices</strong> : connection to outside world, e.g. <ol>
<li>Each I/O device is connected by I/O bus by <em>adapter</em> or <em>controller</em>.</li>
<li>Controller is printed in <strong><em>motherboard</em></strong> (system’s main printed circuit board)</li>
<li>Adapter a card that plugs into motherboard</li>
</ol>
</li>
<li><strong>Main memory</strong> : temporary storage for data and procedures, consisted of DRAM, organized as array of linear bytes</li>
<li><strong>Processor</strong> : engine that interprets instructions in <strong><em>Main memory</em></strong>, <ol>
<li><strong><em>Program counter</em></strong> : points to address in <strong><em>Main memory</em></strong></li>
<li><strong><em>Register file</em></strong> : store word-sized register</li>
<li><strong><em>ALU</em></strong> : computes new data and address values, main functions include:<ol>
<li>Load, Copy a word from <strong><em>Main memory</em></strong> and replace the old register</li>
<li>Store, Copy a word from <strong><em>Register file</em></strong> to <strong><em>Main memory</em></strong> and overwrite</li>
<li>Operate, Copy the contents of two registers to <strong><em>ALU</em></strong> and perform an arithmetic operation and store the result in a register</li>
<li>Jump, Extract a word from the instruction and update PC to that address</li>
</ol>
</li>
</ol>
</li>
</ol>
</li>
<li>Running the <em>hello</em> program:<ol>
<li>Read from keyboard IO and store in register and then from register to main memory</li>
<li>After pressing <em>Enter</em>, Fetch <em>hello.o</em> from <strong><em>disk</em></strong> to <strong><em>Main memory</em></strong></li>
<li></li>
<li><img src="/2019/02/25/csapp/E:/hexo\Hexo_Repository\source\_posts\csapp\1560343352359.png" alt="1560343352359"></li>
<li><img src="/2019/02/25/csapp/E:/hexo\Hexo_Repository\source\_posts\csapp\1560344330982.png" alt="1560344330982"></li>
<li><img src="/2019/02/25/csapp/E:/hexo\Hexo_Repository\source\_posts\csapp\1560344434529.png" alt="1560344434529"></li>
</ol>
</li>
</ol>
<h2 id="1-5-Caches-Matter"><a href="#1-5-Caches-Matter" class="headerlink" title="1.5 Caches Matter"></a>1.5 Caches Matter</h2><ol>
<li>Different storage device has highly varied accessing speed, register, main memory, disk. Cache design is invented for efficiency</li>
<li><img src="/2019/02/25/csapp/E:/hexo\Hexo_Repository\source\_posts\csapp\1560345549422.png" alt="L1 Cache in CPU"></li>
<li>L1 and L2 cache works within CPU, using tech known as SRAM</li>
<li>Exploit <strong><em>locality</em></strong>, system tend to use data in localized regions</li>
</ol>
<h2 id="1-6-Storage-devices-form-a-Hierarchy"><a href="#1-6-Storage-devices-form-a-Hierarchy" class="headerlink" title="1.6 Storage devices form a Hierarchy"></a>1.6 Storage devices form a Hierarchy</h2><ol>
<li><img src="/2019/02/25/csapp/E:/hexo\Hexo_Repository\source\_posts\csapp\1560345938057.png" alt="1560345938057"></li>
</ol>
<h2 id="1-7-The-Operating-System-Manages-the-Hardware"><a href="#1-7-The-Operating-System-Manages-the-Hardware" class="headerlink" title="1.7 The Operating System Manages the Hardware"></a>1.7 The Operating System Manages the Hardware</h2><ol>
<li><p>Operating System : a layer of software interposed between the <strong><em>application program</em></strong> and <strong><em>hardware</em></strong></p>
</li>
<li><p>Main purpose of OS : </p>
<ol>
<li>Protect illegal usage of hardware by runaway applications</li>
<li>Provide simple and uniform mechanism to manipulate hardware</li>
<li><img src="/2019/02/25/csapp/E:/hexo\Hexo_Repository\source\_posts\csapp\1560346646317.png" alt="1560346646317"></li>
</ol>
</li>
<li><p><img src="/2019/02/25/csapp/E:/hexo\Hexo_Repository\source\_posts\csapp\1560348122146.png" alt="1560348122146"></p>
<ol>
<li><p><strong><em>Processes</em></strong> : when <em>hello.c</em> runs, OS provides a illusion that <em>hello.c</em> is the only program running, having the exclusive usage of processors, main memory. Such illusion</p>
<ol>
<li>OS keeps track of all the info need to run a program, a.k.a context.</li>
<li>At any point of time, uniprocessor system can only execute code for a single process</li>
<li><strong>Context Switch</strong> is performed when system save context of current process and switch to a new one, where <strong><em>it picks off where it left</em></strong></li>
<li><img src="/2019/02/25/csapp/E:/hexo\Hexo_Repository\source\_posts\csapp\1560350182293.png" alt="1560350182293"></li>
</ol>
</li>
<li><p><strong><em>Threads</em></strong> :   A process can consist of multiple execution units, called threads, running under same context of process</p>
</li>
<li><p><strong><em>Virtual Memory</em></strong> : provides illusion that each process has unique access to memory.</p>
<ol>
<li><p>Each process has the same uniform view of <strong><em>virtual address space</em></strong> </p>
</li>
<li><p><img src="/2019/02/25/csapp/E:/hexo\Hexo_Repository\source\_posts\csapp\1560350965464.png" alt="1560350965464"></p>
<p>From bottom to top:</p>
<ol>
<li>Program code and data </li>
<li>Run-time Heap, expands or shrinks due to calls like <figure class="highlight plain"><figcaption><span>and ```malloc`` </span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br></pre></td><td class="code"><pre><span class="line">         3. Shared Libraries</span><br><span class="line">         4. Stack, to implement function call</span><br><span class="line">         5. Kernel Virtual Memory</span><br><span class="line"></span><br><span class="line">      </span><br><span class="line"></span><br><span class="line">   4. ***Files*** : A sequence of bytes, nothing more or nothing less</span><br><span class="line"></span><br><span class="line">      1. Every IO device is modeled as a file</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">## 1.8 System Communicate with Other Systems Using Networks</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">1. Network works just as other IO device</span><br><span class="line">2. Five steps need for remote CS model</span><br><span class="line">   1. ![1560352870605](E:\hexo\Hexo_Repository\source\_posts\csapp\1560352870605.png)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">## 1.10 Important Themes</span><br><span class="line"></span><br><span class="line">1. ***Concurrency and Parallelism*** :</span><br><span class="line">   1. Concurrency : multiple, simultaneous activities</span><br><span class="line">   2. Parallelism : use of Concurrency to make system faster </span><br><span class="line">2. </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">## X.1 Aside about C</span><br><span class="line"></span><br><span class="line">1. C is the System language of Unix </span><br><span class="line">2. C is a small and simple language</span><br><span class="line">3. </span><br><span class="line"></span><br><span class="line">Aside about C :</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 2. Representing and Manipulating Information</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 2.1 Information Storage</span><br><span class="line"></span><br><span class="line">1. ```gcc -std =c99 or -ansi prog.c``` runs in ***c99*** standard</span><br><span class="line">2. Computers access info in *bytes* rather than in bit, machine-level program views memory as a very large array of bytes, referred to as ***virtual memory***, every byte of memory is identified by a unique number known as ***virtual address***  </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">### 2.1.1 Hexadecimal Notation</span><br><span class="line"></span><br><span class="line">1. 1 Byte = 8 bits = 1 hex digits, trick to remember 0-F : </span><br><span class="line">   1. A for 10,  C for 12, F for 15</span><br><span class="line"></span><br><span class="line">### 2.1.2 Words</span><br><span class="line"></span><br><span class="line">1. Given a machine with word size $$w$$ ,virtual address can range from $$[0, 2^w -1] $$   </span><br><span class="line">   1. 32 bit word size allows for only $$4gb$$ virtual memory at most</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">### 2.1.3 Data Sizes</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">1. </span><br><span class="line"></span><br><span class="line">1. | C declaration             | 32-bit | 64-bit | range |</span><br><span class="line">   | ------------------------- | ------ | ------ | ----- |</span><br><span class="line">   | char                      | 1      | 1      | 2^8   |</span><br><span class="line">   | short int                 | 2      | 2      | 2^16  |</span><br><span class="line">   | int                       | 4      | 4      | 2^32  |</span><br><span class="line">   | long int                  | 4      | 8      | 2^64  |</span><br><span class="line">   | long long int             | 8      | 8      | 2^64  |</span><br><span class="line">   | char*(regardless of type) | 4      | 8      | 2^64  |</span><br><span class="line">   | float                     | 4      | 8      | 2^64  |</span><br><span class="line">   | double                    | 8      | 8      | 2^64  |</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">### 2.1.4 Byte ordering and Addressing</span><br><span class="line"></span><br><span class="line">1. ![Storage of 0x01234567 ](E:\hexo\Hexo_Repository\source\_posts\csapp\1560395259597.png)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">### 2.1.5 Representing Strings</span><br><span class="line"></span><br><span class="line">1. String in C is represented by character encodings and ended by a null character &apos;\00&apos; (0x00 in ASCII)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">### 2.1.6 Representing Code</span><br><span class="line"></span><br><span class="line">1. To machines, code are just bytes, interpreted as machine - level instructions</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">### 2.1.7 Boolean Algebra</span><br><span class="line"></span><br><span class="line">1. ![1560395990158](E:\hexo\Hexo_Repository\source\_posts\csapp\1560395990158.png)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">### 2.1.8 Bit-level Operations in C</span><br><span class="line"></span><br><span class="line">1. same as 2.1.7, </span><br><span class="line"></span><br><span class="line">2. A useful trick : </span><br><span class="line"></span><br><span class="line">   1. a^a = 0, could be used to swap two elements</span><br><span class="line"></span><br><span class="line">   2. ```c</span><br><span class="line">      1 void inplace_swap(int *x, int *y) &#123;</span><br><span class="line">      2 *y = *x ^ *y; /* Step 1 */</span><br><span class="line">      3 *x = *x ^ *y; /* Step 2 */</span><br><span class="line">      4 *y = *x ^ *y; /* Step 3 */</span><br><span class="line">      5 &#125;</span><br></pre></td></tr></table></figure></li>
</ol>
</li>
</ol>
</li>
</ol>
</li>
</ol>
<h3 id="2-1-9-Logical-operations-in-C"><a href="#2-1-9-Logical-operations-in-C" class="headerlink" title="2.1.9 Logical operations in C"></a>2.1.9 Logical operations in C</h3><h3 id="2-1-10-Shift-operations-in-C"><a href="#2-1-10-Shift-operations-in-C" class="headerlink" title="2.1.10 Shift operations in C"></a>2.1.10 Shift operations in C</h3><ol>
<li>Logical shift, left shift is filled with 0, fit for unsigned</li>
<li>Algo shift, left shift filled with 1, fit for signed</li>
</ol>
<h2 id="2-2-Integer-Representation"><a href="#2-2-Integer-Representation" class="headerlink" title="2.2 Integer Representation"></a>2.2 Integer Representation</h2><h3 id="2-2-2-Unsigned-Encodings"><a href="#2-2-2-Unsigned-Encodings" class="headerlink" title="2.2.2 Unsigned Encodings"></a>2.2.2 Unsigned Encodings</h3><ol>
<li>Formula : $$B2U(x) = \sum_{i=0}^{w-1}x_i2^i$$ <ol>
<li><img src="/2019/02/25/csapp/E:/hexo\Hexo_Repository\source\_posts\csapp\1560399933478.png" alt="1560399933478"></li>
</ol>
</li>
</ol>
<h3 id="2-2-3-Signed-Encodings"><a href="#2-2-3-Signed-Encodings" class="headerlink" title="2.2.3 Signed Encodings"></a>2.2.3 Signed Encodings</h3><ol>
<li>Formula : $$B2T(x) = -x_{w-1}2^{w-1} + \sum_{i=0}^{w-2}x_i 2^i$$<ol>
<li><img src="/2019/02/25/csapp/E:/hexo\Hexo_Repository\source\_posts\csapp\1560400108755.png" alt="1560400108755"></li>
</ol>
</li>
</ol>
<h3 id="2-2-4-Conversions-Between-signed-and-unsigned"><a href="#2-2-4-Conversions-Between-signed-and-unsigned" class="headerlink" title="2.2.4 Conversions Between signed and unsigned"></a>2.2.4 Conversions Between signed and unsigned</h3><ol>
<li><img src="/2019/02/25/csapp/E:/hexo\Hexo_Repository\source\_posts\csapp\1560400290401.png" alt="1560400290401"></li>
</ol>
<h3 id="2-2-5-Unsigned-and-signed-in-C"><a href="#2-2-5-Unsigned-and-signed-in-C" class="headerlink" title="2.2.5 Unsigned and signed in C"></a>2.2.5 Unsigned and signed in C</h3><ol>
<li>Signed is automatically transferred to unsigned, when met with unsigned</li>
</ol>
<h3 id="2-2-6-Expanding-the-Bit-Representation-of-a-Number"><a href="#2-2-6-Expanding-the-Bit-Representation-of-a-Number" class="headerlink" title="2.2.6 Expanding the Bit Representation of a Number"></a>2.2.6 Expanding the Bit Representation of a Number</h3><ol>
<li><strong><em>Zero extension</em></strong> : By adding zeros, make unsigned to larger number</li>
<li><strong><em>Signed extension</em></strong> : similar for signed number</li>
</ol>
<h3 id="2-2-7-Truncating-Number"><a href="#2-2-7-Truncating-Number" class="headerlink" title="2.2.7  Truncating Number"></a>2.2.7  Truncating Number</h3><ol>
<li><p>Unsigned, same effect as mod 2^k</p>
</li>
<li><p>Signed, same effect as mod 2^k and then interpret as Signed number</p>
</li>
</ol>
<h3 id="2-2-8-Advice-on-Signed-vs-Unsigned"><a href="#2-2-8-Advice-on-Signed-vs-Unsigned" class="headerlink" title="2.2.8 Advice on Signed vs Unsigned"></a>2.2.8 Advice on Signed vs Unsigned</h3><ol>
<li><figure class="highlight plain"><figcaption><span>``` is actually ```typedef size_t unsigned int```</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">## 2.3 Integer Arithmetic</span><br><span class="line"></span><br><span class="line">### 2.3.1 Unsigned Addition</span><br><span class="line"></span><br><span class="line">1. ![1560406263476](E:\hexo\Hexo_Repository\source\_posts\csapp\1560406263476.png)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">### 2.3.2 Signed Addition</span><br><span class="line"></span><br><span class="line">1. At machine level, the addition is the same with Unsigned number</span><br><span class="line">2. ![1560406887524](E:\hexo\Hexo_Repository\source\_posts\csapp\1560406887524.png)</span><br><span class="line">   1. Positive overflow</span><br><span class="line">   2. Normal case</span><br><span class="line">   3. Negative overflow</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">### 2.3.3 Two&apos;s complement Negation</span><br><span class="line"></span><br><span class="line">1. ![1560407028061](E:\hexo\Hexo_Repository\source\_posts\csapp\1560407028061.png)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">### 2.3.4 Unsigned Multiplication</span><br><span class="line"></span><br><span class="line">1. ![1560407107297](E:\hexo\Hexo_Repository\source\_posts\csapp\1560407107297.png)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">### 2.3.5 Two&apos;s complement Multiplication</span><br><span class="line"></span><br><span class="line">1. ![1560407143034](E:\hexo\Hexo_Repository\source\_posts\csapp\1560407143034.png)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">### 2.3.6 Multiply by Constants</span><br><span class="line"></span><br><span class="line">1. Compiler will try to replace integer multiplication with 2 shift, addition and subtraction</span><br><span class="line">2. Expression ```x*K``` can be transferred to ```x* [000...111...1.0]``` ,since ```K``` can always be represented by ```10``` </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">### 2.3.7 Dividing by powers of two</span><br><span class="line"></span><br><span class="line">1. Division result is always rounded to 0</span><br><span class="line">2. Use `logical shift` and `arithmetic shift` for unsigned and signed integer</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">## 2.4 Floating Point</span><br><span class="line"></span><br><span class="line">`Definition of Floating Point` : $V = x*2 ^ y$  </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">### 2.4.1 Fractional Binary Number</span><br><span class="line"></span><br><span class="line">1. Binary notation : $ b = \sum_&#123;i = -n&#125;^&#123;m&#125; 2^i * b_i $</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">### 2.4.2 IEEE Floating Point Number</span><br><span class="line"></span><br><span class="line">1. IEEEE floating point standard represents a number in a form $V = (-1)^s * M * 2^E$</span><br><span class="line">   1. *Sign s* for positivity</span><br><span class="line">   2. The *Significand M* is a fractional number either $\in [0, 1- \epsilon]$ or $\in [1, 2-\epsilon]$ </span><br><span class="line">   3. The *exponent E* weighs value by $2^E$ </span><br><span class="line">2. Bit representation of a IEEE floating point is :</span><br><span class="line">   1. ![1560409803693](E:\hexo\Hexo_Repository\source\_posts\csapp\1560409803693.png)</span><br><span class="line">3. Values can be categorized to :</span><br><span class="line">   1. ***Normalized value*** : When *exp* field neither all 0 nor all 1, *exp field* is representing a biased integer $E = exp - bias$</span><br><span class="line">      1. *exp* is the integer represented by exponent field</span><br><span class="line">      2. $bias = 2^&#123;k-1&#125; - 1$ </span><br><span class="line">      3. *fraction field* : $M = 1 + f​$</span><br><span class="line">   2. ***De-normalized value*** : When exp field is all 0</span><br><span class="line">      1. $E = 1 - bias$ </span><br><span class="line">      2. $bias = 2^&#123;k-1&#125; - 1$ </span><br><span class="line">      3. *fraction field* : $M = f$</span><br><span class="line">   3. ***Special case***:</span><br><span class="line">      1. ![1560410944941](E:\hexo\Hexo_Repository\source\_posts\csapp\1560410944941.png)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">### 2.4.3 Example Number</span><br><span class="line"></span><br><span class="line">1. ![1558495002048](E:\hexo\Hexo_Repository\source\_posts\csapp\1558495002048.png)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">1. Common data type presentation</span><br><span class="line">2. Boolean Algebra: And Or XOR Not</span><br><span class="line">3. Contrast Logical ops (with Termination) (p&amp;&amp;*p avoids null pointer access)</span><br><span class="line">4. shift ops,(logical &amp; algo)(Undefined for illegal shift)</span><br><span class="line">5. #include&lt;limits.h&gt; : ULONG_MAX,LONG_MAX</span><br><span class="line">6. Default:signed, Append U for Unsigned</span><br><span class="line">7. If there be mix of U and S, S is casted implicitly to U</span><br><span class="line">8. Little endian : refers to byte ordering </span><br><span class="line"></span><br><span class="line"># Floating points</span><br><span class="line">## 1.Fractional Binary numbers:</span><br><span class="line">limit: Only lists number that are very large or extremely samll</span><br><span class="line">## 2. IEEE Floating Point</span><br><span class="line">1.Chem way of rounding, when exact half round LSB to even, no bias theoretically</span><br><span class="line">2.Bias = 2^(k - 1) - 1 , k is the exp bit</span><br><span class="line">3.Single precison, sign : 1, E : 8, frac : 23</span><br><span class="line">4.Noramalized Number</span><br><span class="line">5.Denormalized </span><br><span class="line">6.Special cases:  exp = 111...1, frac = 000..0 represents infinity(overflow</span><br><span class="line">NaN exp = 111...11, frac != 000.000</span><br><span class="line">7.FP multiplication, (-1)^(s1)* M1* 2^(E1)</span><br><span class="line"></span><br><span class="line">    shift M to right, if more than 2, till overflow</span><br><span class="line"></span><br><span class="line">8.Casting</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    Float/double -&gt; int: truncate frac</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">## 3. Machine-level representation of program</span><br><span class="line"></span><br><span class="line">Learns basically two related machine language : `Intel IA32` and `x86-64`</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">## 3.1 Historical Perspective</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">## 3.2 Program Encodings</span><br><span class="line"></span><br><span class="line">1. ```GCC``` command invokes a sequence of programs to turn source code to executables. ```preprocessor``` expands *src* code to include any files specified with ```#include``` or other macros.```compiler``` generates assembly code p1.s, p2.s. ```assembler``` turns assembly code to ```object code``` files p1.o, p2.o. ```linker``` merges two object file and generate final file.(More details in CSAPP chap 7)</span><br><span class="line">   1. -S, generate assembly code</span><br><span class="line">   2. -O1, optimization level 1</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">### 3.2.1 Machine-level code</span><br><span class="line"></span><br><span class="line">1. Computer system employs different forms of ***abstraction***, hiding details of an implementation through the use of simpler, abstract models.</span><br><span class="line"></span><br><span class="line">   1. Format and behavior of Machine code is defined by *instruction set architecture*, ISA</span><br><span class="line">   2. Memory address used by machine code are *virtual*</span><br><span class="line"></span><br><span class="line">2. ***IA32***  differs with C in exposing stuff hidden in C:</span><br><span class="line"></span><br><span class="line">   1. ***Program Counter***, represented as ***%eip***  in ***IA32***</span><br><span class="line">   2. ***Register file***</span><br><span class="line">   3. ***Condition code register***</span><br><span class="line">   4. ***Floating point register***</span><br><span class="line"></span><br><span class="line">3. Program memory, reminder</span><br><span class="line"></span><br><span class="line">   </span><br><span class="line"></span><br><span class="line">   </span><br><span class="line"></span><br><span class="line">### 3.2.2 Code Examples</span><br><span class="line"></span><br><span class="line">1. ```C</span><br><span class="line">   1 int accum = 0;</span><br><span class="line">   2</span><br><span class="line">   3 int sum(int x, int y)</span><br><span class="line">   4 &#123;</span><br><span class="line">   5 int t = x + y;</span><br><span class="line">   6 accum += t;</span><br><span class="line">   7 return t;</span><br><span class="line">   8 &#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>unix&gt; gcc -O1 -s hello.c</code></p>
<ol>
<li><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">sum:</span><br><span class="line">pushl %ebp // push value stored in register %ebp back to stack(To save it)</span><br><span class="line">movl %esp, %ebp // assign val</span><br><span class="line">movl 12(%ebp), %eax // </span><br><span class="line">addl 8(%ebp), %eax</span><br><span class="line">addl %eax, accum</span><br><span class="line">popl %ebp</span><br><span class="line">ret</span><br></pre></td></tr></table></figure>
</li>
<li><p>Transfer object file to assembly code, use <strong><em>disassembler</em></strong> <code>objdump -d output.o</code></p>
</li>
</ol>
</li>
</ol>
<h3 id="3-2-3-Notes-on-formatting"><a href="#3-2-3-Notes-on-formatting" class="headerlink" title="3.2.3 Notes on formatting"></a>3.2.3 Notes on formatting</h3><ol>
<li>Real assembly code includes trivial directives to link etc</li>
</ol>
<h2 id="3-3-Data-Formats"><a href="#3-3-Data-Formats" class="headerlink" title="3.3 Data Formats"></a>3.3 Data Formats</h2><ol>
<li><p>Word comes from 16-bit processor, double word for byte, </p>
</li>
<li></li>
<li><p>| C declaration | Intel data type  | Assembly code suffix | Size(in bytes) |<br>| ————- | :————— | :——————- | :————- |<br>| char          | Byte             | b                    | 1              |<br>| short         | Word             | w                    | 2              |<br>| int           | Double Word      | l                    | 4              |<br>| long int      | Double Word      | l                    | 4              |<br>| char*         | Double word      | l                    | 4              |<br>| float         | Single Precision | s                    | 4              |<br>| double        | Double Precision | l                    | 8              |</p>
</li>
</ol>
<h2 id="3-4-Accessing-information"><a href="#3-4-Accessing-information" class="headerlink" title="3.4 Accessing information"></a>3.4 Accessing information</h2><p><img src="/2019/02/25/csapp/E:/hexo\Hexo_Repository\source\_posts\csapp\1560423316129.png" alt="1560423316129"></p>
<ol>
<li>The low order two bytes of first four registers can be dealt independently, allowing backward compatibility.</li>
</ol>
<h3 id="3-4-1-Operand-Specifiers"><a href="#3-4-1-Operand-Specifiers" class="headerlink" title="3.4.1 Operand Specifiers"></a>3.4.1 Operand Specifiers</h3><ol>
<li><p>Operand : object of an math operation</p>
</li>
<li><p>Types of operand :</p>
<ol>
<li><p>Constants : $</p>
</li>
<li><p>Register : </p>
</li>
<li><p>Memory reference : content referred by address</p>
</li>
<li><p><img src="/2019/02/25/csapp/E:/hexo\Hexo_Repository\source\_posts\csapp\1560424704158.png" alt="1560424704158"></p>
</li>
<li></li>
</ol>
</li>
</ol>
<h3 id="3-4-2-Data-Movement-Instructions"><a href="#3-4-2-Data-Movement-Instructions" class="headerlink" title="3.4.2 Data Movement Instructions"></a>3.4.2 Data Movement Instructions</h3><ol>
<li><img src="/2019/02/25/csapp/E:/hexo\Hexo_Repository\source\_posts\csapp\1560425740286.png" alt="1560425740286"></li>
<li>IA32 prohibits direct move between memory</li>
<li><code>push</code> and <code>pop</code><ol>
<li><img src="/2019/02/25/csapp/E:/hexo\Hexo_Repository\source\_posts\csapp\1560426317712.png" alt="1560426317712"></li>
<li><code>push</code> decrease %esp, store src at new top</li>
<li><code>pop</code> store top of stack then increase %esp </li>
</ol>
</li>
</ol>
<h3 id="3-4-3-Data-Movement-Example"><a href="#3-4-3-Data-Movement-Example" class="headerlink" title="3.4.3 Data Movement Example"></a>3.4.3 Data Movement Example</h3><h2 id="3-5-Arithmetic-and-Logical-Operations"><a href="#3-5-Arithmetic-and-Logical-Operations" class="headerlink" title="3.5 Arithmetic and Logical Operations"></a>3.5 Arithmetic and Logical Operations</h2><h3 id="3-5-1-Load-Effective-Address"><a href="#3-5-1-Load-Effective-Address" class="headerlink" title="3.5.1 Load Effective Address"></a>3.5.1 Load Effective Address</h3><ol>
<li><img src="/2019/02/25/csapp/E:/hexo\Hexo_Repository\source\_posts\csapp\1560427408612.png" alt="1560427408612"></li>
</ol>
<h3 id="3-5-2-amp-3-5-3-Unary-Binary-and-Shift-Operation"><a href="#3-5-2-amp-3-5-3-Unary-Binary-and-Shift-Operation" class="headerlink" title="3.5.2 &amp; 3.5.3 Unary, Binary and Shift Operation"></a>3.5.2 &amp; 3.5.3 Unary, Binary and Shift Operation</h3><h2 id="3-6-Controls"><a href="#3-6-Controls" class="headerlink" title="3.6 Controls"></a>3.6 Controls</h2><h3 id="3-6-1-Conditional-code"><a href="#3-6-1-Conditional-code" class="headerlink" title="3.6.1 Conditional code"></a>3.6.1 Conditional code</h3><ol>
<li><strong><em>Conditional codes</em></strong> : describes attributes of most recent arithmetic or logical operation. These codes could be used to perform conditional branches<ol>
<li>Carry Flag : carry out for MSB, fit for Unsigned operations</li>
<li>Zero Flag : yielded zero</li>
<li>Sign Flag : yielded negative value</li>
<li>Overflow Flag : two’s complement overflow, fit for Signed</li>
</ol>
</li>
<li><img src="/2019/02/25/csapp/E:/hexo\Hexo_Repository\source\_posts\csapp\1560430208810.png" alt="1560430208810"></li>
</ol>
<h3 id="3-6-2-Accessing-Conditional-Code"><a href="#3-6-2-Accessing-Conditional-Code" class="headerlink" title="3.6.2 Accessing Conditional Code"></a>3.6.2 Accessing Conditional Code</h3><p><img src="/2019/02/25/csapp/E:/hexo\Hexo_Repository\source\_posts\csapp\1560430993670.png" alt="1560430993670"></p>
<h3 id="3-6-3-Jump-Instructions-and-Their-Encodings"><a href="#3-6-3-Jump-Instructions-and-Their-Encodings" class="headerlink" title="3.6.3 Jump Instructions and Their Encodings"></a>3.6.3 Jump Instructions and Their Encodings</h3><ol>
<li><p><strong><em>Jump</em></strong> instructions can cause execution to switch to a new position, indicated by a <em>label</em></p>
<ol>
<li><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">1 movl $0,%eax Set %eax to 0</span><br><span class="line">2 jmp .L1 Goto .L1</span><br><span class="line">3 movl (%eax),%edx Null pointer dereference</span><br><span class="line">4 .L1:</span><br><span class="line">5 popl %edx</span><br></pre></td></tr></table></figure>
</li>
<li><p><img src="/2019/02/25/csapp/E:/hexo\Hexo_Repository\source\_posts\csapp\1560431180311.png" alt="1560431180311"></p>
</li>
<li><p>Direct jump, indirect jump</p>
</li>
</ol>
</li>
<li><p>Two ways to encode jump instruction:</p>
<ol>
<li><em>PC-relative</em> : store offset between current instruction and target instruction</li>
<li><em>Direct</em> : store the target address</li>
</ol>
</li>
</ol>
<h3 id="3-6-4-Translating-conditional-branches"><a href="#3-6-4-Translating-conditional-branches" class="headerlink" title="3.6.4 Translating conditional branches"></a>3.6.4 Translating conditional branches</h3><h3 id="3-6-5-Loops"><a href="#3-6-5-Loops" class="headerlink" title="3.6.5 Loops"></a>3.6.5 Loops</h3><ol>
<li><p>Do- while loops : </p>
<ol>
<li><p>C code: </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span> <span class="function"><span class="keyword">int</span> <span class="title">fact_do</span><span class="params">(<span class="keyword">int</span> n)</span></span></span><br><span class="line"><span class="function">2 </span>&#123;</span><br><span class="line"><span class="number">3</span> <span class="keyword">int</span> result = <span class="number">1</span>;</span><br><span class="line"><span class="number">4</span> <span class="keyword">do</span> &#123;</span><br><span class="line"><span class="number">5</span> result *= n;</span><br><span class="line"><span class="number">6</span> n = n<span class="number">-1</span>;</span><br><span class="line"><span class="number">7</span> &#125; <span class="keyword">while</span> (n &gt; <span class="number">1</span>);</span><br><span class="line"><span class="number">8</span> <span class="keyword">return</span> result;</span><br><span class="line"><span class="number">9</span> &#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>Assembly code: </p>
<ol>
<li><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Argument: n at %ebp+8</span><br><span class="line">Registers: n in %edx, result in %eax</span><br><span class="line">1 movl 8(%ebp), %edx Get n</span><br><span class="line">2 movl $1, %eax Set result = 1</span><br><span class="line">3 .L2: loop:</span><br><span class="line">4 imull %edx, %eax Compute result *= n</span><br><span class="line">5 subl $1, %edx Decrement n</span><br><span class="line">6 cmpl $1, %edx Compare n:1</span><br><span class="line">7 jg .L2 If &gt;, goto loop</span><br><span class="line">Return result</span><br></pre></td></tr></table></figure>
</li>
</ol>
</li>
</ol>
</li>
<li><p>While loop</p>
</li>
<li><p>For loop</p>
</li>
</ol>
<h3 id="3-6-6-Conditional-Move-Instructions"><a href="#3-6-6-Conditional-Move-Instructions" class="headerlink" title="3.6.6 Conditional Move Instructions"></a>3.6.6 Conditional Move Instructions</h3><h3 id="3-6-7-Switch"><a href="#3-6-7-Switch" class="headerlink" title="3.6.7 Switch"></a>3.6.7 Switch</h3><h2 id="3-7-Procedures"><a href="#3-7-Procedures" class="headerlink" title="3.7 Procedures"></a>3.7 Procedures</h2><ol>
<li>A procedure involves passing data(parameters and returned value) and control. And allocate memory for local variable when entry and deallocate when exit;</li>
</ol>
<h3 id="3-7-1-Stack-Frame-Structure"><a href="#3-7-1-Stack-Frame-Structure" class="headerlink" title="3.7.1 Stack Frame Structure"></a>3.7.1 Stack Frame Structure</h3><ol>
<li>IA32 uses program stack to support program calls<ol>
<li>The portion of stack allocated for a single procedure is called a <strong><em>stack frame</em></strong></li>
<li><img src="/2019/02/25/csapp/E:/hexo\Hexo_Repository\source\_posts\csapp\1560477553237.png" alt="1560477553237"></li>
<li>Topmost stack frame is delimited by two pointers, stack pointer and frame pointer<ol>
<li>Frame pointer is fixed</li>
<li>Stack pointer can be increased or decreased</li>
</ol>
</li>
<li>Parameters are stored at least 8 byte ahead of <code>%ebp</code>, since <code>4(%ebp)</code> is <strong><em>return address</em></strong>, <code>ith</code> parameter is stored at <code>(%ebp,4,i)</code> </li>
</ol>
</li>
</ol>
<h3 id="3-7-2-Transferring-Control"><a href="#3-7-2-Transferring-Control" class="headerlink" title="3.7.2 Transferring Control"></a>3.7.2 Transferring Control</h3><ol>
<li><p>Instructions that support transferring control : </p>
<ol>
<li><p><img src="/2019/02/25/csapp/E:/hexo\Hexo_Repository\source\_posts\csapp\1560478712185.png" alt="1560478712185"></p>
</li>
<li><p><code>call</code> : push a return address to stack top and jump to start of called procedure</p>
</li>
<li><p><code>ret</code> : pops an address from stack and jump</p>
<ol>
<li>Proper usage : push stack pointer back to stored return address </li>
</ol>
</li>
<li><p><code>leave</code> : prepares to leave current program</p>
<ol>
<li><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">1 movl %ebp, %esp Set stack pointer to beginning of frame</span><br><span class="line">2 popl %ebp Restore saved %ebp and set stack ptr to end of caller’s frame</span><br></pre></td></tr></table></figure>
</li>
<li></li>
</ol>
</li>
<li><p>An example :</p>
<ol>
<li><img src="/2019/02/25/csapp/E:/hexo\Hexo_Repository\source\_posts\csapp\1560480296358.png" alt="1560480296358"></li>
<li><img src="/2019/02/25/csapp/E:/hexo\Hexo_Repository\source\_posts\csapp\1560480304485.png" alt="1560480304485"></li>
</ol>
</li>
</ol>
</li>
</ol>
<h3 id="3-7-3-Register-Usage-Convention"><a href="#3-7-3-Register-Usage-Convention" class="headerlink" title="3.7.3 Register Usage Convention"></a>3.7.3 Register Usage Convention</h3><ol>
<li>Purpose make sure called procedures do not overwrite caller’s register</li>
<li><code>Caller-save</code> registers : <code>%eax, %edx, %ecx</code><ol>
<li>Caller must save any of these registers, before overwriting</li>
</ol>
</li>
<li><code>Callee-save</code> registers : <code>%ebx, %esi, %edi</code><ol>
<li>Callee must save any of these registers, before overwriting them</li>
</ol>
</li>
</ol>
<h3 id="3-7-4-Procedure-Example"><a href="#3-7-4-Procedure-Example" class="headerlink" title="3.7.4 Procedure Example"></a>3.7.4 Procedure Example</h3><ol>
<li><p>Code:</p>
<ol>
<li><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span> <span class="function"><span class="keyword">int</span> <span class="title">swap_add</span><span class="params">(<span class="keyword">int</span> *xp, <span class="keyword">int</span> *yp)</span></span></span><br><span class="line"><span class="function">2 </span>&#123;</span><br><span class="line"><span class="number">3</span> <span class="keyword">int</span> x = *xp;</span><br><span class="line"><span class="number">4</span> <span class="keyword">int</span> y = *yp;</span><br><span class="line"><span class="number">5</span></span><br><span class="line"><span class="number">6</span> *xp = y;</span><br><span class="line"><span class="number">7</span> *yp = x;</span><br><span class="line"><span class="number">8</span> <span class="keyword">return</span> x + y;</span><br><span class="line"><span class="number">9</span> &#125;</span><br><span class="line"><span class="number">10</span></span><br><span class="line"><span class="number">11</span> <span class="function"><span class="keyword">int</span> <span class="title">caller</span><span class="params">()</span></span></span><br><span class="line"><span class="function">12 </span>&#123;</span><br><span class="line"><span class="number">13</span> <span class="keyword">int</span> arg1 = <span class="number">534</span>;</span><br><span class="line"><span class="number">14</span> <span class="keyword">int</span> arg2 = <span class="number">1057</span>;</span><br><span class="line"><span class="number">15</span> <span class="keyword">int</span> sum = swap_add(&amp;arg1, &amp;arg2);</span><br><span class="line"><span class="number">16</span> <span class="keyword">int</span> diff = arg1 - arg2;</span><br><span class="line"><span class="number">17</span></span><br><span class="line"><span class="number">18</span> <span class="keyword">return</span> sum * diff;</span><br><span class="line"><span class="number">19</span> &#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
</li>
<li><p>Graph : </p>
<ol>
<li><img src="/2019/02/25/csapp/E:/hexo\Hexo_Repository\source\_posts\csapp\1560493564916.png" alt="1560493564916"></li>
</ol>
</li>
<li><p>Notice : C has both pass by reference(<strong><em>by pointers</em></strong>) and pass by value(<strong><em>default</em></strong>)  </p>
</li>
<li><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">1 caller:</span><br><span class="line">2 pushl %ebp      //Save old %ebp</span><br><span class="line">3 movl %esp, %ebp //Set %ebp as frame pointer</span><br><span class="line">4 subl $24, %esp  //Allocate 24 bytes on stack</span><br><span class="line">5 movl $534, -4(%ebp) Set arg1 to 534</span><br><span class="line">6 movl $1057, -8(%ebp) Set arg2 to 1057</span><br><span class="line">7 leal -8(%ebp), %eax Compute &amp;arg2</span><br><span class="line">8 movl %eax, 4(%esp) Store on stack</span><br><span class="line">9 leal -4(%ebp), %eax Compute &amp;arg1</span><br><span class="line">10 movl %eax, (%esp) Store on stack</span><br><span class="line">11 call swap_add //push %eip to stack </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">swap_add:</span><br><span class="line">	pushl %ebp // store old frame pointer</span><br><span class="line">	movl  %esp, %ebp // set new frame pointer</span><br><span class="line">	pushl %ebx // storing callee-save register(ebx esi edi)</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">5 movl 8(%ebp), %edx Get xp</span><br><span class="line">6 movl 12(%ebp), %ecx Get yp</span><br><span class="line">7 movl (%edx), %ebx Get x</span><br><span class="line">8 movl (%ecx), %eax Get y</span><br><span class="line">9 movl %eax, (%edx) Store y at xp</span><br><span class="line">10 movl %ebx, (%ecx) Store x at yp</span><br><span class="line">11 addl %ebx, %eax Return value = x+y</span><br><span class="line"></span><br><span class="line">12 popl %ebx Restore %ebx</span><br><span class="line">13 popl %ebp Restore %ebp</span><br><span class="line">14 ret Return</span><br><span class="line"></span><br><span class="line">back to main body of caller</span><br><span class="line"></span><br><span class="line">12 movl -4(%ebp), %edx</span><br><span class="line">13 subl -8(%ebp), %edx</span><br><span class="line">14 imull %edx, %eax</span><br><span class="line">15 leave // reset esp to ebp and popl %ebp</span><br><span class="line">16 ret</span><br></pre></td></tr></table></figure>
</li>
<li></li>
</ol>
<p>Notice : Why allocate unused space ?</p>
<p>Answer : Adhere to principle : Stack size be a multiple of 16 bytes</p>
<h3 id="3-7-5-Recursive-Procedures"><a href="#3-7-5-Recursive-Procedures" class="headerlink" title="3.7.5 Recursive Procedures"></a>3.7.5 Recursive Procedures</h3><ol>
<li><p>code :</p>
<ol>
<li><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span> <span class="function"><span class="keyword">int</span> <span class="title">rfact</span><span class="params">(<span class="keyword">int</span> n)</span></span></span><br><span class="line"><span class="function">2 </span>&#123;</span><br><span class="line"><span class="number">3</span> <span class="keyword">int</span> result;</span><br><span class="line"><span class="number">4</span> <span class="keyword">if</span> (n &lt;= <span class="number">1</span>)</span><br><span class="line"><span class="number">5</span> result = <span class="number">1</span>;</span><br><span class="line"><span class="number">6</span> <span class="keyword">else</span></span><br><span class="line"><span class="number">7</span> result=n* rfact(n<span class="number">-1</span>);</span><br><span class="line"><span class="number">8</span> <span class="keyword">return</span> result;</span><br><span class="line"><span class="number">9</span> &#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
</li>
<li><p>Assembly :</p>
<ol>
<li><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">1 rfact:</span><br><span class="line">2 pushl %ebp Save old %ebp</span><br><span class="line">3 movl %esp, %ebp Set %ebp as frame pointer</span><br><span class="line">4 pushl %ebx Save callee save register %ebx</span><br><span class="line">5 subl $4, %esp Allocate 4 bytes on stack</span><br><span class="line">6 movl 8(%ebp), %ebx Get n</span><br><span class="line">7 movl $1, %eax result = 1</span><br><span class="line">8 cmpl $1, %ebx Compare n:1</span><br><span class="line">9 jle .L53 If &lt;=, goto done</span><br><span class="line">10 leal -1(%ebx), %eax Compute n-1</span><br><span class="line">11 movl %eax, (%esp) Store at top of stack</span><br><span class="line">12 call rfact Call rfact(n-1)</span><br><span class="line">13 imull %ebx, %eax Compute result = return value * n</span><br><span class="line">14 .L53: done:</span><br><span class="line">15 addl $4, %esp Deallocate 4 bytes from stack</span><br><span class="line">16 popl %ebx Restore %ebx</span><br><span class="line">17 popl %ebp Restore %ebp</span><br><span class="line">18 ret Return result</span><br></pre></td></tr></table></figure>
</li>
</ol>
</li>
<li><p><img src="/2019/02/25/csapp/E:/hexo\Hexo_Repository\source\_posts\csapp\1560496558818.png" alt="1560496558818"></p>
</li>
</ol>
<h2 id="3-8-Array-Allocation-and-Access"><a href="#3-8-Array-Allocation-and-Access" class="headerlink" title="3.8 Array Allocation and Access"></a>3.8 Array Allocation and Access</h2><h3 id="3-8-1-Basic-Principles"><a href="#3-8-1-Basic-Principles" class="headerlink" title="3.8.1 Basic Principles"></a>3.8.1 Basic Principles</h3><ol>
<li>Define <code>T A[N]</code> has two effects:<ol>
<li>$x_a$  as start of A, a pointer as well</li>
<li>allocates $L*N$ bytes of memory, where L is size of T in bytes</li>
<li>Address of Array element i can be denoted as : $L*i + x_a$ </li>
<li><code>movl (x_a, i, size_t), %eax</code>, IA32 way for quick access</li>
</ol>
</li>
</ol>
<h3 id="3-8-2-Pointer-Arithmetic"><a href="#3-8-2-Pointer-Arithmetic" class="headerlink" title="3.8.2 Pointer Arithmetic"></a>3.8.2 Pointer Arithmetic</h3><ol>
<li><img src="/2019/02/25/csapp/E:/hexo\Hexo_Repository\source\_posts\csapp\1560497897246.png" alt="1560497897246"></li>
</ol>
<h3 id="3-8-3-Nested-Array"><a href="#3-8-3-Nested-Array" class="headerlink" title="3.8.3 Nested Array"></a>3.8.3 Nested Array</h3><ol>
<li><code>&amp;A[i][j] = x_A + size_t*(i*N + j)</code> </li>
</ol>
<h3 id="3-8-4-Fixed-size-array"><a href="#3-8-4-Fixed-size-array" class="headerlink" title="3.8.4 Fixed size array"></a>3.8.4 Fixed size array</h3><h3 id="3-8-5-Variable-size-array"><a href="#3-8-5-Variable-size-array" class="headerlink" title="3.8.5 Variable size array"></a>3.8.5 Variable size array</h3><h2 id="3-9-Heterogeneous-Data-Structures"><a href="#3-9-Heterogeneous-Data-Structures" class="headerlink" title="3.9 Heterogeneous Data Structures"></a>3.9 Heterogeneous Data Structures</h2><h3 id="3-9-1-Structures"><a href="#3-9-1-Structures" class="headerlink" title="3.9.1 Structures"></a>3.9.1 Structures</h3><ol>
<li><p>C review :</p>
<ol>
<li><p>Declaration :</p>
<ol>
<li><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">rect</span> &#123;</span></span><br><span class="line">    <span class="keyword">int</span> llx; <span class="comment">/* X coordinate of lower-left corner */</span></span><br><span class="line">    <span class="keyword">int</span> lly; <span class="comment">/* Y coordinate of lower-left corner */</span></span><br><span class="line">    <span class="keyword">int</span> color; <span class="comment">/* Coding of color */</span></span><br><span class="line">    <span class="keyword">int</span> width; <span class="comment">/* Width (in pixels) */</span></span><br><span class="line">    <span class="keyword">int</span> height; <span class="comment">/* Height (in pixels) */</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// assignment</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">rect</span> <span class="title">R</span>;</span></span><br><span class="line">R.llx = R.lly = <span class="number">0</span>;</span><br><span class="line">R.color = <span class="number">0xFFFFFF</span>;</span><br><span class="line">R.width = <span class="number">10</span>;</span><br><span class="line">R.height = <span class="number">10</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// alternative way to assign</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">rect</span> <span class="title">R</span> = &#123;</span><span class="number">0</span>, <span class="number">0</span>, <span class="number">0xFF00FF</span>, <span class="number">10</span>, <span class="number">10</span>&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//another reference</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">rect</span> * <span class="title">R</span>;</span></span><br><span class="line">R-&gt;llx</span><br></pre></td></tr></table></figure>
</li>
</ol>
</li>
<li><p>Structure memory allocation :</p>
<ol>
<li><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">rec</span> &#123;</span></span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    <span class="keyword">int</span> j;</span><br><span class="line">    <span class="keyword">int</span> a[<span class="number">3</span>];</span><br><span class="line">    <span class="keyword">int</span> *p;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
</li>
<li><p><img src="/2019/02/25/csapp/E:/hexo\Hexo_Repository\source\_posts\csapp\1560504247006.png" alt="1560504247006"></p>
</li>
</ol>
</li>
</ol>
</li>
</ol>
<h3 id="3-9-2-Unions"><a href="#3-9-2-Unions" class="headerlink" title="3.9.2 Unions"></a>3.9.2 Unions</h3><ol>
<li><p>Unions allow an object interpreted in different ways</p>
</li>
<li><p>Useful for :</p>
<ol>
<li>contain mutually-exclusive object</li>
<li>choose different bit pattern</li>
</ol>
</li>
<li><p>Use <code>enum</code> to denote situation:</p>
<ol>
<li><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">enum</span> &#123; N_LEAF, N_INTERNAL &#125; <span class="keyword">nodetype_t</span>;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">NODE_T</span> &#123;</span></span><br><span class="line">    <span class="keyword">nodetype_t</span> type;</span><br><span class="line">    <span class="keyword">union</span> &#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">            <span class="class"><span class="keyword">struct</span> <span class="title">NODE_T</span> *<span class="title">left</span>;</span></span><br><span class="line">            <span class="class"><span class="keyword">struct</span> <span class="title">NODE_T</span> *<span class="title">right</span>;</span></span><br><span class="line">        &#125; internal;</span><br><span class="line">        <span class="keyword">double</span> data;</span><br><span class="line">    &#125; info;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
</li>
</ol>
</li>
<li><p>Choose different bit pattern :</p>
<ol>
<li><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span> <span class="function"><span class="keyword">unsigned</span> <span class="title">float2bit</span><span class="params">(<span class="keyword">float</span> f)</span></span></span><br><span class="line"><span class="function">2 </span>&#123;</span><br><span class="line"><span class="number">3</span> 	<span class="keyword">union</span> &#123;</span><br><span class="line"><span class="number">4</span> 		<span class="keyword">float</span> f;</span><br><span class="line"><span class="number">5</span> 		<span class="keyword">unsigned</span> u;</span><br><span class="line"><span class="number">6</span> 	&#125; temp;</span><br><span class="line"><span class="number">7</span> 	temp.f = f;</span><br><span class="line"><span class="number">8</span> 	<span class="keyword">return</span> temp.u;</span><br><span class="line"><span class="number">9</span> &#125;;</span><br></pre></td></tr></table></figure>
</li>
</ol>
</li>
</ol>
<ol start="5">
<li><p>Indicates that machine code actually do not care type</p>
</li>
<li><p>Byte ordering matters as well for unions</p>
</li>
</ol>
<h3 id="3-9-3-Data-Alignments"><a href="#3-9-3-Data-Alignments" class="headerlink" title="3.9.3 Data Alignments"></a>3.9.3 Data Alignments</h3><ol>
<li>4-byte alignment</li>
<li><img src="/2019/02/25/csapp/E:/hexo\Hexo_Repository\source\_posts\csapp\1560507496128.png" alt="1560507496128"></li>
<li><img src="/2019/02/25/csapp/E:/hexo\Hexo_Repository\source\_posts\csapp\1560507505522.png" alt="1560507505522"></li>
</ol>
<h2 id="3-10-Understanding-Pointers"><a href="#3-10-Understanding-Pointers" class="headerlink" title="3.10 Understanding Pointers"></a>3.10 Understanding Pointers</h2><ol>
<li>Every pointer has an associative type, only provided by C to avoid addressing errors</li>
<li>Every pointer has a value<ol>
<li>Pointer Null refers <code>0x00</code></li>
</ol>
</li>
<li>Casting only changes type but not value</li>
</ol>
<h2 id="3-11-Gdb-debugger"><a href="#3-11-Gdb-debugger" class="headerlink" title="3.11 Gdb debugger"></a>3.11 Gdb debugger</h2><ol>
<li><img src="/2019/02/25/csapp/E:/hexo\Hexo_Repository\source\_posts\csapp\1560507677175.png" alt="1560507677175"></li>
</ol>
<h2 id="3-12-Out-of-bounds-memory-reference-and-buffer-overflow"><a href="#3-12-Out-of-bounds-memory-reference-and-buffer-overflow" class="headerlink" title="3.12 Out-of-bounds memory reference and buffer overflow"></a>3.12 Out-of-bounds memory reference and buffer overflow</h2><ol>
<li><img src="/2019/02/25/csapp/E:/hexo\Hexo_Repository\source\_posts\csapp\1560520777830.png" alt="1560520777830"></li>
<li><code>strcat</code>, <code>strcpy</code>,<code>sprintf</code> and <code>gets</code> are vulnerable to buffer overflow</li>
</ol>
<h3 id="3-12-1-Thwarting-Buffer-Overflow-Attacks"><a href="#3-12-1-Thwarting-Buffer-Overflow-Attacks" class="headerlink" title="3.12.1 Thwarting Buffer Overflow Attacks"></a>3.12.1 Thwarting Buffer Overflow Attacks</h3><ol>
<li>Stack randomization, used by Linux, stack address differs each execution</li>
<li>Stack Corruption Detection : <ol>
<li></li>
<li><img src="/2019/02/25/csapp/E:/hexo\Hexo_Repository\source\_posts\csapp\1560521603442.png" alt="1560521603442"></li>
<li>Limiting executable region</li>
</ol>
</li>
</ol>
<h2 id="3-13-Extending-to-64-bit"><a href="#3-13-Extending-to-64-bit" class="headerlink" title="3.13 Extending to 64 bit"></a>3.13 Extending to 64 bit</h2><h1 id="4-Processor-Architecture"><a href="#4-Processor-Architecture" class="headerlink" title="4. Processor Architecture"></a>4. Processor Architecture</h1><h1 id="5-Optimizing-Code-Performance"><a href="#5-Optimizing-Code-Performance" class="headerlink" title="5. Optimizing Code Performance"></a>5. Optimizing Code Performance</h1><h1 id="6-Memory-Hierarchy"><a href="#6-Memory-Hierarchy" class="headerlink" title="6. Memory Hierarchy"></a>6. Memory Hierarchy</h1><h2 id="6-1-Storage-Technology"><a href="#6-1-Storage-Technology" class="headerlink" title="6.1 Storage Technology"></a>6.1 Storage Technology</h2><h3 id="6-1-1-Random-Access-Memory"><a href="#6-1-1-Random-Access-Memory" class="headerlink" title="6.1.1 Random Access Memory"></a>6.1.1 Random Access Memory</h3><ol>
<li>Random-access memory can be categorized to :<ol>
<li><strong><em>Static Random Access Memory</em></strong> : faster and smaller, used on and off CPU chip</li>
<li><strong><em>Dynamic Random Access Memory</em></strong> : used in Main Memory</li>
</ol>
</li>
<li>SRAM : bistable, stays indefinitely stable at one of two situations<ol>
<li><img src="/2019/02/25/csapp/E:/hexo\Hexo_Repository\source\_posts\csapp\1560566014389.png" alt="1560566014389"></li>
</ol>
</li>
<li>DRAM : Sensitive to disturbance<ol>
<li>The bits(cells) in DRAM(<code>d*w</code>) are partitioned into <code>d</code> supercells, each consisting of <code>w</code> DRAM cells.</li>
<li>The supercells are organized in rectangular as <code>rc = d</code>, each supercell has the address of <code>(i,j)</code>, denoting <code>ith</code> row <code>jth</code> column</li>
<li>Info flows in and out through <strong><em>pins</em></strong>, <ol>
<li>Each pin carries 1 bit</li>
<li>Two sets of pis :<ol>
<li>8 data pins</li>
<li>2 address pins</li>
</ol>
</li>
<li><img src="/2019/02/25/csapp/E:/hexo\Hexo_Repository\source\_posts\csapp\1560567735198.png" alt="1560567735198"></li>
</ol>
</li>
<li>Each DRAM is connected to <strong><em>Memory Controller</em></strong>, that can transfer <code>w</code> bits at a time.<ol>
<li><img src="/2019/02/25/csapp/E:/hexo\Hexo_Repository\source\_posts\csapp\1560568165125.png" alt="1560568165125"></li>
</ol>
</li>
<li>Memory Module : DRAM chips are packaged in modules that plug into expansion slots on the motherboard. <ol>
<li></li>
<li></li>
<li><img src="/2019/02/25/csapp/E:/hexo\Hexo_Repository\source\_posts\csapp\1560569143286.png" alt="1560569143286"></li>
<li>Enhanced DRAM:<ol>
<li>fast-page mode DRAM : allows consecutive access to same buffer row </li>
<li>Synchronous DRAM : faster</li>
</ol>
</li>
<li>Nonvolatile Memory : ROM(read-only memory), won’t change even power off<ol>
<li>programmable ROM : one-time, memory cell can be blown through high current</li>
<li>erasable programmable ROM : </li>
</ol>
</li>
<li>Accessing Main Memory :<ol>
<li><strong><em>Buses</em></strong> are used to transfer data in between processor and DRAM<ol>
<li>Bus transaction : read and write</li>
<li><img src="/2019/02/25/csapp/E:/hexo\Hexo_Repository\source\_posts\csapp\1560570644642.png" alt="1560570644642"></li>
</ol>
</li>
</ol>
</li>
</ol>
</li>
</ol>
</li>
</ol>
<h3 id="6-1-2-Disk-Storage"><a href="#6-1-2-Disk-Storage" class="headerlink" title="6.1.2 Disk Storage"></a>6.1.2 Disk Storage</h3><ol>
<li>Disk Geometry :<ol>
<li>Disk are constructed from Platter, each platter has two surfaces</li>
<li>A rotating spindle rotates platter at a fixed rate(Revolution per Minute), </li>
<li><img src="/2019/02/25/csapp/E:/hexo\Hexo_Repository\source\_posts\csapp\1560571578269.png" alt="1560571578269"><ol>
<li>Each sector contains typically 512 bytes</li>
<li>SSD does not have moving parts</li>
</ol>
</li>
</ol>
</li>
<li>Disk Capacity :<ol>
<li><img src="/2019/02/25/csapp/E:/hexo\Hexo_Repository\source\_posts\csapp\1560571842639.png" alt="1560571842639"></li>
</ol>
</li>
<li>Disk Operation : <ol>
<li>Seek </li>
<li>Rotational latency</li>
<li>Transfer time</li>
</ol>
</li>
<li>Logical Disk Block : modern disks have complex geometries, to hide this complexity from operation system, disk presents a simpler view of their geometry as <strong><em>logical blocks</em></strong><ol>
<li>A small device called <strong><em>disk controller</em></strong>, maintains the mapping between blocks and disk sector</li>
<li>OS performs IO transaction(logical block) -&gt; controller translates block to (surface, track, sector)</li>
</ol>
</li>
<li>Connecting IO bus : more general but slower</li>
<li>Accessing Disks </li>
</ol>
<h3 id="6-1-3-Solid-State-Disks"><a href="#6-1-3-Solid-State-Disks" class="headerlink" title="6.1.3 Solid State Disks"></a>6.1.3 Solid State Disks</h3><h3 id="6-1-4-Storage-Tech-Trends"><a href="#6-1-4-Storage-Tech-Trends" class="headerlink" title="6.1.4 Storage Tech Trends"></a>6.1.4 Storage Tech Trends</h3><h2 id="6-2-Locality"><a href="#6-2-Locality" class="headerlink" title="6.2 Locality"></a>6.2 Locality</h2><ol>
<li>Principle of locality :<ol>
<li>temporal locality : same place referenced multiple time</li>
<li>spatial locality : place around is referenced freq </li>
</ol>
</li>
</ol>
<h2 id="6-3-Memory-Hierarchy"><a href="#6-3-Memory-Hierarchy" class="headerlink" title="6.3 Memory Hierarchy"></a>6.3 Memory Hierarchy</h2><ol>
<li><img src="/2019/02/25/csapp/E:/hexo\Hexo_Repository\source\_posts\csapp\1560576948821.png" alt="1560576948821"></li>
</ol>
<h3 id="6-3-1-Caching-in-the-Memory-Hierarchy"><a href="#6-3-1-Caching-in-the-Memory-Hierarchy" class="headerlink" title="6.3.1 Caching in the Memory Hierarchy"></a>6.3.1 Caching in the Memory Hierarchy</h3><ol>
<li>Cache hit</li>
<li>Cache miss:<ol>
<li>Conflict miss, two fetch end up with same address</li>
<li>Cold miss, empty cache </li>
<li>Capacity miss, size of cache smaller size of working set</li>
</ol>
</li>
</ol>
<h3 id="6-3-2-Summary-of-Memory-Hierarchy"><a href="#6-3-2-Summary-of-Memory-Hierarchy" class="headerlink" title="6.3.2 Summary of Memory Hierarchy"></a>6.3.2 Summary of Memory Hierarchy</h3><ol>
<li><img src="/2019/02/25/csapp/E:/hexo\Hexo_Repository\source\_posts\csapp\1560577693402.png" alt="1560577693402"></li>
<li></li>
</ol>
<h2 id="6-4-Cache-Memories"><a href="#6-4-Cache-Memories" class="headerlink" title="6.4 Cache Memories"></a>6.4 Cache Memories</h2><h3 id="6-4-1-Generic-Cache-Memory-Organization"><a href="#6-4-1-Generic-Cache-Memory-Organization" class="headerlink" title="6.4.1 Generic Cache Memory Organization"></a>6.4.1 Generic Cache Memory Organization</h3><ol>
<li>Each memory address is M bits wide, total of $2^M$ unique address</li>
<li>Cache is an array of $S = 2^s$ sets, <ol>
<li>each sets contain $E $ cache lines, <ol>
<li>each line consists of $B = 2 ^ b$ bytes, a valid bit, and $t = M - (b+s)$ as tag bit</li>
<li>tag and set bits are used to locate in cache, then get according to offset</li>
<li><img src="/2019/02/25/csapp/E:/hexo\Hexo_Repository\source\_posts\csapp\1560579478163.png" alt="1560579478163"></li>
</ol>
</li>
<li>Capacity $C = S <em> E </em> B​$ , not including tag and valid bits</li>
<li><img src="/2019/02/25/csapp/E:/hexo\Hexo_Repository\source\_posts\csapp\1560579494545.png" alt="1560579494545"></li>
</ol>
</li>
</ol>
<h3 id="6-4-2-Direct-Mapped-Caches"><a href="#6-4-2-Direct-Mapped-Caches" class="headerlink" title="6.4.2 Direct Mapped Caches"></a>6.4.2 Direct Mapped Caches</h3><ol>
<li><p>According to number of lines in set, Cache can be categorized into :</p>
<ol>
<li>E = 1, Direct Mapped Caches</li>
</ol>
</li>
<li><p>Steps for read/write :</p>
<ol>
<li>Set selection<ol>
<li><img src="/2019/02/25/csapp/E:/hexo\Hexo_Repository\source\_posts\csapp\1560580541718.png" alt="1560580541718"></li>
</ol>
</li>
<li>Line matching<ol>
<li><img src="/2019/02/25/csapp/E:/hexo\Hexo_Repository\source\_posts\csapp\1560580518019.png" alt="1560580518019"></li>
</ol>
</li>
<li>World selection <ol>
<li><img src="/2019/02/25/csapp/E:/hexo\Hexo_Repository\source\_posts\csapp\1560580648596.png" alt="1560580648596"></li>
</ol>
</li>
<li>Line replacement on cache misses</li>
</ol>
</li>
<li><p>Conflict misses in Direct-Mapped Caches: </p>
<ol>
<li><p>Thrashing issue : repeatedly writing and evicting same set of cache lines.</p>
<ol>
<li><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span> <span class="function"><span class="keyword">float</span> <span class="title">dotprod</span><span class="params">(<span class="keyword">float</span> x[<span class="number">8</span>], <span class="keyword">float</span> y[<span class="number">8</span>])</span></span></span><br><span class="line"><span class="function">2 </span>&#123;</span><br><span class="line">    <span class="number">3</span> <span class="keyword">float</span> sum = <span class="number">0.0</span>;</span><br><span class="line">    <span class="number">4</span> <span class="keyword">int</span> i;</span><br><span class="line">    <span class="number">5</span></span><br><span class="line">    <span class="number">6</span> <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">8</span>; i++)</span><br><span class="line">        <span class="number">7</span> sum += x[i] * y[i];</span><br><span class="line">    <span class="number">8</span> <span class="keyword">return</span> sum;</span><br><span class="line"><span class="number">9</span> &#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>Suppose float[] x and y are assigned contiguously, then :</p>
<ol>
<li><img src="/2019/02/25/csapp/E:/hexo\Hexo_Repository\source\_posts\csapp\1560582003136.png" alt="1560582003136"></li>
<li>Solution : add padding to x, make float x[12]</li>
</ol>
</li>
</ol>
</li>
</ol>
</li>
</ol>
<h3 id="6-4-3-Set-Associative-Caches"><a href="#6-4-3-Set-Associative-Caches" class="headerlink" title="6.4.3 Set Associative Caches"></a>6.4.3 Set Associative Caches</h3><ol>
<li>Conflict miss in previous section comes from the fact that each set has only one line</li>
<li>Set associative cache has $1 &lt; E &lt; C/B $ lines</li>
<li>Same step :<ol>
<li>Set selection : same as before</li>
<li>Lines matching : linear searching</li>
<li>Line replacement : random pick, LFU, LRU</li>
</ol>
</li>
</ol>
<h3 id="6-4-4-Fully-Associative-Caches"><a href="#6-4-4-Fully-Associative-Caches" class="headerlink" title="6.4.4 Fully Associative Caches"></a>6.4.4 Fully Associative Caches</h3><ol>
<li>$E = C/B$, where $S = 1$, only one set, <ol>
<li>Address setup : <ol>
<li><img src="/2019/02/25/csapp/E:/hexo\Hexo_Repository\source\_posts\csapp\1560582814217.png" alt="1560582814217"></li>
</ol>
</li>
<li>same fetching step as set associative</li>
</ol>
</li>
</ol>
<h3 id="6-4-5-Issues-with-Writes"><a href="#6-4-5-Issues-with-Writes" class="headerlink" title="6.4.5 Issues with Writes"></a>6.4.5 Issues with Writes</h3><ol>
<li>Write to already assigned value:<ol>
<li>Write-through, update immediately</li>
<li>Write-back, defer update until eviction, dirty bit, complexity </li>
</ol>
</li>
<li>Write misses : <ol>
<li>Write-allocate, loads and update, slow since op each write miss</li>
<li>No-write-allocate, write directly to next level</li>
</ol>
</li>
</ol>
<h1 id="7-Linking"><a href="#7-Linking" class="headerlink" title="7. Linking"></a>7. Linking</h1><h2 id="7-1-Compiler-Driver"><a href="#7-1-Compiler-Driver" class="headerlink" title="7.1 Compiler Driver"></a>7.1 Compiler Driver</h2><ol>
<li><strong><em>Compiler Driver</em></strong> is used to invoke language preprocessor, compiler, assembler and linker.<ol>
<li><code>gcc -O2 -g -o p main.c swap.c</code> or step by step :<ol>
<li><code>cpp main.c main.i</code> : preprocessor, include macros</li>
<li><code>cc1 main.i main.c -O2 -o main.s</code> : compile</li>
<li><code>as -o main.o main.s</code> : translate main.o to <strong><em>relocatable object file</em></strong></li>
<li><code>ld -o p main.o swap.o</code> : ties up, resolve reference and relocate data</li>
<li></li>
<li><img src="/2019/02/25/csapp/E:/hexo\Hexo_Repository\source\_posts\csapp\1560653477782.png" alt="1560653477782"></li>
<li>To run, <code>./p</code>, system loads <code>loader</code>, which copies data and code in the <em>executable p</em> to memory and transfer control to beginning of code.</li>
</ol>
</li>
</ol>
</li>
</ol>
<h2 id="7-2-Static-Linking"><a href="#7-2-Static-Linking" class="headerlink" title="7.2 Static Linking"></a>7.2 Static Linking</h2><ol>
<li><em>Static linker</em> such as <code>ld</code> takes input as a collection of <strong><em>relocatable object file</em></strong>, main task:<ol>
<li><em>Symbol resolution</em> : object files define and reference symbols, goal here is to have only one reference at most for each symbol</li>
<li><em>Relocation</em> : Compilers and Assemblers generate code start at address 0. Linker relocates these sections by associating a location with each symbol, and modify all reference to those symbols</li>
</ol>
</li>
<li>Benefits : <ol>
<li>Modularity:</li>
<li>Programs can be written in smaller pieces</li>
<li>Efficiency: recompile certain parts when needed</li>
</ol>
</li>
<li>Dynamic linking : EO contains no library, single copy of code shared across all executing process</li>
</ol>
<h2 id="7-3-Object-Files"><a href="#7-3-Object-Files" class="headerlink" title="7.3 Object Files"></a>7.3 Object Files</h2><ol>
<li>Object files come in 3 forms:<ol>
<li>Relocatable object file(<code>.o</code>) : binary code that can be combined with other to create exe</li>
<li>Executable object file :<code>.out</code> binary code that can be copied to memory and run directly</li>
<li>Shared Object file <code>.so</code>: a special type of Relocatable object file that can be loaded into memory and linked dynamically</li>
</ol>
</li>
<li>Compiler and assembler generate RO and SO, while linker generates EO</li>
<li>Terms : <strong><em>Executable and linkable format(ELF)</em></strong></li>
</ol>
<h2 id="7-4-Relocatable-Object-Files"><a href="#7-4-Relocatable-Object-Files" class="headerlink" title="7.4 Relocatable Object Files"></a>7.4 Relocatable Object Files</h2><ol>
<li><p>ELF format : </p>
<ol>
<li><p><code>.text</code> : machine code for the program</p>
</li>
<li><p><code>.rodata</code> : read-only data such as format string</p>
</li>
<li><p><code>.data</code> : initialized global variables</p>
</li>
<li><p><code>.bss</code> : uninitialized global variables</p>
</li>
<li><p><code>.symtab</code> : <strong><em>a symbol table</em></strong> that defines functions, global variables </p>
</li>
<li><p><code>.rel.txt</code> : instructions that use extern functions or global variables</p>
</li>
<li><p><code>.rel.data</code>  : global variables</p>
</li>
</ol>
</li>
</ol>
<ol start="8">
<li><p><img src="/2019/02/25/csapp/E:/hexo\Hexo_Repository\source\_posts\csapp\1560655874458.png" alt="1560655874458"></p>
</li>
<li></li>
</ol>
<h2 id="7-5-Symbols-and-symbol-table"><a href="#7-5-Symbols-and-symbol-table" class="headerlink" title="7.5 Symbols and symbol table"></a>7.5 Symbols and symbol table</h2><ol>
<li><p>Each RO <code>m</code> has a symbol table that defines symbols used and referenced.</p>
</li>
<li><p>C review : <code>static</code> works as <code>private</code> in C++ or Java.</p>
</li>
<li><p>Three kinds of linker symbol : </p>
<ol>
<li>Global symbols : not-static functions and non-static global variables</li>
<li>External symbols : referenced by m but defined in other modules</li>
<li>Local static symbols : (local non-static program and variables are stored on stack)</li>
</ol>
</li>
<li><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span> <span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="number">2</span> <span class="keyword">int</span> name; <span class="comment">/* String table offset */</span></span><br><span class="line">    <span class="number">3</span> <span class="keyword">int</span> value; <span class="comment">/* Section offset, or VM address */</span></span><br><span class="line">    <span class="number">4</span> <span class="keyword">int</span> size; <span class="comment">/* Object size in bytes */</span></span><br><span class="line">    <span class="number">5</span> <span class="keyword">char</span> type:<span class="number">4</span>, <span class="comment">/* Data, func, section, or src file name (4 bits) */</span></span><br><span class="line">    <span class="number">6</span> binding:<span class="number">4</span>; <span class="comment">/* Local or global (4 bits) */</span></span><br><span class="line">    <span class="number">7</span> <span class="keyword">char</span> reserved; <span class="comment">/* Unused */</span></span><br><span class="line">    <span class="number">8</span> <span class="keyword">char</span> section; <span class="comment">/* Section header index, ABS, UNDEF, */</span></span><br><span class="line">    <span class="number">9</span> <span class="comment">/* Or COMMON */</span></span><br><span class="line"><span class="number">10</span> &#125; Elf_Symbol;</span><br></pre></td></tr></table></figure>
</li>
<li><p>ELF symbol table is stored in <code>.symtab</code>, it contains an array of entries. Above is the format of each entry. </p>
</li>
<li><p><code>readelf</code> for ELF reading :</p>
<ol>
<li><img src="/2019/02/25/csapp/E:/hexo\Hexo_Repository\source\_posts\csapp\1560671412242.png" alt="1560671412242"></li>
</ol>
</li>
</ol>
<h2 id="7-6-Symbol-Resolution"><a href="#7-6-Symbol-Resolution" class="headerlink" title="7.6 Symbol Resolution"></a>7.6 Symbol Resolution</h2><ol>
<li>When met undefined variable, Compiler always assume it will be input by other modules.</li>
</ol>
<h3 id="7-6-1-How-Linkers-solve-Multiply-Defined-Global-Symbols"><a href="#7-6-1-How-Linkers-solve-Multiply-Defined-Global-Symbols" class="headerlink" title="7.6.1 How Linkers solve Multiply Defined Global Symbols"></a>7.6.1 How Linkers solve Multiply Defined Global Symbols</h3><ol>
<li>Symbols :<ol>
<li>Strong : functions and initialized value</li>
<li>Weak : uninitialized</li>
</ol>
</li>
<li>Rules : <ol>
<li>Rule 1: Multiple strong symbols are not allowed.</li>
<li>Rule 2: Given a strong symbol and multiple weak symbols, choose the strong symbol.</li>
<li>Rule 3: Given multiple weak symbols, choose any of the weak symbols.</li>
</ol>
</li>
<li>Potential bug, global variables can be subtly changed without any warning :<ol>
<li>Use <code>-fno-common</code> to warn for multiple global variable</li>
</ol>
</li>
<li>Global variables :<ol>
<li>Avoid if you can,</li>
<li>Use <code>static</code> or reference with <code>extern</code></li>
</ol>
</li>
</ol>
<h3 id="7-6-2-Linking-with-Static-Libraries"><a href="#7-6-2-Linking-with-Static-Libraries" class="headerlink" title="7.6.2 Linking with Static Libraries"></a>7.6.2 Linking with Static Libraries</h3><ol>
<li>Compiler systems provide a mechanism for packaging related object modules into a single<br>file called a <strong><em>static library</em></strong>, which can then be supplied as input to the linker.  </li>
<li>Generate an archive : <ol>
<li><code>unix&gt; gcc -c addvec.c multvec.c
unix&gt; ar rcs libvector.a addvec.o multvec.o</code></li>
<li></li>
</ol>
</li>
<li><img src="/2019/02/25/csapp/E:/hexo\Hexo_Repository\source\_posts\csapp\1560673225212.png" alt="1560673225212"></li>
</ol>
<h3 id="7-6-3-How-linkers-use-Static-Libraries-to-Resolve-References"><a href="#7-6-3-How-linkers-use-Static-Libraries-to-Resolve-References" class="headerlink" title="7.6.3 How linkers use Static Libraries to Resolve References"></a>7.6.3 How linkers use Static Libraries to Resolve References</h3><ol>
<li>Terms : <code>E</code> for RO, <code>U</code> for unsolved reference, <code>D</code> for defined </li>
<li>Static solution : <ol>
<li>For each input file, determines if archive or object file:<ol>
<li>Object file, adds f to <code>E</code> , updates <code>U</code> and <code>E</code> and <code>D</code></li>
<li>Archive, search within <code>U</code> update <code>E</code> if found  </li>
</ol>
</li>
<li>If <code>U</code> not empty after execution, print error</li>
</ol>
</li>
<li>Static solution relies heavily on input order(Met in AWS cloud9)</li>
</ol>
<h2 id="7-7-Relocation"><a href="#7-7-Relocation" class="headerlink" title="7.7 Relocation"></a>7.7 Relocation</h2><ol>
<li>Relocating sections and symbol definitions:<ol>
<li>sections are reorged to same section</li>
<li>Run-time address assigned for symbols</li>
</ol>
</li>
<li>Relocating symbol reference within sections: <ol>
<li>Update to run-time address</li>
</ol>
</li>
</ol>
<h3 id="7-7-1-Relocation-Entries"><a href="#7-7-1-Relocation-Entries" class="headerlink" title="7.7.1 Relocation Entries"></a>7.7.1 Relocation Entries</h3><ol>
<li><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span> <span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="number">2</span> <span class="keyword">int</span> offset; <span class="comment">/* Offset of the reference to relocate */</span></span><br><span class="line">    <span class="number">3</span> <span class="keyword">int</span> symbol:<span class="number">24</span>, <span class="comment">/* Symbol the reference should point to */</span></span><br><span class="line">    <span class="number">4</span> type:<span class="number">8</span>; <span class="comment">/* Relocation type */</span></span><br><span class="line"><span class="number">5</span> &#125; Elf32_Rel;</span><br></pre></td></tr></table></figure>
</li>
<li><p>Two types : relative address and absolute</p>
</li>
</ol>
<h3 id="7-7-2-Relocating-Symbol-References-disdetailed-in-15213"><a href="#7-7-2-Relocating-Symbol-References-disdetailed-in-15213" class="headerlink" title="7.7.2 Relocating Symbol References(disdetailed in 15213)"></a>7.7.2 Relocating Symbol References(disdetailed in 15213)</h3><ol>
<li>Relocating PC-Relative References</li>
<li>Relocating Absolute References</li>
</ol>
<h2 id="7-8-Executable-Object-Files"><a href="#7-8-Executable-Object-Files" class="headerlink" title="7.8 Executable Object Files"></a>7.8 Executable Object Files</h2><ol>
<li>Pretty much same structure as RO, except <code>.rel</code></li>
</ol>
<h2 id="7-9-Loading-Executable-Object-Files-Get-back-after-chapter-9"><a href="#7-9-Loading-Executable-Object-Files-Get-back-after-chapter-9" class="headerlink" title="7.9 Loading Executable Object Files(Get back after chapter 9)"></a>7.9 Loading Executable Object Files(Get back after chapter 9)</h2><ol>
<li>Since <code>./p</code> not built-in command, <code>loader</code> called(also called by <code>execve</code>)<ol>
<li><code>loading</code> : copying the program into memory and then running </li>
</ol>
</li>
</ol>
<h2 id="7-10-Dynamic-Linking-with-Shared-Libraries"><a href="#7-10-Dynamic-Linking-with-Shared-Libraries" class="headerlink" title="7.10 Dynamic Linking with Shared Libraries"></a>7.10 Dynamic Linking with Shared Libraries</h2><ol>
<li>Dynamic Linking:<ol>
<li>DLL(dynamic linking libraries) on Microsoft</li>
<li>Difference :<ol>
<li>Exactly one SO in entire system</li>
</ol>
</li>
</ol>
</li>
<li>Build SO : <code>unix&gt; gcc -shared -fPIC -o libvector.so addvec.c multvec.c</code></li>
<li><img src="/2019/02/25/csapp/E:/hexo\Hexo_Repository\source\_posts\csapp\1560679326460.png" alt="1560679326460"></li>
<li>Steps:<ol>
<li>Relocating the text and data of libc.so into some memory segment.</li>
<li>Relocating the text and data of libvector.so into another memory segment.</li>
<li>Relocating any references in p2 to symbols defined by libc.so and libvector.so.</li>
</ol>
</li>
</ol>
<h2 id="7-11-Loading-and-linking-shared-libraries-from-app"><a href="#7-11-Loading-and-linking-shared-libraries-from-app" class="headerlink" title="7.11 Loading and linking shared libraries from app"></a>7.11 Loading and linking shared libraries from app</h2><ol>
<li><p>Use :</p>
<ol>
<li><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;dlfcn.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">dlopen</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *filename, <span class="keyword">int</span> flag)</span></span>;</span><br><span class="line">Returns: ptr to handle <span class="keyword">if</span> OK, <span class="literal">NULL</span> on error</span><br></pre></td></tr></table></figure>
</li>
</ol>
</li>
<li><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span> <span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="number">2</span> <span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="number">3</span> <span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;dlfcn.h&gt;</span></span></span><br><span class="line"><span class="number">4</span></span><br><span class="line"><span class="number">5</span> <span class="keyword">int</span> x[<span class="number">2</span>] = &#123;<span class="number">1</span>, <span class="number">2</span>&#125;;</span><br><span class="line"><span class="number">6</span> <span class="keyword">int</span> y[<span class="number">2</span>] = &#123;<span class="number">3</span>, <span class="number">4</span>&#125;;</span><br><span class="line"><span class="number">7</span> <span class="keyword">int</span> z[<span class="number">2</span>];</span><br><span class="line"><span class="number">8</span></span><br><span class="line"><span class="number">9</span> <span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function">10 </span>&#123;</span><br><span class="line"><span class="number">11</span> <span class="keyword">void</span> *handle;</span><br><span class="line"><span class="number">12</span> <span class="keyword">void</span> (*addvec)(<span class="keyword">int</span> *, <span class="keyword">int</span> *, <span class="keyword">int</span> *, <span class="keyword">int</span>);</span><br><span class="line"><span class="number">13</span> <span class="keyword">char</span> *error;</span><br><span class="line"><span class="number">14</span></span><br><span class="line"><span class="number">15</span> <span class="comment">/* Dynamically load shared library that contains addvec() */</span></span><br><span class="line"><span class="number">16</span> handle = dlopen(<span class="string">"./libvector.so"</span>, RTLD_LAZY);</span><br><span class="line"><span class="number">17</span> <span class="keyword">if</span> (!handle) &#123;</span><br><span class="line"><span class="number">18</span> <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"%s\n"</span>, dlerror());</span><br><span class="line"><span class="number">19</span> <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line"><span class="number">20</span> &#125;</span><br><span class="line"><span class="number">21</span></span><br><span class="line"><span class="number">22</span> <span class="comment">/* Get a pointer to the addvec() function we just loaded */</span></span><br><span class="line"><span class="number">23</span> addvec = dlsym(handle, <span class="string">"addvec"</span>);</span><br><span class="line"><span class="number">24</span> <span class="keyword">if</span> ((error = dlerror()) != <span class="literal">NULL</span>) &#123;</span><br><span class="line"><span class="number">25</span> <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"%s\n"</span>, error);</span><br><span class="line"><span class="number">26</span> <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line"><span class="number">27</span> &#125;</span><br><span class="line"><span class="number">28</span></span><br><span class="line"><span class="number">29</span> <span class="comment">/* Now we can call addvec() just like any other function */</span></span><br><span class="line"><span class="number">30</span> addvec(x, y, z, <span class="number">2</span>);</span><br><span class="line"><span class="number">31</span> <span class="built_in">printf</span>(<span class="string">"z = [%d %d]\n"</span>, z[<span class="number">0</span>], z[<span class="number">1</span>]);</span><br><span class="line"><span class="number">32</span></span><br><span class="line"><span class="number">33</span> <span class="comment">/* Unload the shared library */</span></span><br><span class="line"><span class="number">34</span> <span class="keyword">if</span> (dlclose(handle) &lt; <span class="number">0</span>) &#123;</span><br><span class="line"><span class="number">35</span> <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"%s\n"</span>, dlerror());</span><br><span class="line"><span class="number">36</span> <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line"><span class="number">37</span> &#125;</span><br><span class="line"><span class="number">38</span> <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"><span class="number">39</span> &#125;</span><br></pre></td></tr></table></figure>
</li>
<li></li>
</ol>
<h2 id="7-12-Position-Independent-Code-PIC"><a href="#7-12-Position-Independent-Code-PIC" class="headerlink" title="7.12 Position Independent Code(PIC)"></a>7.12 Position Independent Code(PIC)</h2><ol>
<li>Key purpose of SO : multiple process sharing same SO, unlike static linking(huge waste of memory)</li>
<li>One solution : assign a fixed address for each SO, trivial </li>
<li>Use PIC, compile SO so that can be loaded and executed at any address, options <code>-fPIC</code></li>
<li>PIC relies on the fact that, relative distance between data and code sections are run-time constant</li>
</ol>
<h3 id="7-12-1-PIC-Data-Reference"><a href="#7-12-1-PIC-Data-Reference" class="headerlink" title="7.12.1 PIC Data Reference"></a>7.12.1 PIC Data Reference</h3><ol>
<li><p><strong><em>Global Offset Table</em></strong>(GOT) : entry for each global data referenced by object module,</p>
<ol>
<li><p>Relocation record is created for each entry in <strong><em>GOT</em></strong> as well</p>
</li>
<li><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">call L1       // push PC on stack </span><br><span class="line">L1: popl %ebx // ebx contains the current PC</span><br><span class="line">addl $VAROFF, // %ebx ebx points to the GOT entry for var</span><br><span class="line">movl (%ebx),  // %eax reference indirect through the GOT</span><br><span class="line">movl (%eax),  // %eax</span><br></pre></td></tr></table></figure>
</li>
<li><p>Slow, takes 5 instructions and waste 1 register</p>
</li>
</ol>
</li>
</ol>
<h3 id="7-12-2-PIC-Function-calls"><a href="#7-12-2-PIC-Function-calls" class="headerlink" title="7.12.2 PIC Function calls"></a>7.12.2 PIC Function calls</h3><ol>
<li><p>Same approach as 7.12.1 works as well :</p>
<ol>
<li><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">call L1</span><br><span class="line">L1: popl %ebx ebx contains the current PC</span><br><span class="line">addl $PROCOFF, %ebx ebx points to GOT entry for proc</span><br><span class="line">call *(%ebx) call indirect through the GOT</span><br></pre></td></tr></table></figure>
</li>
</ol>
</li>
<li><p>Instead, ELF uses <code>lazy binding</code>, defer the binding of procedure until invoked</p>
<ol>
<li>Implemented with GOT and <strong><em>Procedure Linkage Table</em></strong>(PLT) <ol>
<li>GOT : <img src="/2019/02/25/csapp/E:/hexo\Hexo_Repository\source\_posts\csapp\1560690030413.png" alt="1560690030413"></li>
<li>PLT : <img src="/2019/02/25/csapp/E:/hexo\Hexo_Repository\source\_posts\csapp\1560690050562.png" alt="1560690050562"></li>
<li>Complex steps:<ol>
<li><strong><em>First</em></strong> time <code>addvec</code> called, starts with <code>PLT[2]</code>, which jumps to <code>&amp;GOT[4]</code> (corresponding GOT  address)</li>
<li><code>&amp;GOT[4]</code> stores 2nd step in <code>PLT[2]</code>, and <code>pushl</code> <code>addvec</code> ID onto stack</li>
<li>3rd step Jump to <code>PLT[0]</code> and pushes some identifying info onto stack</li>
<li>Jump to <code>&amp;GOT[2]</code> and start normal DLL process with two stack entries and overwrite <code>&amp;GOT[2]</code></li>
<li><strong><em>Magic</em></strong> : next time steps to <code>&amp;GOT[4]</code> , direct call</li>
</ol>
</li>
</ol>
</li>
</ol>
</li>
</ol>
<h1 id="8-Exceptional-Control-Flow"><a href="#8-Exceptional-Control-Flow" class="headerlink" title="8. Exceptional Control Flow"></a>8. Exceptional Control Flow</h1><ol>
<li>Control flow : System executes instruction in a sequence, each switch to next instruction is a <code>transfer of control</code> or <code>control flow</code></li>
<li>Review : program counter <code>%eip</code></li>
</ol>
<h2 id="8-1-Exceptions"><a href="#8-1-Exceptions" class="headerlink" title="8.1 Exceptions"></a>8.1 Exceptions</h2><ol>
<li>Exceptions, a form of ECF that is implemented partly by the hardware and by the operating system<ol>
<li><strong><em>Definition</em></strong>: abrupt change in control flow in response to some change in the processor’s state</li>
<li>General steps:<ol>
<li><img src="/2019/02/25/csapp/E:/hexo\Hexo_Repository\source\_posts\csapp\1560741893644.png" alt="1560741893644"></li>
<li>Events: change in <strong><em>state</em></strong> (<em>encoded in bits in processor</em>) might be related to current program or not</li>
<li><code>OS kernal knowledge</code> : processor made an indirect procedure call made, through a jump table  (<strong><em>exception table</em></strong>) , jump to exception handler</li>
</ol>
</li>
</ol>
</li>
</ol>
<h3 id="8-1-1-Exception-handling"><a href="#8-1-1-Exception-handling" class="headerlink" title="8.1.1 Exception handling"></a>8.1.1 Exception handling</h3><ol>
<li>Each type of exception has a <strong><em>exception number</em></strong>, <ol>
<li>Some are assigned by designer of process</li>
<li>some are by Kernel </li>
<li><img src="/2019/02/25/csapp/E:/hexo\Hexo_Repository\source\_posts\csapp\1560745947054.png" alt="1560745947054"></li>
<li><img src="/2019/02/25/csapp/E:/hexo\Hexo_Repository\source\_posts\csapp\1560746416307.png" alt="1560746416307"></li>
<li>Return address can be either current or the next one</li>
<li>Exception handler runs in Kernel mode, all access</li>
</ol>
</li>
</ol>
<h3 id="8-1-2-Classes-of-Exceptions"><a href="#8-1-2-Classes-of-Exceptions" class="headerlink" title="8.1.2 Classes of Exceptions"></a>8.1.2 Classes of Exceptions</h3><ol>
<li>Exception classes :<ol>
<li><img src="/2019/02/25/csapp/E:/hexo\Hexo_Repository\source\_posts\csapp\1560747692644.png" alt="1560747692644"></li>
</ol>
</li>
<li>Interrupt : caused from I/O, asynchronous,<ol>
<li><img src="/2019/02/25/csapp/E:/hexo\Hexo_Repository\source\_posts\csapp\1560748017060.png" alt="1560748017060"></li>
<li></li>
</ol>
</li>
<li>Traps : intentional, provides interface between program and kernel. aka <strong><em>system calls</em></strong><ol>
<li><img src="/2019/02/25/csapp/E:/hexo\Hexo_Repository\source\_posts\csapp\1560748175647.png" alt="1560748175647"></li>
<li>Programs request <code>syscall n</code> and handler runs in Kernel code</li>
</ol>
</li>
<li>Faults : <img src="/2019/02/25/csapp/E:/hexo\Hexo_Repository\source\_posts\csapp\1560749709931.png" alt="1560749709931"></li>
<li>Aborts : caused by hardware error in SRAM and DRAM</li>
</ol>
<h3 id="8-1-3-Examples-Exceptions-in-Linux-IA32-System"><a href="#8-1-3-Examples-Exceptions-in-Linux-IA32-System" class="headerlink" title="8.1.3 Examples : Exceptions in Linux/IA32 System"></a>8.1.3 Examples : Exceptions in Linux/IA32 System</h3><ol>
<li><p>Integers used to represent <code>exceptions</code>: </p>
<ol>
<li><p><img src="/2019/02/25/csapp/E:/hexo\Hexo_Repository\source\_posts\csapp\1560750391440.png" alt="1560750391440"></p>
</li>
<li><p><img src="/2019/02/25/csapp/E:/hexo\Hexo_Repository\source\_posts\csapp\1560750498446.png" alt="1560750498446"></p>
</li>
<li><p>System-level functions: wrapper to make system call, <code>IA32 instruction</code> : <code>int 32</code></p>
<ol>
<li><p>C can invoke syscall directly through <code>syscall</code> function</p>
</li>
<li><p>Registers used to pass parameters, </p>
<ol>
<li><p><code>%eax</code> : stores syscall number and invoke with <code>int</code></p>
</li>
<li><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">1 .section .data</span><br><span class="line">2 string:</span><br><span class="line">3 .ascii &quot;hello, world\n&quot;</span><br><span class="line">4 string_end:</span><br><span class="line">5 .equ len, string_end - string</span><br><span class="line">6 .section .text</span><br><span class="line">7 .globl main</span><br><span class="line">8 main:</span><br><span class="line">//First, call write(1, &quot;hello, world\n&quot;, 13)</span><br><span class="line">// prototype : write(file_descriptor, *char, length)</span><br><span class="line"></span><br><span class="line">9 movl $4, %eax //System call number 4</span><br><span class="line">10 movl $1, %ebx //stdout has descriptor 1</span><br><span class="line">11 movl $string, %ecx //Hello world string</span><br><span class="line">12 movl $len, %edx //String length</span><br><span class="line">13 int $0x80 //System call code</span><br><span class="line">Next, call exit(0)</span><br><span class="line">14 movl $1, %eax System call number 0</span><br><span class="line">15 movl $0, %ebx Argument is 0</span><br><span class="line">16 int $0x80 System call code</span><br></pre></td></tr></table></figure>
</li>
</ol>
</li>
</ol>
</li>
</ol>
</li>
</ol>
<h2 id="8-2-Processes"><a href="#8-2-Processes" class="headerlink" title="8.2 Processes"></a>8.2 Processes</h2><ol>
<li><strong><em>Process</em></strong> : <strong>an instance of a program in execution</strong><ol>
<li>Each program needs to run in the context of a process</li>
<li>Context includes :<ol>
<li>program’s code and data in memory</li>
<li>register, stack space, open file descriptor</li>
</ol>
</li>
<li>Focus :<ol>
<li>Independent logical flow</li>
<li>Private address space</li>
</ol>
</li>
</ol>
</li>
<li>Each time we run a executable file, a new process is created</li>
</ol>
<h3 id="8-2-1-Logical-Control-Flow"><a href="#8-2-1-Logical-Control-Flow" class="headerlink" title="8.2.1 Logical Control Flow"></a>8.2.1 Logical Control Flow</h3><ol>
<li><img src="/2019/02/25/csapp/E:/hexo\Hexo_Repository\source\_posts\csapp\1560756705612.png" alt="1560756705612"></li>
<li>A series of PC linked to processor dynamically.</li>
</ol>
<h3 id="8-2-2-Concurrent-Flow"><a href="#8-2-2-Concurrent-Flow" class="headerlink" title="8.2.2 Concurrent Flow"></a>8.2.2 Concurrent Flow</h3><ol>
<li>Process A starts after process B starts, before B ends<ol>
<li>A and B run concurrently, while B and C does not</li>
<li>Time slice : time period process executes its flow</li>
<li>Multitasking  == time slicing</li>
<li>Parallel flow : running concurrently on different cores</li>
</ol>
</li>
</ol>
<h3 id="8-2-3-Private-Address-Space"><a href="#8-2-3-Private-Address-Space" class="headerlink" title="8.2.3 Private Address Space"></a>8.2.3 Private Address Space</h3><ol>
<li>Address space that can not be read or written by any other process<ol>
<li><img src="/2019/02/25/csapp/E:/hexo\Hexo_Repository\source\_posts\csapp\1560757475911.png" alt="1560757475911"></li>
</ol>
</li>
</ol>
<h3 id="8-2-4-User-and-Kernel-Mode"><a href="#8-2-4-User-and-Kernel-Mode" class="headerlink" title="8.2.4 User and Kernel Mode"></a>8.2.4 User and Kernel Mode</h3><ol>
<li>Mode bit in some control register helps to differ Kernel and User mode</li>
<li><code>proc</code> provides info about process like pseudo-file system</li>
</ol>
<h3 id="8-2-5-Context-Switches"><a href="#8-2-5-Context-Switches" class="headerlink" title="8.2.5 Context Switches"></a>8.2.5 Context Switches</h3><ol>
<li>Context : defined in 8.1</li>
<li><strong><em>Scheduler</em></strong> in OS : <ol>
<li>preempt and save current process, </li>
<li>restores saved context of certain process</li>
<li>passes control to that process</li>
</ol>
</li>
<li>One scenario for context switch :<ol>
<li>Waiting for system call to complete, a <code>read</code> call is made</li>
<li><img src="/2019/02/25/csapp/E:/hexo\Hexo_Repository\source\_posts\csapp\1560758603026.png" alt="1560758603026"></li>
</ol>
</li>
</ol>
<h2 id="8-3-System-Call-Error-Handling"><a href="#8-3-System-Call-Error-Handling" class="headerlink" title="8.3 System Call Error Handling"></a>8.3 System Call Error Handling</h2><ol>
<li><p>Original way :</p>
<ol>
<li><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ((pid = fork()) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">	<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"fork error: %s\n"</span>, strerror(errno)); <span class="comment">// fprintf:print to file</span></span><br><span class="line">	<span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li></li>
</ol>
</li>
<li><p>Error handling wrapper : </p>
<ol>
<li><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span> <span class="keyword">pid_t</span> Fork(<span class="keyword">void</span>)</span><br><span class="line"><span class="number">2</span> &#123;</span><br><span class="line"><span class="number">3</span> 	<span class="keyword">pid_t</span> pid;</span><br><span class="line"><span class="number">4</span></span><br><span class="line"><span class="number">5</span> 	<span class="keyword">if</span> ((pid = fork()) &lt; <span class="number">0</span>)</span><br><span class="line"><span class="number">6</span> 		unix_error(<span class="string">"Fork error"</span>);</span><br><span class="line"><span class="number">7</span> 	<span class="keyword">return</span> pid;</span><br><span class="line"><span class="number">8</span> &#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>errno</code> is a global variable </p>
</li>
</ol>
</li>
</ol>
<h2 id="8-4-Process-Control"><a href="#8-4-Process-Control" class="headerlink" title="8.4 Process Control"></a>8.4 Process Control</h2><h3 id="8-4-1-Obtaining-Process-IDs"><a href="#8-4-1-Obtaining-Process-IDs" class="headerlink" title="8.4.1 Obtaining Process IDs"></a>8.4.1 Obtaining Process IDs</h3><ol>
<li><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">pid_t</span> getpid(<span class="keyword">void</span>);  <span class="comment">// current, pid_t defined in type.h as int</span></span><br><span class="line"><span class="keyword">pid_t</span> getppid(<span class="keyword">void</span>); <span class="comment">// parents</span></span><br><span class="line">							Returns: PID of either the caller <span class="keyword">or</span> the parent</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="8-4-2-Creating-and-Terminating-Processes"><a href="#8-4-2-Creating-and-Terminating-Processes" class="headerlink" title="8.4.2 Creating and Terminating Processes"></a>8.4.2 Creating and Terminating Processes</h3><ol>
<li><p>Three states for a process :</p>
<ol>
<li><p>Running: is running or waiting to be run</p>
</li>
<li><p>Stopped:</p>
<ol>
<li>Stop upon : <code>SIGSTOP</code>, <code>SIGTSTP</code>, <code>SIGTTIN</code>, or <code>SIGTTOU</code></li>
<li>Continue : <code>SIGCONT</code></li>
</ol>
</li>
<li><p>Terminated</p>
<ol>
<li><p>Receives a signal whose default action is to terminate</p>
</li>
<li><p>Return from main routine</p>
<ol>
<li><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">exit</span><span class="params">(<span class="keyword">int</span> status)</span></span>;</span><br><span class="line">This function does <span class="keyword">not</span> <span class="keyword">return</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
</li>
</ol>
</li>
</ol>
</li>
</ol>
<pre><code>3. Call exit function `exit(num)` same as `return num`

4. 
</code></pre><ol start="2">
<li><p>Create new process :</p>
<ol>
<li><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="keyword">pid_t</span> fork(<span class="keyword">void</span>);</span><br><span class="line">Returns: <span class="number">0</span> in child process, PID of child in parent process, −<span class="number">1</span> on error</span><br></pre></td></tr></table></figure>
</li>
<li><p>Child gets an identical but separated copy of parent’s address space and file descriptor</p>
</li>
<li><p>Run once, return twice, in arbitrary order</p>
<ol>
<li><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"csapp.h"</span></span></span><br><span class="line"><span class="comment">// return order of process is still undetermined</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"> 	<span class="keyword">pid_t</span> pid;</span><br><span class="line">	<span class="keyword">int</span> x = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"> 	pid = Fork();</span><br><span class="line"> 	<span class="keyword">if</span> (pid == <span class="number">0</span>) &#123; <span class="comment">/* Child */</span></span><br><span class="line"> 		<span class="built_in">printf</span>(<span class="string">"child : x=%d\n"</span>, ++x);</span><br><span class="line"> 		<span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line"> 	&#125;</span><br><span class="line"></span><br><span class="line"> 	<span class="comment">/* Parent */</span></span><br><span class="line"> 	<span class="built_in">printf</span>(<span class="string">"parent: x=%d\n"</span>, --x);</span><br><span class="line"> 	<span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li></li>
</ol>
</li>
</ol>
</li>
</ol>
<h3 id="8-4-3-Reaping-Child-Process"><a href="#8-4-3-Reaping-Child-Process" class="headerlink" title="8.4.3 Reaping Child Process"></a>8.4.3 Reaping Child Process</h3><ol>
<li><p>A process terminated but system will not remove it unless ordered to, reaping</p>
<ol>
<li><p>Zombie : terminated process not yet reaped</p>
</li>
<li><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"><span class="keyword">pid_t</span> waitpid(<span class="keyword">pid_t</span> pid, <span class="keyword">int</span> *status, <span class="keyword">int</span> options);</span><br><span class="line">Returns: PID of child <span class="keyword">if</span> OK, <span class="number">0</span> (<span class="keyword">if</span> WNOHANG) <span class="keyword">or</span> −<span class="number">1</span> on error</span><br></pre></td></tr></table></figure>
</li>
<li><p>Function : suspends execution of calling process until a child process in its <strong><em>wait set</em></strong> terminates.  If a process in the wait set is already finished, return immediately.</p>
</li>
<li><p><strong><em>Wait set</em></strong> :</p>
<ol>
<li><code>PID &gt; 0</code> :  single process denoted by pid</li>
<li><code>PID = -1</code> : all children process </li>
</ol>
</li>
<li><p><strong><em>Options</em></strong> : </p>
<ol>
<li><code>WNOHANG</code> : return immediately if no child in set terminated</li>
<li><code>WUNTRACED</code> : return when process in set stopped or terminated(default <code>waitpid</code><strong><em>only check for terminated</em></strong> ones)</li>
<li><code>WNOHANG|WUNTRACED</code> : </li>
</ol>
</li>
<li><p><strong><em>Exit status</em></strong> : </p>
<ol>
<li><code>WIFEXITED(status)</code> : Returns true if the child terminated normally, via a call to exit or a return.</li>
<li><code>WEXITSTAUTS</code> : Returns the exit status of a normally terminated child. This status is only defined if <code>WIFEXITED</code> returned true.</li>
<li><code>WIFSIGNALED</code> :  Returns true if the child process terminated because of a signal that was not caught. </li>
<li><code>WTERMSIG</code> :   Returns the number of the signal that caused the child process to terminate. This status is only defined if <code>WIFSIGNALED(status)</code>returned true.</li>
<li><code>WIFSTOPPED</code> : Returns true if the child that caused the return is currently stopped.</li>
<li><code>WSTOPSIG</code> : Returns the number of the signal that caused the child to stop. This status is only defined if <code>WIFSTOPPED(status)</code> returned true.</li>
</ol>
</li>
</ol>
</li>
<li><p><code>wait</code> : simpler version of <code>waitpid</code>:</p>
<ol>
<li><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"><span class="keyword">pid_t</span> wait(<span class="keyword">int</span> *status); <span class="comment">// equivalent = waitpid(-1 ,&amp;status, 0)</span></span><br><span class="line">Returns: PID of child <span class="keyword">if</span> OK <span class="keyword">or</span> −<span class="number">1</span> on error</span><br></pre></td></tr></table></figure>
</li>
<li><p>Calling <code>wait(&amp;status)</code> is equivalent to calling <code>waitpid(-1, &amp;status, 0)</code> .</p>
</li>
</ol>
</li>
<li><p>Example :</p>
<ol>
<li><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"csapp.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> N 2</span></span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> status, i;</span><br><span class="line">	<span class="keyword">pid_t</span> pid;</span><br><span class="line">  </span><br><span class="line"><span class="comment">/* Parent creates N children */</span></span><br><span class="line">	<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; N; i++)</span><br><span class="line">		<span class="keyword">if</span> ((pid = Fork()) == <span class="number">0</span>) <span class="comment">/* Child */</span></span><br><span class="line">		<span class="built_in">exit</span>(<span class="number">100</span>+i);</span><br><span class="line">  </span><br><span class="line"><span class="comment">/* Parent reaps N children in no particular order */</span></span><br><span class="line">	<span class="keyword">while</span> ((pid = waitpid(<span class="number">-1</span>, &amp;status, <span class="number">0</span>)) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="keyword">if</span> (WIFEXITED(status))</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">"child %d terminated normally with exit status=%d\n"</span>,</span><br><span class="line">		pid, WEXITSTATUS(status));</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">"child %d terminated abnormally\n"</span>, pid);</span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line">	<span class="comment">/* The only normal termination is if there are no more children */</span></span><br><span class="line">	<span class="keyword">if</span> (errno != ECHILD)</span><br><span class="line">  	unix_error(<span class="string">"waitpid error"</span>);</span><br><span class="line">  </span><br><span class="line">	<span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>Adjustment :</p>
<ol>
<li><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"csapp.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> N 2</span></span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">int</span> status, i;</span><br><span class="line"><span class="keyword">pid_t</span> pid[N], retpid;</span><br><span class="line">  </span><br><span class="line"><span class="comment">/* Parent creates N children */</span></span><br><span class="line"><span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; N; i++)</span><br><span class="line">	<span class="keyword">if</span> ((pid[i] = Fork()) == <span class="number">0</span>) <span class="comment">/* Child */</span></span><br><span class="line"><span class="built_in">exit</span>(<span class="number">100</span>+i);</span><br><span class="line">  </span><br><span class="line"><span class="comment">/* Parent reaps N children in order */</span></span><br><span class="line">i = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">while</span> ((retpid = waitpid(pid[i++], &amp;status, <span class="number">0</span>)) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (WIFEXITED(status))</span><br><span class="line">       <span class="built_in">printf</span>(<span class="string">"child %d terminated normally with exit status=%d\n"</span>,</span><br><span class="line">       retpid, WEXITSTATUS(status));</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">       <span class="built_in">printf</span>(<span class="string">"child %d terminated abnormally\n"</span>, retpid);</span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line"><span class="comment">/* The only normal termination is if there are no more children */</span></span><br><span class="line"><span class="keyword">if</span> (errno != ECHILD)</span><br><span class="line">  	 unix_error(<span class="string">"waitpid error"</span>);</span><br><span class="line"><span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li></li>
</ol>
</li>
</ol>
</li>
</ol>
<h3 id="8-4-4-Putting-Processes-to-Sleep"><a href="#8-4-4-Putting-Processes-to-Sleep" class="headerlink" title="8.4.4 Putting Processes to Sleep"></a>8.4.4 Putting Processes to Sleep</h3><ol>
<li><p>Sleep :</p>
<ol>
<li><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">int</span> <span class="title">sleep</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">int</span> secs)</span></span>;</span><br><span class="line">Returns: seconds left to sleep, possible when interrupted by signal</span><br></pre></td></tr></table></figure>
</li>
<li></li>
</ol>
</li>
</ol>
<h3 id="8-4-5-Loading-and-Running-Program"><a href="#8-4-5-Loading-and-Running-Program" class="headerlink" title="8.4.5 Loading and Running Program"></a>8.4.5 Loading and Running Program</h3><ol>
<li><p><code>execve</code> : </p>
<ol>
<li><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">execve</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *filename, <span class="keyword">const</span> <span class="keyword">char</span> *argv[],<span class="keyword">const</span> <span class="keyword">char</span> *envp[])</span></span>; <span class="comment">// filename executable file</span></span><br><span class="line">Does <span class="keyword">not</span> <span class="keyword">return</span> <span class="keyword">if</span> OK, returns −<span class="number">1</span> on error</span><br></pre></td></tr></table></figure>
</li>
<li><p>Runs <code>EO</code>, </p>
</li>
<li><p>Environment variable list : </p>
<ol>
<li><img src="/2019/02/25/csapp/E:/hexo\Hexo_Repository\source\_posts\csapp\1560825894299.png" alt="1560825894299"></li>
</ol>
</li>
<li><p>Argument List : </p>
<ol>
<li><p><img src="/2019/02/25/csapp/E:/hexo\Hexo_Repository\source\_posts\csapp\1560825914298.png" alt="1560825914298"></p>
</li>
<li><p><img src="/2019/02/25/csapp/E:/hexo\Hexo_Repository\source\_posts\csapp\1560826327207.png" alt="1560826327207"></p>
</li>
<li><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">char</span> *<span class="title">getenv</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *name)</span></span>; <span class="comment">// searches for variable string `name=value`</span></span><br><span class="line">Returns: ptr to name <span class="keyword">if</span> exists, <span class="literal">NULL</span> <span class="keyword">if</span> no match</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">setenv</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *name, <span class="keyword">const</span> <span class="keyword">char</span> *newvalue, <span class="keyword">int</span> overwrite)</span></span>;</span><br><span class="line">Returns: <span class="number">0</span> on success, −<span class="number">1</span> on error</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">unsetenv</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *name)</span></span>;</span><br><span class="line">Returns: nothing</span><br></pre></td></tr></table></figure>
</li>
<li></li>
</ol>
</li>
</ol>
</li>
</ol>
<h3 id="8-4-6-Using-fork-and-execve-to-Run-Programs"><a href="#8-4-6-Using-fork-and-execve-to-Run-Programs" class="headerlink" title="8.4.6 Using fork  and execve to Run Programs"></a>8.4.6 Using <em>fork</em>  and <em>execve</em> to Run Programs</h3><ol>
<li><p>Main route for a simple shell : </p>
<ol>
<li><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* $begin shellmain */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"csapp.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MAXARGS   128</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* function prototypes */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">eval</span><span class="params">(<span class="keyword">char</span> *cmdline)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">parseline</span><span class="params">(<span class="keyword">char</span> *buf, <span class="keyword">char</span> **argv)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">builtin_command</span><span class="params">(<span class="keyword">char</span> **argv)</span></span>; </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> cmdline[MAXLINE]; <span class="comment">/* Command line */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">	<span class="comment">/* Read */</span></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"&gt; "</span>);                   </span><br><span class="line">	Fgets(cmdline, MAXLINE, <span class="built_in">stdin</span>); </span><br><span class="line">	<span class="keyword">if</span> (feof(<span class="built_in">stdin</span>))</span><br><span class="line">	    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Evaluate */</span></span><br><span class="line">	eval(cmdline);</span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* $end shellmain */</span></span><br><span class="line">  </span><br><span class="line"><span class="comment">/* $begin eval */</span></span><br><span class="line"><span class="comment">/* eval - Evaluate a command line */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">eval</span><span class="params">(<span class="keyword">char</span> *cmdline)</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> *argv[MAXARGS]; <span class="comment">/* Argument list execve() */</span></span><br><span class="line">    <span class="keyword">char</span> buf[MAXLINE];   <span class="comment">/* Holds modified command line */</span></span><br><span class="line">    <span class="keyword">int</span> bg;              <span class="comment">/* Should the job run in bg or fg? */</span></span><br><span class="line">    <span class="keyword">pid_t</span> pid;           <span class="comment">/* Process id */</span></span><br><span class="line">    </span><br><span class="line">    <span class="built_in">strcpy</span>(buf, cmdline);</span><br><span class="line">    bg = parseline(buf, argv); </span><br><span class="line">    <span class="keyword">if</span> (argv[<span class="number">0</span>] == <span class="literal">NULL</span>)  </span><br><span class="line">	<span class="keyword">return</span>;   <span class="comment">/* Ignore empty lines */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!builtin_command(argv)) &#123; </span><br><span class="line">	<span class="keyword">if</span> ((pid = Fork()) == <span class="number">0</span>) &#123;   <span class="comment">/* Child runs user job */</span></span><br><span class="line">	    <span class="keyword">if</span> (execve(argv[<span class="number">0</span>], argv, environ) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">"%s: Command not found.\n"</span>, argv[<span class="number">0</span>]);</span><br><span class="line">		<span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">	    &#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Parent waits for foreground job to terminate */</span></span><br><span class="line">	<span class="keyword">if</span> (!bg) &#123;</span><br><span class="line">	    <span class="keyword">int</span> status;</span><br><span class="line">	    <span class="keyword">if</span> (waitpid(pid, &amp;status, <span class="number">0</span>) &lt; <span class="number">0</span>)</span><br><span class="line">		unix_error(<span class="string">"waitfg: waitpid error"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	    <span class="built_in">printf</span>(<span class="string">"%d %s"</span>, pid, cmdline);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* If first arg is a builtin command, run it and return true */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">builtin_command</span><span class="params">(<span class="keyword">char</span> **argv)</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(argv[<span class="number">0</span>], <span class="string">"quit"</span>)) <span class="comment">/* quit command */</span></span><br><span class="line">	<span class="built_in">exit</span>(<span class="number">0</span>);  </span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(argv[<span class="number">0</span>], <span class="string">"&amp;"</span>))    <span class="comment">/* Ignore singleton &amp; */</span></span><br><span class="line">	<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;                     <span class="comment">/* Not a builtin command */</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* $end eval */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* $begin parseline */</span></span><br><span class="line"><span class="comment">/* parseline - Parse the command line and build the argv array */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">parseline</span><span class="params">(<span class="keyword">char</span> *buf, <span class="keyword">char</span> **argv)</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> *delim;         <span class="comment">/* Points to first space delimiter */</span></span><br><span class="line">    <span class="keyword">int</span> argc;            <span class="comment">/* Number of args */</span></span><br><span class="line">    <span class="keyword">int</span> bg;              <span class="comment">/* Background job? */</span></span><br><span class="line"></span><br><span class="line">    buf[<span class="built_in">strlen</span>(buf)<span class="number">-1</span>] = <span class="string">' '</span>;  <span class="comment">/* Replace trailing '\n' with space */</span></span><br><span class="line">    <span class="keyword">while</span> (*buf &amp;&amp; (*buf == <span class="string">' '</span>)) <span class="comment">/* Ignore leading spaces */</span></span><br><span class="line">	buf++;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Build the argv list */</span></span><br><span class="line">    argc = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> ((delim = <span class="built_in">strchr</span>(buf, <span class="string">' '</span>))) &#123;</span><br><span class="line">	argv[argc++] = buf;</span><br><span class="line">	*delim = <span class="string">'\0'</span>;</span><br><span class="line">	buf = delim + <span class="number">1</span>;</span><br><span class="line">	<span class="keyword">while</span> (*buf &amp;&amp; (*buf == <span class="string">' '</span>)) <span class="comment">/* Ignore spaces */</span></span><br><span class="line">	       buf++;</span><br><span class="line">    &#125;</span><br><span class="line">    argv[argc] = <span class="literal">NULL</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (argc == <span class="number">0</span>)  <span class="comment">/* Ignore blank line */</span></span><br><span class="line">	<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Should the job run in the background? */</span></span><br><span class="line">    <span class="keyword">if</span> ((bg = (*argv[argc<span class="number">-1</span>] == <span class="string">'&amp;'</span>)) != <span class="number">0</span>)</span><br><span class="line">	argv[--argc] = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> bg;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* $end parseline */</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>Parse line function : </p>
<ol>
<li><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"> </span><br></pre></td></tr></table></figure>
</li>
<li></li>
</ol>
</li>
</ol>
</li>
</ol>
<h2 id="8-5-Signals"><a href="#8-5-Signals" class="headerlink" title="8.5 Signals"></a>8.5 Signals</h2><h3 id="8-5-1-Signals-Terminology"><a href="#8-5-1-Signals-Terminology" class="headerlink" title="8.5.1 Signals Terminology"></a>8.5.1 Signals Terminology</h3><ol>
<li><p>A signal is a small message that notifies a process that an event of some type has occurred in the system</p>
</li>
<li><p>Transfer of signal : </p>
<ol>
<li>Sending a signal : <ol>
<li>Kernel detected event </li>
<li>Process send itself another signal, by <code>kill</code></li>
</ol>
</li>
<li>Receiving a signal : <ol>
<li>either :<ol>
<li><strong><em>ignore</em></strong>, <strong><em>terminate</em></strong>, or <strong><em>catch</em></strong> by a user-level <code>signal handler</code></li>
</ol>
</li>
<li>Signal send but not yet received is called <strong><em>pending</em></strong>, at any point of time, there can be at most one pending signal of certain type</li>
<li>A process can also block certain signals, resulting pending signal will not be received unless unblock</li>
</ol>
</li>
</ol>
</li>
<li><p>Blocking rules : </p>
<ol>
<li><p>Implicit blocking : Kernel blocks any pending signals of type currently being handled</p>
</li>
<li><p>Explicit blocking : </p>
<ol>
<li><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sigprocmask</span><span class="params">(<span class="keyword">int</span> how, <span class="keyword">const</span> <span class="keyword">sigset_t</span> *newset, <span class="keyword">sigset_t</span> *oldset)</span></span>; </span><br><span class="line"><span class="comment">// current blocked set interact(depends on how) with newset, previous set stored in oldset</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// how : </span></span><br><span class="line"><span class="comment">// SIG_BLOCK : newset | set</span></span><br><span class="line"><span class="comment">// SIG_UNBLOCK : ~newset &amp; set </span></span><br><span class="line"><span class="comment">// SIG_SETMASK, set = newset</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sigemptyset</span><span class="params">(<span class="keyword">sigset_t</span> *<span class="built_in">set</span>)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sigfillset</span><span class="params">(<span class="keyword">sigset_t</span> *<span class="built_in">set</span>)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sigaddset</span><span class="params">(<span class="keyword">sigset_t</span> *<span class="built_in">set</span>, <span class="keyword">int</span> signum)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sigdelset</span><span class="params">(<span class="keyword">sigset_t</span> *<span class="built_in">set</span>, <span class="keyword">int</span> signum)</span></span>;</span><br><span class="line">Returns: <span class="number">0</span> <span class="keyword">if</span> OK, −<span class="number">1</span> on error</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sigismember</span><span class="params">(<span class="keyword">const</span> <span class="keyword">sigset_t</span> *<span class="built_in">set</span>, <span class="keyword">int</span> signum)</span></span>;</span><br><span class="line">Returns: <span class="number">1</span> <span class="keyword">if</span> member, <span class="number">0</span> <span class="keyword">if</span> <span class="keyword">not</span>, −<span class="number">1</span> on error</span><br></pre></td></tr></table></figure>
</li>
</ol>
</li>
<li><p>Handling bit vector example : </p>
<ol>
<li><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">sigset_t</span> mask, prev_mask;</span><br><span class="line"> Sigemptyset(&amp;mask);</span><br><span class="line"> Sigaddset(&amp;mask, SIGINT);</span><br><span class="line"> <span class="comment">/* Block SIGINT and save previous blocked set */</span></span><br><span class="line"> Sigprocmask(SIG_BLOCK, &amp;mask, &amp;prev_mask); </span><br><span class="line"> <span class="comment">/* Code region that will not be interrupted by SIGINT */</span></span><br><span class="line"> <span class="comment">/* Restore previous blocked set, unblocking SIGINT */</span></span><br><span class="line"> Sigprocmask(SIG_SETMASK, &amp;prev_mask, <span class="literal">NULL</span>);</span><br></pre></td></tr></table></figure>
</li>
<li></li>
</ol>
</li>
</ol>
</li>
</ol>
<h3 id="8-5-2-Sending-Signals"><a href="#8-5-2-Sending-Signals" class="headerlink" title="8.5.2 Sending Signals"></a>8.5.2 Sending Signals</h3><ol>
<li><p>Unix signal sending uses <code>process group</code> notion</p>
</li>
<li><p>Process group: </p>
<ol>
<li><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="keyword">pid_t</span> getpgrp(<span class="keyword">void</span>);</span><br><span class="line">Returns: process group ID of calling process</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">setpgid</span><span class="params">(<span class="keyword">pid_t</span> pid, <span class="keyword">pid_t</span> pgid)</span></span>; <span class="comment">// pid = 0, then change current process</span></span><br><span class="line">Returns: <span class="number">0</span> on success, −<span class="number">1</span> on error  <span class="comment">// pgid = 0, then pgid = pid</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>By default, child process are in the same process group of its parent</p>
</li>
</ol>
</li>
<li><p>Sending signals : </p>
<ol>
<li><p>Via <code>kill -[number of signal type] -[pgid] | pid</code></p>
</li>
<li><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">kill</span><span class="params">(<span class="keyword">pid_t</span> pid, <span class="keyword">int</span> sig)</span></span>;</span><br><span class="line">Returns: <span class="number">0</span> <span class="keyword">if</span> OK, −<span class="number">1</span> on error</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>pid</code> &gt; 0, certain pid, <code>pid</code> &lt; 0, every children process</p>
</li>
</ol>
</li>
<li><p>Unix uses job to reference processes created through evaluation of a command,</p>
<ol>
<li>Send <code>SIGINT</code>by keyboard : <code>ctrl + c</code>, <code>SIGTSTP</code> : <code>ctrl + z</code></li>
</ol>
</li>
</ol>
<h3 id="8-5-3-Receiving-Signals"><a href="#8-5-3-Receiving-Signals" class="headerlink" title="8.5.3 Receiving Signals"></a>8.5.3 Receiving Signals</h3><ol>
<li><p>When kernel return from an exception handler, it checks the set of (unblocked &amp; pending) signals, and pick one (usually the smallest) and force process to receive.</p>
</li>
<li><p>Each signal has a <strong><em>predefined default actions</em></strong> : </p>
<ol>
<li><img src="/2019/02/25/csapp/E:/hexo\Hexo_Repository\source\_posts\csapp\1560833381591.png" alt="1560833381591"></li>
<li></li>
</ol>
</li>
<li><p>Use <code>signal</code> to overwrite default action:</p>
<ol>
<li><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">void</span> <span class="params">(*<span class="keyword">sighandler_t</span>)</span><span class="params">(<span class="keyword">int</span>)</span></span>;</span><br><span class="line"><span class="keyword">sighandler_t</span> signal(<span class="keyword">int</span> signum, <span class="keyword">sighandler_t</span> handler);</span><br><span class="line">Returns: ptr to previous handler <span class="keyword">if</span> OK, <span class="function">SIG_ERR on <span class="title">error</span> <span class="params">(does <span class="keyword">not</span> <span class="built_in">set</span> errno)</span></span></span><br></pre></td></tr></table></figure>
</li>
<li><ol>
<li>If handler is <code>SIG_IGN</code>, then signals of type <code>signum</code> are ignored.</li>
<li>If handler is <code>SIG_DFL</code>, then the action for signals of type <code>signum</code>reverts to the default action.</li>
<li>Otherwise, handler is the address of a user-defined function, called a <strong><em>signal handler</em></strong>, that will be called whenever the process receives a signal of type <code>signum</code>. Changing the default action by passing the address of a handler to the signal function is known as <em>installing the handler</em>. The invocation of the handler is called <em>catching the signal</em>. The execution of the handler is referred to as <em>handling the signal</em>.</li>
</ol>
</li>
<li><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"> <span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"csapp.h"</span></span></span><br><span class="line"><span class="number">2</span></span><br><span class="line"><span class="number">3</span> <span class="function"><span class="keyword">void</span> <span class="title">handler</span><span class="params">(<span class="keyword">int</span> sig)</span> <span class="comment">/* SIGINT handler */</span></span></span><br><span class="line"><span class="function">4 </span>&#123;</span><br><span class="line"><span class="number">5</span> <span class="built_in">printf</span>(<span class="string">"Caught SIGINT\n"</span>);</span><br><span class="line"><span class="number">6</span> <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line"><span class="number">7</span> &#125;</span><br><span class="line"><span class="number">8</span></span><br><span class="line"><span class="number">9</span> <span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function">10 </span>&#123;</span><br><span class="line"><span class="number">11</span> <span class="comment">/* Install the SIGINT handler */</span></span><br><span class="line"><span class="number">12</span> <span class="keyword">if</span> (signal(SIGINT, handler) == SIG_ERR)</span><br><span class="line"><span class="number">13</span> unix_error(<span class="string">"signal error"</span>);</span><br><span class="line"><span class="number">14</span></span><br><span class="line"><span class="number">15</span> pause(); <span class="comment">/* Wait for the receipt of a signal */</span></span><br><span class="line"><span class="number">16</span></span><br><span class="line"><span class="number">17</span> <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line"><span class="number">18</span> &#125;</span><br></pre></td></tr></table></figure>
</li>
<li></li>
</ol>
</li>
</ol>
<h3 id="8-5-4-Signal-Handling-Issues"><a href="#8-5-4-Signal-Handling-Issues" class="headerlink" title="8.5.4 Signal Handling Issues"></a>8.5.4 Signal Handling Issues</h3><ol>
<li><p><code>Signal1</code>:</p>
<ol>
<li><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* $begin signal1 */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"csapp.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">handler1</span><span class="params">(<span class="keyword">int</span> sig)</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">pid_t</span> pid;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((pid = waitpid(<span class="number">-1</span>, <span class="literal">NULL</span>, <span class="number">0</span>)) &lt; <span class="number">0</span>)</span><br><span class="line">		unix_error(<span class="string">"waitpid error"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Handler reaped child %d\n"</span>, (<span class="keyword">int</span>)pid);</span><br><span class="line">    Sleep(<span class="number">2</span>);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i, n;</span><br><span class="line">    <span class="keyword">char</span> buf[MAXBUF];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (signal(SIGCHLD, handler1) == SIG_ERR)</span><br><span class="line">		unix_error(<span class="string">"signal error"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Parent creates children */</span></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">3</span>; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (Fork() == <span class="number">0</span>) &#123; </span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"Hello from child %d\n"</span>, (<span class="keyword">int</span>)getpid());</span><br><span class="line">            Sleep(<span class="number">1</span>);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Parent waits for terminal input and then processes it */</span></span><br><span class="line">    <span class="keyword">if</span> ((n = read(STDIN_FILENO, buf, <span class="keyword">sizeof</span>(buf))) &lt; <span class="number">0</span>)</span><br><span class="line">		unix_error(<span class="string">"read"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Parent processing input\n"</span>);</span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>); </span><br><span class="line"></span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* $end signal1 */</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>Only two of the three process reaped</p>
</li>
</ol>
</li>
<li><p><code>Signal2</code>, updated <code>signal handler</code> to reap as much of child process as possible:</p>
<ol>
<li><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* $begin signal2 */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"csapp.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">handler2</span><span class="params">(<span class="keyword">int</span> sig)</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">pid_t</span> pid;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">while</span> ((pid = waitpid(<span class="number">-1</span>, <span class="literal">NULL</span>, <span class="number">0</span>)) &gt; <span class="number">0</span>)</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">"Handler reaped child %d\n"</span>, (<span class="keyword">int</span>)pid);</span><br><span class="line">    <span class="keyword">if</span> (errno != ECHILD) <span class="comment">// when all child process is reaped, errno == ECHILD</span></span><br><span class="line">		unix_error(<span class="string">"waitpid error"</span>);</span><br><span class="line">    Sleep(<span class="number">2</span>);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i, n;</span><br><span class="line">    <span class="keyword">char</span> buf[MAXBUF];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (signal(SIGCHLD, handler2) == SIG_ERR)</span><br><span class="line">	unix_error(<span class="string">"signal error"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Parent creates children */</span></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">3</span>; i++) &#123;</span><br><span class="line">	<span class="keyword">if</span> (Fork() == <span class="number">0</span>) &#123;</span><br><span class="line">	    <span class="built_in">printf</span>(<span class="string">"Hello from child %d\n"</span>, (<span class="keyword">int</span>)getpid());</span><br><span class="line">	    Sleep(<span class="number">1</span>);</span><br><span class="line">	    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">	&#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Parent waits for terminal input and then processes it */</span></span><br><span class="line">    <span class="keyword">if</span> ((n = read(STDIN_FILENO, buf, <span class="keyword">sizeof</span>(buf))) &lt; <span class="number">0</span>)</span><br><span class="line">	unix_error(<span class="string">"read error"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Parent processing input\n"</span>);</span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">	;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* $end signal2 */</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
</li>
<li><p><code>Signal3</code> :</p>
<ol>
<li><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* $begin signal3 */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"csapp.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">handler2</span><span class="params">(<span class="keyword">int</span> sig)</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">pid_t</span> pid;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">while</span> ((pid = waitpid(<span class="number">-1</span>, <span class="literal">NULL</span>, <span class="number">0</span>)) &gt; <span class="number">0</span>)</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">"Handler reaped child %d\n"</span>, (<span class="keyword">int</span>)pid);</span><br><span class="line">    <span class="keyword">if</span> (errno != ECHILD)</span><br><span class="line">		unix_error(<span class="string">"waitpid error"</span>);</span><br><span class="line">    Sleep(<span class="number">2</span>);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i, n;</span><br><span class="line">    <span class="keyword">char</span> buf[MAXBUF];</span><br><span class="line">    <span class="keyword">pid_t</span> pid;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (signal(SIGCHLD, handler2) == SIG_ERR)</span><br><span class="line">		unix_error(<span class="string">"signal error"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Parent creates children */</span></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">3</span>; i++) &#123;</span><br><span class="line">        pid = Fork();</span><br><span class="line">        <span class="keyword">if</span> (pid == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"Hello from child %d\n"</span>, (<span class="keyword">int</span>)getpid());</span><br><span class="line">            Sleep(<span class="number">1</span>);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Manually restart the read call if it is interrupted */</span></span><br><span class="line">    <span class="keyword">while</span> ((n = read(STDIN_FILENO, buf, <span class="keyword">sizeof</span>(buf))) &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">if</span> (errno != EINTR) <span class="comment">// errno == EINTER, if read ends prematurely</span></span><br><span class="line">            unix_error(<span class="string">"read error"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Parent processing input\n"</span>);</span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">	;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* $end signal3 */</span></span><br></pre></td></tr></table></figure>
</li>
<li></li>
</ol>
</li>
</ol>
<h3 id="8-5-5-Portable-Signal-Handling"><a href="#8-5-5-Portable-Signal-Handling" class="headerlink" title="8.5.5 Portable Signal Handling"></a>8.5.5 Portable Signal Handling</h3><ol>
<li><h3 id="8-5-6-Explicitly-Blocking-and-Unblocking-Signals"><a href="#8-5-6-Explicitly-Blocking-and-Unblocking-Signals" class="headerlink" title="8.5.6 Explicitly Blocking and Unblocking Signals"></a>8.5.6 Explicitly Blocking and Unblocking Signals</h3></li>
<li><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sigprocmask</span><span class="params">(<span class="keyword">int</span> how, <span class="keyword">const</span> <span class="keyword">sigset_t</span> *<span class="built_in">set</span>, <span class="keyword">sigset_t</span> *oset)</span></span>;</span><br></pre></td></tr></table></figure>
</li>
<li></li>
</ol>
<h3 id="8-5-7-Synchronizing-Flows-to-Avoid-Nasty-Concurrency-Bugs"><a href="#8-5-7-Synchronizing-Flows-to-Avoid-Nasty-Concurrency-Bugs" class="headerlink" title="8.5.7 Synchronizing Flows to Avoid Nasty Concurrency Bugs"></a>8.5.7 Synchronizing Flows to Avoid Nasty Concurrency Bugs</h3><ol>
<li>Summary : <ol>
<li>Signals sent not received == <code>pending</code>, at most one pending signals</li>
<li>Signal handler blocks same type of signal</li>
</ol>
</li>
</ol>
<h2 id="9-Virtual-Memory"><a href="#9-Virtual-Memory" class="headerlink" title="9. Virtual Memory"></a>9. Virtual Memory</h2><ol>
<li>Virtual memory is abstraction of main memory.<ol>
<li>Uses main memory efficiently as a cache</li>
<li>Simplifies memory management with uniform address space</li>
<li>protects address space of each process from corruption</li>
</ol>
</li>
</ol>
<h3 id="9-1-Physical-and-Virtual-Addressing"><a href="#9-1-Physical-and-Virtual-Addressing" class="headerlink" title="9.1 Physical and Virtual Addressing"></a>9.1 Physical and Virtual Addressing</h3><ol>
<li>Main memory : organized as an array of M contiguous <code>byte-sized</code> cells. Each byte has a unique <code>Physical Address(PA)</code>. Most simple way to access memory would be <code>physical addressing</code><ol>
<li><img src="/2019/02/25/csapp/E:/hexo\Hexo_Repository\source\_posts\csapp\1563751635095.png" alt="Physical Addressing"></li>
</ol>
</li>
<li><code>Virtual Addressing</code> : uses a virtual address, later translated by <code>Memory Management Unit(MMU)</code> to <code>physical address</code><ol>
<li><img src="/2019/02/25/csapp/E:/hexo\Hexo_Repository\source\_posts\csapp\1563751961497.png" alt="1563751961497"></li>
</ol>
</li>
</ol>
<h3 id="9-2-Address-Space"><a href="#9-2-Address-Space" class="headerlink" title="9.2 Address Space"></a>9.2 Address Space</h3><ol>
<li>CPU generates virtual address from an address space of size 2^N, known as virtual address space, N = 32 or 64</li>
</ol>
<h3 id="9-3-VM-as-a-tool-for-caching"><a href="#9-3-VM-as-a-tool-for-caching" class="headerlink" title="9.3 VM as a tool for caching"></a>9.3 VM as a tool for caching</h3><ol>
<li><code>Virtual memory</code> is array of N contiguous bytes stored on <strong>disk</strong>, data cached in <strong>main memory</strong><ol>
<li>Each partitioned block is P = 2^p bytes, <code>virtual pages</code>, <code>physical pages</code></li>
<li><img src="/2019/02/25/csapp/E:/hexo\Hexo_Repository\source\_posts\csapp\1563760011492.png" alt="1563760011492"></li>
</ol>
</li>
<li>Cache in main memory is especially important since read from disk is extremely slow<ol>
<li>DRAM : associative</li>
</ol>
</li>
<li><code>Page table</code> : each page in <code>virtual address space</code> has a <code>page table entry</code> in the <code>page table</code>, page table resides in memory<ol>
<li><img src="/2019/02/25/csapp/E:/hexo\Hexo_Repository\source\_posts\csapp\1563760934847.png" alt="1563760934847"></li>
<li><code>page hit</code>: uses address translation hardware <ol>
<li><img src="/2019/02/25/csapp/E:/hexo\Hexo_Repository\source\_posts\csapp\1563761140726.png" alt="1563761140726"></li>
</ol>
</li>
<li><code>page fault</code> : in VM system, a miss is known as a page fault<ol>
<li><code>page fault handler</code> : receives <code>page fault exception</code>, select victim page and update and handler returns to faulting instruction</li>
<li><img src="/2019/02/25/csapp/E:/hexo\Hexo_Repository\source\_posts\csapp\1563761497450.png" alt="Before page fault"></li>
<li><img src="/2019/02/25/csapp/E:/hexo\Hexo_Repository\source\_posts\csapp\1563761520452.png" alt="After page fault"></li>
<li>Terminology in DRAM caching : <ol>
<li><code>blocks</code> == <code>page</code></li>
<li>transferring a page between disk and memory is called <code>swapping</code> or <code>paging</code>, swap in and swap out</li>
<li><code>demand paging</code> : wait until last moment to swap</li>
</ol>
</li>
</ol>
</li>
<li><code>Allocating pages</code>:<ol>
<li><img src="/2019/02/25/csapp/E:/hexo\Hexo_Repository\source\_posts\csapp\1563761794068.png" alt="1563761794068"></li>
<li>Locality helps </li>
</ol>
</li>
</ol>
</li>
</ol>
<h3 id="9-4-VM-as-a-tool-for-memory-management"><a href="#9-4-VM-as-a-tool-for-memory-management" class="headerlink" title="9.4 VM as a tool for memory management"></a>9.4 VM as a tool for memory management</h3><ol>
<li><img src="/2019/02/25/csapp/E:/hexo\Hexo_Repository\source\_posts\csapp\1563762566741.png" alt="1563762566741"></li>
<li>Benefits : linking, sharing, simplify memory allocation</li>
</ol>
<h3 id="9-5-VM-as-a-tool-for-memory-protection"><a href="#9-5-VM-as-a-tool-for-memory-protection" class="headerlink" title="9.5 VM as a tool for memory protection"></a>9.5 VM as a tool for memory protection</h3><ol>
<li>additional bits added, address translation unit checks : <ol>
<li><img src="/2019/02/25/csapp/E:/hexo\Hexo_Repository\source\_posts\csapp\1563762894345.png" alt="1563762894345"></li>
</ol>
</li>
</ol>
<h3 id="9-6-Address-translation"><a href="#9-6-Address-translation" class="headerlink" title="9.6 Address translation"></a>9.6 Address translation</h3><ol>
<li><strong>address translation</strong> :  mapping between <strong>virtual address</strong> and <strong>physical address</strong></li>
<li><img src="/2019/02/25/csapp/E:/hexo\Hexo_Repository\source\_posts\csapp\1563765783645.png" alt="1563765783645"><ol>
<li><code>PBTR</code> points to current table</li>
<li><code>VPN</code> is index into <code>page table</code></li>
</ol>
</li>
<li><code>page hit</code> : <img src="/2019/02/25/csapp/E:/hexo\Hexo_Repository\source\_posts\csapp\1563766005968.png" alt="1563766005968"><ol>
<li>processor generates <code>virtual address(VPN + VPO)</code> and send it to <code>memory management unit</code></li>
<li><code>MMU</code> generates <code>page table entry address (VPN)</code> to cache</li>
<li>Cache returns <code>page table entry</code> to <code>MMU</code>, generates <code>physical address(PPN + PPO)</code></li>
<li>returns data</li>
</ol>
</li>
<li><code>page fault</code>:<ol>
<li><img src="/2019/02/25/csapp/E:/hexo\Hexo_Repository\source\_posts\csapp\1563766322762.png" alt="1563766322762"></li>
<li>cooperation between kernel(<code>page fault exception handler</code>) and hardware(<code>MMU</code>)</li>
</ol>
</li>
<li><code>Translation lookaside buffer</code>  : a small cache of PTEs in MMU <ol>
<li><img src="/2019/02/25/csapp/E:/hexo\Hexo_Repository\source\_posts\csapp\1563766731916.png" alt="1563766731916"></li>
<li><img src="/2019/02/25/csapp/E:/hexo\Hexo_Repository\source\_posts\csapp\1563766826752.png" alt="1563766826752"></li>
<li><img src="/2019/02/25/csapp/E:/hexo\Hexo_Repository\source\_posts\csapp\1563767460550.png" alt="2-level page table"><ol>
<li>Imagine 32-bit virtual address space, 4kb per page, 1M page, level 1 consists of 1K PTE, each level 1 with 1K PTE, each level 2 with a 4kb page</li>
<li>K-level hierarchy : <ol>
<li><img src="/2019/02/25/csapp/E:/hexo\Hexo_Repository\source\_posts\csapp\1563767825001.png" alt="1563767825001"></li>
</ol>
</li>
</ol>
</li>
</ol>
</li>
</ol>
<h3 id="9-7-Case-study-The-intel-Corei7-Linux-memory-system"><a href="#9-7-Case-study-The-intel-Corei7-Linux-memory-system" class="headerlink" title="9.7 Case study : The intel Corei7/Linux memory system"></a>9.7 Case study : The intel Corei7/Linux memory system</h3><ol>
<li>Core i7 has 4 cores:<ol>
<li><img src="/2019/02/25/csapp/E:/hexo\Hexo_Repository\source\_posts\csapp\1563776600389.png" alt="1563776600389"></li>
</ol>
</li>
<li>Core i7 Address translation:<ol>
<li><img src="/2019/02/25/csapp/E:/hexo\Hexo_Repository\source\_posts\csapp\1563777930990.png" alt="1563777930990"></li>
<li>4 - level page table hierarchy:<ol>
<li><img src="/2019/02/25/csapp/E:/hexo\Hexo_Repository\source\_posts\csapp\1563778655082.png" alt="1563778655082"></li>
</ol>
</li>
<li>Linux Virtual Memory System:<ol>
<li><img src="/2019/02/25/csapp/E:/hexo\Hexo_Repository\source\_posts\csapp\1563778926907.png" alt="1563778926907"></li>
<li>Linux maintains separate virtual address space for each process</li>
<li>Linux organize virtual memory as a collection of areas(a.k.a segments)</li>
<li>Kernel keeps a distinct data structure <code>task_struct</code> for each process<ol>
<li><img src="/2019/02/25/csapp/E:/hexo\Hexo_Repository\source\_posts\csapp\1563779517929.png" alt="Linux kernel stores process context"></li>
<li><img src="/2019/02/25/csapp/E:/hexo\Hexo_Repository\source\_posts\csapp\1563779590515.png" alt="Linux page fault handler"></li>
</ol>
</li>
</ol>
</li>
</ol>
</li>
</ol>
<pre><code>### 9.8 Memory Mapping
</code></pre><ol>
<li>Memory mapping : VM areas init by associating with disk objects, that is to say integrated with file system</li>
</ol>
<h4 id="9-8-1-Shared-Objects-Revisited"><a href="#9-8-1-Shared-Objects-Revisited" class="headerlink" title="9.8.1 Shared Objects Revisited"></a>9.8.1 Shared Objects Revisited</h4><ol>
<li><p>An object can be mapped into virtual memory either as <code>private</code> or <code>shared</code></p>
<ol>
<li><p><code>shared</code> : </p>
<ol>
<li><img src="/2019/02/25/csapp/E:/hexo\Hexo_Repository\source\_posts\csapp\1563783631648.png" alt="1563783631648"></li>
</ol>
</li>
<li><p><code>Private</code> : defer write to the end of world</p>
<ol>
<li></li>
<li><img src="/2019/02/25/csapp/E:/hexo\Hexo_Repository\source\_posts\csapp\1563783980026.png" alt="1563783980026"></li>
</ol>
</li>
<li><p><code>Fork</code> : uses <code>copy-on-write</code> technique as well</p>
</li>
<li><p><code>MMAP</code> : map an object denoted as <code>int fd</code>, starting from <code>offset</code> with <code>length</code>, mapped area starts at <code>void *start</code>(Can be set as <code>null</code> so that automatically determined), some other arguments <code>prot</code>, access permission, <code>flag</code>for file type</p>
<ol>
<li><code>prot</code> : <code>PROT_EXEC</code> , <code>PROT_READ</code>, <code>PROT_WRITE</code>, <code>PROT_NONE</code>, must not conflict with <code>open mode</code></li>
<li><code>flag</code> : <ol>
<li><code>MAP_PRIVATE</code> : copy on write </li>
<li><code>MAP_SHARED</code> : updates carried through to underlying files</li>
</ol>
</li>
</ol>
</li>
<li><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">mmap</span><span class="params">(<span class="keyword">void</span> *start, <span class="keyword">size_t</span> length, <span class="keyword">int</span> prot, <span class="keyword">int</span> flags,</span></span></span><br><span class="line"><span class="function"><span class="params"><span class="keyword">int</span> fd, <span class="keyword">off_t</span> offset)</span></span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">munmap</span><span class="params">(<span class="keyword">void</span> *start, <span class="keyword">size_t</span> length)</span></span>;</span><br></pre></td></tr></table></figure>
</li>
<li></li>
<li></li>
</ol>
</li>
</ol>
<h3 id="9-9-Dynamic-Memory-Allocation"><a href="#9-9-Dynamic-Memory-Allocation" class="headerlink" title="9.9 Dynamic Memory Allocation"></a>9.9 Dynamic Memory Allocation</h3><ol>
<li>Why dynamic ? Coz size is determined only in run time</li>
<li>Dynamic allocator maintains area of virtual memory called <code>heap</code><ol>
<li><img src="/2019/02/25/csapp/E:/hexo\Hexo_Repository\source\_posts\csapp\1563788820191.png" alt="1563788820191"></li>
</ol>
</li>
<li>Allocator type : <ol>
<li><code>Explicit allocator</code> : requires application to free allocated block</li>
<li><code>Implicit allocator(garbage collector)</code> : allocator detects and removes</li>
</ol>
</li>
</ol>
<h4 id="9-9-1-The-malloc-and-free-functions"><a href="#9-9-1-The-malloc-and-free-functions" class="headerlink" title="9.9.1 The malloc and free functions"></a>9.9.1 The malloc and free functions</h4><ol>
<li><code>malloc(int size)</code> returns pointer to start of at least <code>size</code> bytes, in Unix malloc is 8-byte aligned(each malloc uses at least 2 words)</li>
<li><code>calloc()</code> init to zero</li>
<li><code>sbrk(int size)</code> : move <code>brk</code> upward size bytes</li>
</ol>
<h4 id="9-9-2-Why-dynamic-memory-allocation"><a href="#9-9-2-Why-dynamic-memory-allocation" class="headerlink" title="9.9.2 Why dynamic memory allocation"></a>9.9.2 Why dynamic memory allocation</h4><ol>
<li>Size is not determined until runtime</li>
</ol>
<h4 id="9-9-3-Allocator-requirements-and-goal"><a href="#9-9-3-Allocator-requirements-and-goal" class="headerlink" title="9.9.3 Allocator requirements and goal"></a>9.9.3 Allocator requirements and goal</h4><ol>
<li>Performance measure : <ol>
<li><code>Throughput</code> : Number of requests performed per unit time</li>
<li><code>Utilization</code> : <code>peak utilization</code> </li>
</ol>
</li>
</ol>
<h4 id="9-9-4-Fragmentation"><a href="#9-9-4-Fragmentation" class="headerlink" title="9.9.4 Fragmentation"></a>9.9.4 Fragmentation</h4><ol>
<li><code>internal fragmentation</code></li>
<li><code>external fragmentation</code> : enough free bytes, but cannot allocate block</li>
</ol>
<h4 id="9-9-5-Implementation-issues"><a href="#9-9-5-Implementation-issues" class="headerlink" title="9.9.5 Implementation issues"></a>9.9.5 Implementation issues</h4><ol>
<li><code>Free block organization</code></li>
<li><code>Placement</code></li>
<li><code>Splitting</code></li>
<li><code>coalescing</code></li>
</ol>
<h4 id="9-9-6-Implicit-free-list"><a href="#9-9-6-Implicit-free-list" class="headerlink" title="9.9.6 Implicit free list"></a>9.9.6 Implicit free list</h4><ol>
<li>Any allocator needs to distinguish between block boundaries and free block. Most embed such info inside heap</li>
<li><img src="/2019/02/25/csapp/E:/hexo\Hexo_Repository\source\_posts\csapp\1563844561570.png" alt="1563844561570"></li>
<li><img src="/2019/02/25/csapp/E:/hexo\Hexo_Repository\source\_posts\csapp\1563846132235.png" alt="1563846132235"></li>
</ol>
<h4 id="9-9-7-Placing-Allocated-Blocks"><a href="#9-9-7-Placing-Allocated-Blocks" class="headerlink" title="9.9.7 Placing Allocated Blocks"></a>9.9.7 Placing Allocated Blocks</h4><ol>
<li><code>first fit</code> : </li>
<li><code>next fit</code>  : continues search where previous search stops</li>
<li><code>best fit</code></li>
<li></li>
</ol>
<h4 id="9-9-8-Splitting-Free-Blocks"><a href="#9-9-8-Splitting-Free-Blocks" class="headerlink" title="9.9.8 Splitting Free Blocks"></a>9.9.8 Splitting Free Blocks</h4><h4 id="9-9-9-Getting-Additional-Heap-Memory"><a href="#9-9-9-Getting-Additional-Heap-Memory" class="headerlink" title="9.9.9 Getting Additional Heap Memory"></a>9.9.9 Getting Additional Heap Memory</h4><ol>
<li><h4 id="9-9-10-Coalescing-free-blocks"><a href="#9-9-10-Coalescing-free-blocks" class="headerlink" title="9.9.10 Coalescing free blocks"></a>9.9.10 Coalescing free blocks</h4></li>
<li><p><code>false fragmentation</code> : free blocks adjacent</p>
</li>
<li><code>immediate coalescing</code></li>
<li><code>defer coalescing</code> </li>
</ol>
<h4 id="9-9-11-Coalescing-with-Boundary-Tags"><a href="#9-9-11-Coalescing-with-Boundary-Tags" class="headerlink" title="9.9.11 Coalescing with Boundary Tags"></a>9.9.11 Coalescing with Boundary Tags</h4><ol>
<li><img src="/2019/02/25/csapp/E:/hexo\Hexo_Repository\source\_posts\csapp\1563847297212.png" alt="1563847297212"></li>
<li></li>
</ol>
<h4 id="9-9-13-Explicit-free-lists"><a href="#9-9-13-Explicit-free-lists" class="headerlink" title="9.9.13 Explicit free lists"></a>9.9.13 Explicit free lists</h4><ol>
<li>Uses free blocks to store links, works like deque</li>
</ol>
<h4 id="9-9-14-Segregated-Free-Lists"><a href="#9-9-14-Segregated-Free-Lists" class="headerlink" title="9.9.14 Segregated Free Lists"></a>9.9.14 Segregated Free Lists</h4><ol>
<li></li>
</ol>
<h3 id="9-10-Garbage-Collection"><a href="#9-10-Garbage-Collection" class="headerlink" title="9.10 Garbage Collection"></a>9.10 Garbage Collection</h3><ol>
<li></li>
</ol>
<h4 id="9-10-1-Garbage-Collector-Basics"><a href="#9-10-1-Garbage-Collector-Basics" class="headerlink" title="9.10.1 Garbage Collector Basics"></a>9.10.1 Garbage Collector Basics</h4><ol>
<li>Views memory as a <strong><em>directed reachability graph</em></strong> </li>
<li><img src="/2019/02/25/csapp/E:/hexo\Hexo_Repository\source\_posts\csapp\1563850674809.png" alt="1563850674809"><ol>
<li>Root nodes : global variables, variables on stack</li>
</ol>
</li>
<li><img src="/2019/02/25/csapp/E:/hexo\Hexo_Repository\source\_posts\csapp\1563850882406.png" alt="1563850882406"></li>
</ol>
<h4 id="9-10-2-Mark-amp-Sweep-Garbage-Collectors"><a href="#9-10-2-Mark-amp-Sweep-Garbage-Collectors" class="headerlink" title="9.10.2 Mark&amp;Sweep Garbage Collectors"></a>9.10.2 Mark&amp;Sweep Garbage Collectors</h4><ol>
<li><p>Can integrate with malloc/free package : </p>
<ol>
<li><p><code>Mark</code> : start at root nodes and set each reachable block as marked</p>
<ol>
<li><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">(a) mark function</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">mark</span><span class="params">(ptr p)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> ((b = isPtr(p)) == <span class="literal">NULL</span>)</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">    <span class="keyword">if</span> (blockMarked(b))</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">    markBlock(b);</span><br><span class="line">    len = length(b);</span><br><span class="line">    <span class="keyword">for</span> (i=<span class="number">0</span>; i &lt; len; i++)</span><br><span class="line">    mark(b[i]);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
</li>
<li><p><code>Sweep</code> : scan all blocks</p>
<ol>
<li><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">(b) sweep function</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sweep</span><span class="params">(ptr b, ptr end)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">while</span> (b &lt; end) &#123;</span><br><span class="line">    <span class="keyword">if</span> (blockMarked(b))</span><br><span class="line">    unmarkBlock(b);</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (blockAllocated(b))</span><br><span class="line">    <span class="built_in">free</span>(b);</span><br><span class="line">    b = nextBlock(b);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
</li>
</ol>
</li>
<li><p><img src="/2019/02/25/csapp/E:/hexo\Hexo_Repository\source\_posts\csapp\1563852372009.png" alt="1563852372009"></p>
</li>
</ol>
<p>​    </p>
<h2 id="10-System-level-I-O"><a href="#10-System-level-I-O" class="headerlink" title="10. System-level I/O"></a>10. System-level I/O</h2><ol>
<li><p><img src="/2019/02/25/csapp/E:/hexo\Hexo_Repository\source\_posts\csapp\1563632301500.png" alt="1563632301500"></p>
</li>
<li><p>Unix overview :</p>
<ol>
<li><p>A Linux file is a sequence of m bytes : <code>B_0, B_1 ...</code></p>
</li>
<li><p>All I/O devices are represented as files</p>
</li>
<li><p>Such mapping allows kernel to support :</p>
<ol>
<li><code>open(), close(), read(), write(), lseek()</code></li>
</ol>
</li>
<li><p>File types :</p>
<ol>
<li><code>Regular file</code> : arbitrary data<ol>
<li><code>text file</code> and <code>binary file</code><ol>
<li>Text file : ending with <code>\n 0xa</code> (Linux and Mac-os) , <code>\r \n 0xd 0xa</code>(Carriage return and line feed)</li>
</ol>
</li>
</ol>
</li>
<li><code>Directory</code> : index for a related group of files<br>1. </li>
<li><code>Socket</code> : for communication with other machine</li>
<li>Other won’t discuss : <code>Named Pipes</code>, <code>Symbolic links</code>, <code>Character</code></li>
</ol>
</li>
<li><p>Opening files:</p>
<ol>
<li><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> fd; <span class="comment">// file descriptor</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>((fd = open(<span class="string">"/etc/hosts"</span>, O_RDONLY)) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    perror(<span class="string">"open"</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">open</span><span class="params">(<span class="keyword">char</span>* path, <span class="keyword">int</span> mode)</span></span>; <span class="comment">// return fd upon success</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>Each process begin with 3 fd :</p>
<ol>
<li>0 : standard input (referred as <code>stdin</code>)</li>
<li>1 : standard output (referred as <code>stdout</code>)</li>
<li>2 : standard error (referred as <code>stderr</code>)</li>
</ol>
</li>
</ol>
</li>
<li><p>Closing file : </p>
<ol>
<li><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> fd, retval;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(retval = close(fd) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    perror(<span class="string">"close"</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>Closing already closed file is a disaster in threaded program</p>
</li>
</ol>
</li>
<li><p>Reading file :</p>
<ol>
<li><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">char</span> buf[<span class="number">512</span>];</span><br><span class="line"><span class="keyword">int</span> fd;</span><br><span class="line"><span class="keyword">int</span> nbytes;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(nbytes = read(fd, buf, <span class="keyword">sizeof</span>(buf)) &lt; <span class="number">0</span> )&#123;</span><br><span class="line">    perror(<span class="string">"read"</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">read</span><span class="params">(<span class="keyword">int</span> fd, <span class="keyword">void</span>* usrbuf, <span class="keyword">int</span> length)</span></span></span><br></pre></td></tr></table></figure>
</li>
<li><p><code>read()</code> returns number of bytes read;</p>
</li>
<li><p><code>short count</code> happens, when <code>nbytes &lt; sizeof(buf)</code></p>
</li>
</ol>
</li>
<li><p>Writing file :</p>
<ol>
<li><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">char</span> buf[<span class="number">512</span>];</span><br><span class="line"><span class="keyword">int</span> fd; <span class="comment">/* file descriptor */</span></span><br><span class="line"><span class="keyword">int</span> nbytes; <span class="comment">/* number of bytes read */</span></span><br><span class="line"><span class="comment">/* Open the file fd ... */</span></span><br><span class="line"><span class="comment">/* Then write up to 512 bytes from buf to file fd */</span></span><br><span class="line"><span class="keyword">if</span> ((nbytes = write(fd, buf, <span class="keyword">sizeof</span>(buf)) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">	perror(<span class="string">"write"</span>);</span><br><span class="line">	<span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>Return number of bytes written from buffer to file <code>fd</code></p>
</li>
</ol>
</li>
<li><p>Short counts :</p>
<ol>
<li>Happens in : <ol>
<li>Encounter <code>EOF</code> in read</li>
<li>Reading text lines from terminal</li>
<li>Reading and writing network sockets</li>
</ol>
</li>
<li>Never happen :<ol>
<li>Read/write from disk</li>
</ol>
</li>
</ol>
</li>
<li><p>CMU RIO package:</p>
<ol>
<li><p>Why is it <code>robust</code> ? </p>
<ol>
<li><code>thread-safe</code></li>
</ol>
</li>
<li><p>Unbuffered RIO input and output:</p>
<ol>
<li><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"csapp.h"</span></span></span><br><span class="line"><span class="keyword">ssize_t</span> rio_readn(<span class="keyword">int</span> fd, <span class="keyword">void</span> *usrbuf, <span class="keyword">size_t</span> n);</span><br><span class="line"><span class="keyword">ssize_t</span> rio_writen(<span class="keyword">int</span> fd, <span class="keyword">void</span> *usrbuf, <span class="keyword">size_t</span> n);</span><br><span class="line"> Return: num. bytes transferred if OK, 0 on EOF (rio_readn only), -1 on error</span><br></pre></td></tr></table></figure>
</li>
<li><p>Works well interleavingly </p>
</li>
<li><p>Implementation :</p>
<ol>
<li><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* rio_readn - Robustly read n bytes (unbuffered)</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">ssize_t</span> rio_readn(<span class="keyword">int</span> fd, <span class="keyword">void</span> *usrbuf, <span class="keyword">size_t</span> n)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">size_t</span> nleft = n;</span><br><span class="line">    <span class="keyword">ssize_t</span> nread;</span><br><span class="line">    <span class="keyword">char</span> *bufp = usrbuf;</span><br><span class="line"> 	<span class="keyword">while</span> (nleft &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    	<span class="keyword">if</span> ((nread = read(fd, bufp, nleft)) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (errno == EINTR) <span class="comment">/* Interrupted by sig handler return */</span></span><br><span class="line">        	nread = <span class="number">0</span>; <span class="comment">/* and call read() again */</span></span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        	<span class="keyword">return</span> <span class="number">-1</span>; <span class="comment">/* errno set by read() */</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (nread == <span class="number">0</span>)</span><br><span class="line">    	<span class="keyword">break</span>; <span class="comment">/* EOF */</span></span><br><span class="line">    nleft -= nread;</span><br><span class="line">    bufp += nread;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> (n - nleft); <span class="comment">/* Return &gt;= 0 */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
</li>
</ol>
</li>
<li><p>Buffered RIO :</p>
<ol>
<li><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"csapp.h"</span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">rio_readinitb</span><span class="params">(<span class="keyword">rio_t</span> *rp, <span class="keyword">int</span> fd)</span></span>;</span><br><span class="line"><span class="keyword">ssize_t</span> rio_readlineb(<span class="keyword">rio_t</span> *rp, <span class="keyword">void</span> *usrbuf, <span class="keyword">size_t</span> maxlen);</span><br><span class="line"><span class="keyword">ssize_t</span> rio_readnb(<span class="keyword">rio_t</span> *rp, <span class="keyword">void</span> *usrbuf, <span class="keyword">size_t</span> n);</span><br><span class="line"> 	Return: num. bytes read <span class="keyword">if</span> OK, <span class="number">0</span> on EOF, <span class="number">-1</span> on error</span><br></pre></td></tr></table></figure>
</li>
<li><p>Stops only when <code>EOF</code> encountered, <strong><em>thread-safe</em></strong></p>
</li>
<li><p>Implementation : </p>
<ol>
<li><p><img src="/2019/02/25/csapp/E:/hexo\Hexo_Repository\source\_posts\csapp\1563636975851.png" alt="1563636975851"></p>
</li>
<li><p><img src="/2019/02/25/csapp/E:/hexo\Hexo_Repository\source\_posts\csapp\1563637039885.png" alt="1563637039885"></p>
</li>
<li><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line"> <span class="keyword">int</span> rio_fd; <span class="comment">/* descriptor for this internal buf */</span></span><br><span class="line"> <span class="keyword">int</span> rio_cnt; <span class="comment">/* unread bytes in internal buf */</span></span><br><span class="line"> <span class="keyword">char</span> *rio_bufptr; <span class="comment">/* next unread byte in internal buf */</span></span><br><span class="line"> <span class="keyword">char</span> rio_buf[RIO_BUFSIZE]; <span class="comment">/* internal buffer */</span></span><br><span class="line">&#125; <span class="keyword">rio_t</span>;</span><br></pre></td></tr></table></figure>
</li>
<li><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ssize_t</span> rio_readn(<span class="keyword">int</span> fd, <span class="keyword">void</span> *usrbuf, <span class="keyword">size_t</span> n) </span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">size_t</span> nleft = n;</span><br><span class="line">    <span class="keyword">ssize_t</span> nread;</span><br><span class="line">    <span class="keyword">char</span> *bufp = usrbuf;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (nleft &gt; <span class="number">0</span>) &#123;</span><br><span class="line">	<span class="keyword">if</span> ((nread = read(fd, bufp, nleft)) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">	    <span class="keyword">if</span> (errno == EINTR) <span class="comment">/* Interrupted by sig handler return */</span></span><br><span class="line">		nread = <span class="number">0</span>;      <span class="comment">/* and call read() again */</span></span><br><span class="line">	    <span class="keyword">else</span></span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;      <span class="comment">/* errno set by read() */</span> </span><br><span class="line">	&#125; </span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (nread == <span class="number">0</span>)</span><br><span class="line">	    <span class="keyword">break</span>;              <span class="comment">/* EOF */</span></span><br><span class="line">	nleft -= nread;</span><br><span class="line">	bufp += nread;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> (n - nleft);         <span class="comment">/* Return &gt;= 0 */</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">ssize_t</span> rio_writen(<span class="keyword">int</span> fd, <span class="keyword">void</span> *usrbuf, <span class="keyword">size_t</span> n) </span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">size_t</span> nleft = n;</span><br><span class="line">    <span class="keyword">ssize_t</span> nwritten;</span><br><span class="line">    <span class="keyword">char</span> *bufp = usrbuf;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (nleft &gt; <span class="number">0</span>) &#123;</span><br><span class="line">	<span class="keyword">if</span> ((nwritten = write(fd, bufp, nleft)) &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">	    <span class="keyword">if</span> (errno == EINTR)  <span class="comment">/* Interrupted by sig handler return */</span></span><br><span class="line">		nwritten = <span class="number">0</span>;    <span class="comment">/* and call write() again */</span></span><br><span class="line">	    <span class="keyword">else</span></span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;       <span class="comment">/* errno set by write() */</span></span><br><span class="line">	&#125;</span><br><span class="line">	nleft -= nwritten;</span><br><span class="line">	bufp += nwritten;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> n;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li></li>
</ol>
</li>
</ol>
</li>
</ol>
</li>
<li><p>Standard I/O : opens file as a stream(abstraction for a <code>fd</code> and <code>buffer</code>)</p>
<ol>
<li><p><code>puts</code> , <code>gets</code></p>
</li>
<li><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">fputs</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span>* str, FILE * stream)</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">fgets</span><span class="params">(<span class="keyword">char</span>* s, <span class="keyword">int</span> n, FILE* stream)</span></span></span><br></pre></td></tr></table></figure>
</li>
<li><p>Difference with <code>Unix I/O</code> : </p>
<ol>
<li><code>Unix</code> uses <code>file descriptor</code> (opened by <code>open</code>)</li>
<li><code>Standard I/O</code> uses <code>FILE a.k.a stream</code></li>
</ol>
</li>
<li><p>Expensive to use Unix I/O, better use buffer</p>
</li>
</ol>
</li>
<li><p>Which I/O to use ? </p>
<ol>
<li>Unix I/O : async-signal-safe, access metadata, short counts</li>
<li>Disk/terminal : standard I/O</li>
<li>Inside signal handler : unix I/O</li>
<li>Sockets : RIO</li>
</ol>
</li>
<li><p>How Unix Kernel represents Open files:</p>
<ol>
<li>Descriptor table : owned by each process<ol>
<li><img src="/2019/02/25/csapp/E:/hexo\Hexo_Repository\source\_posts\csapp\1563697958177.png" alt="1563697958177"></li>
<li><img src="/2019/02/25/csapp/E:/hexo\Hexo_Repository\source\_posts\csapp\1563699189182.png" alt="1563699189182"></li>
<li>I/O redirection : <code>dup2(int oldfd, int newfd)</code></li>
</ol>
</li>
</ol>
</li>
<li><p>Accessing metadata : </p>
<ol>
<li><img src="/2019/02/25/csapp/E:/hexo\Hexo_Repository\source\_posts\csapp\1563723325660.png" alt="1563723325660"></li>
<li><code>stat fstat</code></li>
</ol>
</li>
</ol>
</li>
</ol>
<h2 id="11-Network-Programming"><a href="#11-Network-Programming" class="headerlink" title="11 Network Programming"></a>11 Network Programming</h2><ol>
<li>Every network application is based on the client-server model.</li>
</ol>
<h3 id="11-1-The-Client-server-programming-model"><a href="#11-1-The-Client-server-programming-model" class="headerlink" title="11.1 The Client-server programming model"></a>11.1 The Client-server programming model</h3><ol>
<li><p>Within C/S model, one <em>server</em> process and one or more <em>client</em> process</p>
<ol>
<li><code>server</code> manages resources and provides some <code>service</code> to <code>client</code> via <code>sources</code></li>
</ol>
</li>
</ol>
<ol start="2">
<li><p><code>Transaction</code> ： </p>
<ol>
<li><img src="/2019/02/25/csapp/E:/hexo\Hexo_Repository\source\_posts\csapp\1563853815998.png" alt="1563853815998"></li>
</ol>
</li>
</ol>
<h3 id="11-2-Networks"><a href="#11-2-Networks" class="headerlink" title="11.2 Networks"></a>11.2 Networks</h3><ol>
<li>Clients and servers often run on separate hosts and communicate using the hardware and software resources known as <code>computer network</code><ol>
<li>To host, network is just another I/O device<ol>
<li><img src="/2019/02/25/csapp/E:/hexo\Hexo_Repository\source\_posts\csapp\1563854246085.png" alt="1563854246085"></li>
</ol>
</li>
<li>Network is hierarchical , <ol>
<li><code>Local Area Net</code> is the lowest level, tech known as <code>Ethernet</code></li>
<li><code>Ethernet segment</code> consists of wire and a hub, wire attaches to one end of host and one port on hub<ol>
<li><img src="/2019/02/25/csapp/E:/hexo\Hexo_Repository\source\_posts\csapp\1563854464651.png" alt="1563854464651"></li>
</ol>
</li>
<li><code>bridged Ethernet segment</code> <ol>
<li><img src="/2019/02/25/csapp/E:/hexo\Hexo_Repository\source\_posts\csapp\1563854729008.png" alt="1563854729008"></li>
<li><code>bridges</code> more intelligent </li>
</ol>
</li>
<li>At higher level, specialized computer <code>router</code> can connect incompatible <code>LAN</code><ol>
<li><code>WAN</code> Each router has an adapter(port) for each network that it is connected to.</li>
<li><img src="/2019/02/25/csapp/E:/hexo\Hexo_Repository\source\_posts\csapp\1563856908510.png" alt="1563856908510"></li>
<li>How do we ensure data integrity?<ol>
<li>A layer of <code>protocol software</code>:<ol>
<li><code>Naming scheme</code> : different ways to assign address for hosts, protocol provides uniform scheme to name an address and assign at least one for each hoss</li>
<li><code>Delivery mechansim</code> : encode data in uniform way <code>packets</code>, consists of a <code>header</code>(size and src, dest address), <code>payload</code></li>
</ol>
</li>
</ol>
</li>
</ol>
</li>
<li>How protocol works?<ol>
<li><img src="/2019/02/25/csapp/E:/hexo\Hexo_Repository\source\_posts\csapp\1563864397707.png" alt="1563864397707"></li>
<li><code>protocol software</code> appends <code>Ph</code> and <code>FH1</code></li>
<li><code>router</code> finds destination host B and swap <code>FH2</code></li>
</ol>
</li>
</ol>
</li>
</ol>
</li>
</ol>
<h3 id="11-3-Global-IP-Internet"><a href="#11-3-Global-IP-Internet" class="headerlink" title="11.3 Global IP Internet"></a>11.3 Global IP Internet</h3><ol>
<li><img src="/2019/02/25/csapp/E:/hexo\Hexo_Repository\source\_posts\csapp\1563864914850.png" alt="1563864914850"><ol>
<li>TCP/IP protocol, supported by every modern system<ol>
<li><code>socket</code>, implemented as system calls, trap into kernel and call kernel func</li>
<li><code>TCP/IP</code> is actually a family, <code>IP</code> : naming scheme, <code>UDP</code> :datagram</li>
</ol>
</li>
</ol>
</li>
<li>Internet properties : <ol>
<li>set of hosts is mapped a set of 32-bit IP address</li>
<li>IP address mapped to <code>Internet domain name</code></li>
<li>A process on host can communicate with any other process over a <code>connection</code></li>
</ol>
</li>
</ol>
<h4 id="11-3-1-IP-Address"><a href="#11-3-1-IP-Address" class="headerlink" title="11.3.1 IP Address"></a>11.3.1 IP Address</h4><ol>
<li><p>32-bit unsigned integer, stored in <code>IP address structure</code>:</p>
<ol>
<li><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Internet address structure */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">in_addr</span> &#123;</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> s_addr; <span class="comment">/* Network byte order (big-endian) */</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">int</span> <span class="title">htonl</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">int</span> hostlong)</span></span>; <span class="comment">// host to network, in long int  32bit</span></span><br><span class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">short</span> <span class="keyword">int</span> <span class="title">htons</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">short</span> <span class="keyword">int</span> hostshort)</span></span>; <span class="comment">// host to network, in short int 16bit</span></span><br><span class="line">Returns: value in network byte order</span><br><span class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">int</span> <span class="title">ntohl</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">int</span> netlong)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">short</span> <span class="keyword">int</span> <span class="title">ntohs</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">short</span> <span class="keyword">int</span> netshort)</span></span>;</span><br><span class="line">Returns: value in host byte order</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">inet_aton</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *cp, struct in_addr *inp)</span></span>; <span class="comment">// application to network</span></span><br><span class="line">Returns: <span class="number">1</span> <span class="keyword">if</span> OK, <span class="number">0</span> on error</span><br><span class="line"><span class="function"><span class="keyword">char</span> *<span class="title">inet_ntoa</span><span class="params">(struct in_addr in)</span></span>; <span class="comment">// int to string</span></span><br><span class="line">Returns: pointer to a dotted-decimal <span class="built_in">string</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
</li>
</ol>
<h4 id="11-3-2-Internet-Domain-Names"><a href="#11-3-2-Internet-Domain-Names" class="headerlink" title="11.3.2 Internet Domain Names"></a>11.3.2 Internet Domain Names</h4><ol>
<li><p>Mapping between domain name and IP address used to be down in <code>host.txt</code>, now by distributed database <code>Domain Name System</code></p>
<ol>
<li><p><code>DNS</code> stores following <code>struct</code> :</p>
<ol>
<li><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* DNS host entry structure */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">hostent</span> &#123;</span></span><br><span class="line">    <span class="keyword">char</span> *h_name; <span class="comment">/* Official domain name of host */</span></span><br><span class="line">    <span class="keyword">char</span> **h_aliases; <span class="comment">/* Null-terminated array of domain names */</span></span><br><span class="line">    <span class="keyword">int</span> h_addrtype; <span class="comment">/* Host address type (AF_INET) */</span></span><br><span class="line">    <span class="keyword">int</span> h_length; <span class="comment">/* Length of an address, in bytes */</span></span><br><span class="line">    <span class="keyword">char</span> **h_addr_list; <span class="comment">/* Null-terminated array of in_addr structs */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
</li>
</ol>
</li>
<li><p>Applications use :</p>
<ol>
<li><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netdb.h&gt;</span></span></span><br><span class="line"><span class="function">struct hostent *<span class="title">gethostbyname</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *name)</span></span>;</span><br><span class="line">Returns: non-<span class="literal">NULL</span> pointer <span class="keyword">if</span> OK, <span class="literal">NULL</span> pointer on error with h_errno <span class="built_in">set</span></span><br><span class="line"><span class="function">struct hostent *<span class="title">gethostbyaddr</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *addr, <span class="keyword">int</span> len, <span class="number">0</span>)</span></span>;</span><br><span class="line">Returns: non-<span class="literal">NULL</span> pointer <span class="keyword">if</span> OK, <span class="literal">NULL</span> pointer on error with h_errno <span class="built_in">set</span></span><br></pre></td></tr></table></figure>
</li>
<li><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* $begin hostinfo */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"csapp.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> **pp;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">in_addr</span> <span class="title">addr</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">hostent</span> *<span class="title">hostp</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (argc != <span class="number">2</span>) &#123;</span><br><span class="line">		<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"usage: %s &lt;domain name or dotted-decimal&gt;\n"</span>, 		           argv[<span class="number">0</span>]);</span><br><span class="line">		<span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (inet_aton(argv[<span class="number">1</span>], &amp;addr) != <span class="number">0</span>) </span><br><span class="line">	hostp = Gethostbyaddr((<span class="keyword">const</span> <span class="keyword">char</span> *)&amp;addr, <span class="keyword">sizeof</span>(addr), AF_INET); </span><br><span class="line">    <span class="keyword">else</span>                                </span><br><span class="line">	hostp = Gethostbyname(argv[<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"official hostname: %s\n"</span>, hostp-&gt;h_name);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (pp = hostp-&gt;h_aliases; *pp != <span class="literal">NULL</span>; pp++)</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"alias: %s\n"</span>, *pp);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (pp = hostp-&gt;h_addr_list; *pp != <span class="literal">NULL</span>; pp++) &#123;</span><br><span class="line">	addr.s_addr = ((struct in_addr *)*pp)-&gt;s_addr;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"address: %s\n"</span>, inet_ntoa(addr));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* $end hostinfo */</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><code>localhost</code> is <code>127.0.0.1</code></p>
</li>
</ol>
</li>
</ol>
</li>
</ol>
<h4 id="11-3-3-Internet-Connections"><a href="#11-3-3-Internet-Connections" class="headerlink" title="11.3.3 Internet Connections"></a>11.3.3 Internet Connections</h4><ol>
<li>Clients and servers communicate through sending and receiving streams of bytes over <code>connections</code> with characteristics : <ol>
<li><code>point to point</code> :connects a pair of process</li>
<li><code>fully duplex</code> : flow in both directions at the same time </li>
</ol>
</li>
<li><code>socket</code> : endpoint of a <code>connection</code><ol>
<li><code>socket address</code> : <code>Internet address</code> + <code>16bit port</code></li>
<li><code>connection</code> uniquely identified by two endpoint <code>sockets</code>, <ol>
<li><code>socket pair</code>: <code>(cliaddr:cliport, servaddr:servport)</code></li>
<li><code>ephemeral port</code> : client port</li>
<li><img src="/2019/02/25/csapp/E:/hexo\Hexo_Repository\source\_posts\csapp\1563875014665.png" alt="1563875014665"></li>
</ol>
</li>
</ol>
</li>
</ol>
<h4 id="11-4-The-Sockets-Interface"><a href="#11-4-The-Sockets-Interface" class="headerlink" title="11.4 The Sockets Interface"></a>11.4 The Sockets Interface</h4><ol>
<li><code>Sockets interface</code> used in conjunction with <code>unix IO</code><ol>
<li><img src="/2019/02/25/csapp/E:/hexo\Hexo_Repository\source\_posts\csapp\1563875460751.png" alt="Overview of Socket Interface"></li>
<li>traditional socket includes use <code>send</code> and <code>recv</code> to pass info</li>
</ol>
</li>
</ol>
<h4 id="11-4-1-Socket-Address-Structure"><a href="#11-4-1-Socket-Address-Structure" class="headerlink" title="11.4.1 Socket Address Structure"></a>11.4.1 Socket Address Structure</h4><ol>
<li><p>For Kernel, <code>socket</code> is endpoint for communication, for application, <code>socket</code> is just an open file</p>
<ol>
<li><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Generic socket address structure (for connect, bind, and accept) */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sockaddr</span> &#123;</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">short</span> sa_family; <span class="comment">/* Protocol family */</span> </span><br><span class="line"><span class="keyword">char</span> sa_data[<span class="number">14</span>]; <span class="comment">/* Address data. */</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">/* Internet-style socket address structure */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> &#123;</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">short</span> sin_family; <span class="comment">/* Address family (always AF_INET) */</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">short</span> sin_port; <span class="comment">/* Port number in network byte order */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">in_addr</span> <span class="title">sin_addr</span>;</span> <span class="comment">/* IP address in network byte order */</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">char</span> sin_zero[<span class="number">8</span>]; <span class="comment">/* Pad to sizeof(struct sockaddr) */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>Internet-style socket address structure</code> : </p>
<ol>
<li><code>sin_family</code> always <code>AF_INET</code></li>
<li>Takes 16 byte in total, 2 2 4 8</li>
</ol>
</li>
<li><p>Back when socket designed, no <code>void*</code>, for different <code>sockaddr_in</code>, have to cast to a general <code>sockaddr</code> family</p>
</li>
</ol>
</li>
</ol>
<h4 id="11-4-2-The-Socket-Function"><a href="#11-4-2-The-Socket-Function" class="headerlink" title="11.4.2 The Socket Function"></a>11.4.2 The Socket Function</h4><ol>
<li><p>Client and server uses<code>socket</code> to creates a <code>socket descriptor</code></p>
<ol>
<li><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">socket</span><span class="params">(<span class="keyword">int</span> domain, <span class="keyword">int</span> type, <span class="keyword">int</span> protocol)</span></span>;</span><br><span class="line">returns nonnegative integer <span class="keyword">if</span> OK, <span class="keyword">or</span> <span class="number">-1</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>In our case, always <code>clientfd = Socket(AF_INET, SOCK_STREAM, 0);</code></p>
</li>
<li><p><code>AF_INET</code> means using Internet, <code>SOC_STREAM</code> socket will be endpoint of connection</p>
</li>
<li><p><code>clientfd</code> returned is still partially opened cannot be read or write</p>
</li>
</ol>
</li>
</ol>
<h4 id="11-4-3-The-Connect-Function"><a href="#11-4-3-The-Connect-Function" class="headerlink" title="11.4.3 The Connect Function"></a>11.4.3 The Connect Function</h4><ol>
<li><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">connect</span><span class="params">(<span class="keyword">int</span> sockfd, struct sockaddr* serv_addr, <span class="keyword">int</span> addr_len)</span></span></span><br></pre></td></tr></table></figure>
<ol>
<li><code>connect</code> establish Internet connection between <code>sockfd</code> and socket pointed by <code>serv_addr</code></li>
<li><code>connect</code> blocks until connection establishes or fails</li>
</ol>
</li>
</ol>
<h4 id="11-4-4-The-open-clientfd-function"><a href="#11-4-4-The-open-clientfd-function" class="headerlink" title="11.4.4 The open_clientfd function"></a>11.4.4 The open_clientfd function</h4><ol>
<li><p><code>open_clientfd</code> wraps <code>socket()</code> and <code>connect()</code> , establishes connection with <code>hostname</code> on <code>port</code></p>
</li>
<li><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"csapp.h"</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">open_clientfd</span><span class="params">(<span class="keyword">char</span>* hostname, <span class="keyword">int</span> port)</span></span>;</span><br></pre></td></tr></table></figure>
<ol>
<li><p>connection with host <code>hostname</code> on <code>port</code></p>
</li>
<li><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">open_clientfd</span><span class="params">(<span class="keyword">char</span> *hostname, <span class="keyword">int</span> port)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> clientfd;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">hostent</span> *<span class="title">hp</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">serveraddr</span>;</span></span><br><span class="line">    <span class="keyword">if</span> ((clientfd = socket(AF_INET, SOCK_STREAM, <span class="number">0</span>)) &lt; <span class="number">0</span>)</span><br><span class="line">    	<span class="keyword">return</span> <span class="number">-1</span>; <span class="comment">/* Check errno for cause of error */</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* Fill in the server’s IP address and port */</span></span><br><span class="line">    <span class="keyword">if</span> ((hp = gethostbyname(hostname)) == <span class="literal">NULL</span>)</span><br><span class="line">    	<span class="keyword">return</span> <span class="number">-2</span>; <span class="comment">/* Check h_errno for cause of error */</span></span><br><span class="line">    </span><br><span class="line">    bzero((<span class="keyword">char</span> *) &amp;serveraddr, <span class="keyword">sizeof</span>(serveraddr)); <span class="comment">// erase memory</span></span><br><span class="line">    serveraddr.sin_family = AF_INET;</span><br><span class="line">    </span><br><span class="line">    bcopy((<span class="keyword">char</span> *)hp-&gt;h_addr_list[<span class="number">0</span>],</span><br><span class="line">          (<span class="keyword">char</span> *)&amp;serveraddr.sin_addr.s_addr, </span><br><span class="line">          hp-&gt;h_length);</span><br><span class="line">    </span><br><span class="line">    serveraddr.sin_port = htons(port); <span class="comment">// htons : for short int </span></span><br><span class="line">    <span class="comment">/* Establish a connection with the server */</span></span><br><span class="line">    <span class="keyword">if</span> (connect(clientfd, (SA *) &amp;serveraddr, <span class="keyword">sizeof</span>(serveraddr)) &lt; <span class="number">0</span>)</span><br><span class="line">    	<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">return</span> clientfd;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
</li>
</ol>
<h4 id="11-4-5-The-bind-Function"><a href="#11-4-5-The-bind-Function" class="headerlink" title="11.4.5 The bind Function"></a>11.4.5 The bind Function</h4><ol>
<li><p><code>bind()</code> server side <code>sockfd</code> with <code>serv_addr</code></p>
<ol>
<li><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">bind</span><span class="params">(<span class="keyword">int</span> sockfd, struct sockaddr * serv_addr, <span class="keyword">int</span> size)</span></span>;</span><br></pre></td></tr></table></figure>
</li>
<li></li>
</ol>
</li>
</ol>
<h4 id="11-4-6-The-listen-Function"><a href="#11-4-6-The-listen-Function" class="headerlink" title="11.4.6 The listen Function"></a>11.4.6 The listen Function</h4><ol>
<li><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">listen</span><span class="params">(<span class="keyword">int</span> sockfd, <span class="keyword">int</span> backlog)</span></span></span><br></pre></td></tr></table></figure>
</li>
<li><p>Converts <code>sockfd</code> to listening state, <code>backlog</code> for largest queue size before refusing</p>
</li>
</ol>
<h4 id="11-4-7-The-open-listenfd-Function"><a href="#11-4-7-The-open-listenfd-Function" class="headerlink" title="11.4.7 The open_listenfd Function"></a>11.4.7 The open_listenfd Function</h4><ol>
<li><p><code>open_listenfd</code> combines <code>socket(), bind(), listen()</code></p>
<ol>
<li><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"csapp.h"</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">open_listenfd</span><span class="params">(<span class="keyword">int</span> port)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">open_listenfd</span><span class="params">(<span class="keyword">int</span> port)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> listenfd, optval=<span class="number">1</span>;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">serveraddr</span>;</span></span><br><span class="line">    <span class="comment">/* Create a socket descriptor */</span></span><br><span class="line">    <span class="keyword">if</span> ((listenfd = socket(AF_INET, SOCK_STREAM, <span class="number">0</span>)) &lt; <span class="number">0</span>)</span><br><span class="line">    	<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Eliminates "Address already in use" error from bind */</span></span><br><span class="line">    <span class="keyword">if</span> (setsockopt(listenfd, SOL_SOCKET, SO_REUSEADDR,</span><br><span class="line">    	(<span class="keyword">const</span> <span class="keyword">void</span> *)&amp;optval , <span class="keyword">sizeof</span>(<span class="keyword">int</span>)) &lt; <span class="number">0</span>)</span><br><span class="line">    	<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    <span class="comment">/* Listenfd will be an end point for all requests to port</span></span><br><span class="line"><span class="comment">    on any IP address for this host */</span></span><br><span class="line">    bzero((<span class="keyword">char</span> *) &amp;serveraddr, <span class="keyword">sizeof</span>(serveraddr));</span><br><span class="line">    serveraddr.sin_family = AF_INET;</span><br><span class="line">    serveraddr.sin_addr.s_addr = htonl(INADDR_ANY); <span class="comment">// wildcard address</span></span><br><span class="line">    serveraddr.sin_port = htons((<span class="keyword">unsigned</span> <span class="keyword">short</span>)port);</span><br><span class="line">    <span class="keyword">if</span> (bind(listenfd, (SA *)&amp;serveraddr, <span class="keyword">sizeof</span>(serveraddr)) &lt; <span class="number">0</span>)</span><br><span class="line">    	<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    <span class="comment">/* Make it a listening socket ready to accept connection requests */</span></span><br><span class="line">    <span class="keyword">if</span> (listen(listenfd, LISTENQ) &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">return</span> listenfd;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
</li>
</ol>
<h4 id="11-4-8-The-accept-function"><a href="#11-4-8-The-accept-function" class="headerlink" title="11.4.8 The accept function"></a>11.4.8 The accept function</h4><ol>
<li><p><code>accept</code>waits for connection requests</p>
<ol>
<li><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">accept</span><span class="params">(<span class="keyword">int</span> listenfd, struct sockaddr* client_addr, <span class="keyword">int</span>* addrlen)</span></span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p>Fills <code>client_addr</code> and returns a <code>connected descriptor</code> </p>
</li>
<li><p>Distinction between <code>listening descriptor</code> and <code>connected descriptor</code></p>
</li>
<li><p><img src="/2019/02/25/csapp/E:/hexo\Hexo_Repository\source\_posts\csapp\1563892016776.png" alt="1563892016776"></p>
</li>
</ol>
</li>
<li></li>
</ol>
<h3 id="11-5-Web-Servers"><a href="#11-5-Web-Servers" class="headerlink" title="11.5 Web Servers"></a>11.5 Web Servers</h3><ol>
<li><h4 id="11-5-1-Web-Basics"><a href="#11-5-1-Web-Basics" class="headerlink" title="11.5.1 Web Basics"></a>11.5.1 Web Basics</h4></li>
<li><p>Web clients and servers communicate with text-based application-level protocol known as <code>http</code></p>
</li>
</ol>
<h4 id="11-5-2-Web-Content"><a href="#11-5-2-Web-Content" class="headerlink" title="11.5.2 Web Content"></a>11.5.2 Web Content</h4><ol>
<li><p><code>content</code> is a sequence of bytes with an associated <code>MIME</code> (multiple internet mail extension) type.</p>
<ol>
<li><code>servicing static content</code> : fetch a disk file and return to its content</li>
<li><code>dynamic content</code> : run an executable file and return to client</li>
<li><img src="/2019/02/25/csapp/E:/hexo\Hexo_Repository\source\_posts\csapp\1563936585085.png" alt="1563936585085"></li>
</ol>
</li>
<li><p>Each content returned is some files it managed, has a unique name known as <code>universal resource locator(URL)</code></p>
<ol>
<li><figure class="highlight plain"><figcaption><span>`port` is optional, default port is 80</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line">   2. ````http://www.bluefish.ics.cs.cmu.edu:8080/cgi-bin/adder?15000&amp;213``` ,`?` separates file name and argument, `&amp;` separates argument</span><br><span class="line"></span><br><span class="line">   </span><br><span class="line"></span><br><span class="line">#### 11.5.3 HTTP Transactions</span><br><span class="line"></span><br><span class="line">1. `telnet`conduct transaction with web server.</span><br><span class="line">2. ![1563939394503](E:\hexo\Hexo_Repository\source\_posts\csapp\1563939394503.png)</span><br><span class="line">3. `HTTP request` : `request line` + zero or more `request header`</span><br><span class="line">   1. format : `&lt;method&gt; &lt;uri&gt; &lt;version&gt; `  ----- `GET / HTTP/1.1`</span><br><span class="line">   2. `Uniform Resource Indicator(URI)` : suffix of `URL`</span><br><span class="line">   3. `request header` : `&lt;header name&gt; : &lt;header data&gt; `</span><br><span class="line">   4. host header is used by `proxy caches` , which sometimes serve as intermediaries</span><br><span class="line">4. `HTTP response` : `response line + 0 or more response header` + `response body`</span><br><span class="line">5. ``&lt;version&gt; &lt;status code&gt; &lt;status message&gt;`</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#### 11.5.4 Serving Dynamic Content</span><br><span class="line"></span><br><span class="line">1. `Common Gateway Interface` : </span><br><span class="line">2. `GET` pass argument in URI, `POST` pass in `request body`</span><br><span class="line">3. Receiving `GET /cgi-bin/adder?15000&amp;213 HTTP/1.1  `, it calls `fork` to create child process and calls `execve` to run `cgi-bin/adder`</span><br><span class="line">4. ![1563941198617](E:\hexo\Hexo_Repository\source\_posts\csapp\1563941198617.png)</span><br><span class="line">5. Where does the child send its output? </span><br><span class="line">   1. `CGI` send output to `stdout`, then `dup2` redirected to `connected descriptor`</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">### 11.6 The tiny Web Server</span><br><span class="line"></span><br><span class="line">1. `Tiny`, an iterative web server that listens to request on the port that is passed in command line</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">## 12 Concurrent Programming</span><br><span class="line"></span><br><span class="line">1. Three basic approaches to build concurrent program : </span><br><span class="line">   1. `processes` : each logical control flow is a process, `Inter Process Communication`</span><br><span class="line">   2. `IO multiplexing` : applications explicitly  schedule their own logical flow in the context of a process</span><br><span class="line">   3. `Threads` : combination of previous two</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">### 12.1 Concurrent Programming with Process</span><br><span class="line"></span><br><span class="line">1. Main idea : `fork` each new request, delete extra `fd` in children process</span><br><span class="line"></span><br><span class="line">   1. ![1564390382704](E:\hexo\Hexo_Repository\source\_posts\csapp\1564390382704.png)</span><br><span class="line">   2. ![1564390390644](E:\hexo\Hexo_Repository\source\_posts\csapp\1564390390644.png)</span><br><span class="line">   3. ![1564390402113](E:\hexo\Hexo_Repository\source\_posts\csapp\1564390402113.png)</span><br><span class="line">   4. ![1564390453084](E:\hexo\Hexo_Repository\source\_posts\csapp\1564390453084.png)</span><br><span class="line"></span><br><span class="line">2. code : </span><br><span class="line"></span><br><span class="line">   1. ```c</span><br><span class="line">      /* </span><br><span class="line">       * echoserverp.c - A concurrent echo server based on processes</span><br><span class="line">       */</span><br><span class="line">      /* $begin echoserverpmain */</span><br><span class="line">      #include &quot;csapp.h&quot;</span><br><span class="line">      void echo(int connfd);</span><br><span class="line">      </span><br><span class="line">      void sigchld_handler(int sig) //line:conc:echoserverp:handlerstart</span><br><span class="line">      &#123;</span><br><span class="line">          while (waitpid(-1, 0, WNOHANG) &gt; 0)</span><br><span class="line">          ;</span><br><span class="line">          return;</span><br><span class="line">      &#125; //line:conc:echoserverp:handlerend</span><br><span class="line">      </span><br><span class="line">      int main(int argc, char **argv) </span><br><span class="line">      &#123;</span><br><span class="line">          int listenfd, connfd, port;</span><br><span class="line">          socklen_t clientlen=sizeof(struct sockaddr_in);</span><br><span class="line">          struct sockaddr_in clientaddr;</span><br><span class="line">      </span><br><span class="line">          if (argc != 2) &#123;</span><br><span class="line">      	fprintf(stderr, &quot;usage: %s &lt;port&gt;\n&quot;, argv[0]);</span><br><span class="line">      	exit(0);</span><br><span class="line">          &#125;</span><br><span class="line">          port = atoi(argv[1]);</span><br><span class="line">      </span><br><span class="line">          Signal(SIGCHLD, sigchld_handler);</span><br><span class="line">          listenfd = Open_listenfd(port);</span><br><span class="line">          while (1) &#123;</span><br><span class="line">      	connfd = Accept(listenfd, (SA *) &amp;clientaddr, &amp;clientlen);</span><br><span class="line">      	if (Fork() == 0) &#123; </span><br><span class="line">      	    Close(listenfd); /* Child closes its listening socket */</span><br><span class="line">      	    echo(connfd);    /* Child services client */ </span><br><span class="line">      	    Close(connfd);   /* Child closes connection with client */ </span><br><span class="line">      	    exit(0);         /* Child exits */</span><br><span class="line">      	&#125;</span><br><span class="line">      	Close(connfd); /* Parent closes connected socket (important!) */ //line:conc:echoserverp:parentclose</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      /* $end echoserverpmain */</span><br></pre></td></tr></table></figure>
</li>
<li><p>When a process terminates, kernel close all the file descriptors opened by it</p>
</li>
<li></li>
</ol>
</li>
</ol>
<h4 id="12-1-1-A-Concurrent-Server-Based-on-Process"><a href="#12-1-1-A-Concurrent-Server-Based-on-Process" class="headerlink" title="12.1.1 A Concurrent Server Based on Process"></a>12.1.1 A Concurrent Server Based on Process</h4><ol>
<li>why <code>sigchld_handler</code> ? <ol>
<li>Server typically runs for a long time, <code>signal SIGCHLD</code> is blocked when <code>sigchld_handler</code> is running</li>
</ol>
</li>
<li><code>parent</code> and <code>children</code> to close their file descriptors to avoid memory leak</li>
</ol>
<h4 id="12-1-2-Pros-and-cons"><a href="#12-1-2-Pros-and-cons" class="headerlink" title="12.1.2 Pros and cons"></a>12.1.2 Pros and cons</h4><ol>
<li><code>process</code> is both advantage and disadvantage, hard to communicate between processes</li>
</ol>
<h3 id="12-2-Concurrent-programming-with-IO-multiplexing"><a href="#12-2-Concurrent-programming-with-IO-multiplexing" class="headerlink" title="12.2 Concurrent programming with IO multiplexing"></a>12.2 Concurrent programming with IO multiplexing</h3><ol>
<li><p>what</p>
</li>
<li><p><code>IO multiplexing</code> deals with waiting for various <code>IO events</code>  with <code>select</code></p>
<ol>
<li><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">select</span><span class="params">(<span class="keyword">int</span> n, fd_set *fdset, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>)</span></span>;</span><br><span class="line">Returns nonzero count of ready descriptors, −<span class="number">1</span> on error</span><br><span class="line">FD_ZERO(fd_set *fdset); <span class="comment">/* Clear all bits in fdset */</span></span><br><span class="line">FD_CLR(<span class="keyword">int</span> fd, fd_set *fdset); <span class="comment">/* Clear bit fd in fdset */</span></span><br><span class="line">FD_SET(<span class="keyword">int</span> fd, fd_set *fdset); <span class="comment">/* Turn on bit fd in fdset */</span></span><br><span class="line">FD_ISSET(<span class="keyword">int</span> fd, fd_set *fdset); <span class="comment">/* Is bit fd in fdset on? */</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>we only use it to wait for <code>fd</code> ready for reading</p>
</li>
</ol>
</li>
<li><p>code : </p>
<ol>
<li><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * p652 -- code/conc/select.c</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 使用 I/O 多路复用的 echo 服务器。服务器使用 select 等待监听描述符上的连接请求</span></span><br><span class="line"><span class="comment"> * 和标准输入上的命令。</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 在类 UNIX 系统下编译和运行：</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * unix&gt; make select</span></span><br><span class="line"><span class="comment"> * unix&gt; ./select 16384</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"csapp.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">echo</span><span class="params">(<span class="keyword">int</span> connfd)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">command</span><span class="params">(<span class="keyword">void</span>)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">        <span class="keyword">int</span> listenfd, connfd, port;</span><br><span class="line">        <span class="keyword">socklen_t</span> clientlen = <span class="keyword">sizeof</span>(struct sockaddr_in);</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">clientaddr</span>;</span></span><br><span class="line">        fd_set read_set, ready_set;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (argc != <span class="number">2</span>) &#123;</span><br><span class="line">                <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"usage: %s &lt;port&gt;\n"</span>, argv[<span class="number">0</span>]);</span><br><span class="line">                <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        port = atoi(argv[<span class="number">1</span>]);</span><br><span class="line">        listenfd = Open_listenfd(port);</span><br><span class="line"></span><br><span class="line">        FD_ZERO(&amp;read_set);     <span class="comment">/* Clear read set */</span></span><br><span class="line">        FD_SET(STDIN_FILENO, &amp;read_set); <span class="comment">/* Add stdin to read set */</span></span><br><span class="line">        FD_SET(listenfd, &amp;read_set);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">                ready_set = read_set;</span><br><span class="line">                Select(listenfd+<span class="number">1</span>, &amp;ready_set, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line">                <span class="keyword">if</span> (FD_ISSET(STDIN_FILENO, &amp;ready_set))</span><br><span class="line">                        command(); <span class="comment">/* Read command line from stdin */</span></span><br><span class="line">                <span class="keyword">if</span> (FD_ISSET(listenfd, &amp;ready_set)) &#123;</span><br><span class="line">                        connfd = Accept(listenfd, (SA *)&amp;clientaddr, &amp;clientlen);</span><br><span class="line">                        echo(connfd); <span class="comment">/* Echo client input until EOF */</span></span><br><span class="line">                        Close(connfd);</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;               <span class="comment">/* Avoid compiler warning */</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">command</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">        <span class="keyword">char</span> buf[MAXLINE];</span><br><span class="line">        <span class="keyword">if</span> (!Fgets(buf, MAXLINE, <span class="built_in">stdin</span>))</span><br><span class="line">                <span class="built_in">exit</span>(<span class="number">0</span>);        <span class="comment">/* EOF */</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"%s"</span>, buf);      <span class="comment">/* Process the input command */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
</li>
</ol>
<h4 id="12-2-1-A-Concurrent-Event-driven-Server-based-on-I-O-Multiplexing"><a href="#12-2-1-A-Concurrent-Event-driven-Server-based-on-I-O-Multiplexing" class="headerlink" title="12.2.1 A Concurrent Event-driven Server based on I/O Multiplexing"></a>12.2.1 A Concurrent Event-driven Server based on I/O Multiplexing</h4><ol>
<li></li>
<li><p>code : </p>
<ol>
<li><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment"> * echoservers.c - A concurrent echo server based on select</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="comment">/* $begin echoserversmain */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"csapp.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span> <span class="comment">/* represents a pool of connected descriptors */</span> </span><br><span class="line">    <span class="keyword">int</span> maxfd;        <span class="comment">/* largest descriptor in read_set */</span>   </span><br><span class="line">    fd_set read_set;  <span class="comment">/* set of all active descriptors */</span></span><br><span class="line">    fd_set ready_set; <span class="comment">/* subset of descriptors ready for reading  */</span></span><br><span class="line">    <span class="keyword">int</span> nready;       <span class="comment">/* number of ready descriptors from select */</span>   </span><br><span class="line">    <span class="keyword">int</span> maxi;         <span class="comment">/* highwater index into client array */</span></span><br><span class="line">    <span class="keyword">int</span> clientfd[FD_SETSIZE];    <span class="comment">/* set of active descriptors */</span></span><br><span class="line">    <span class="keyword">rio_t</span> clientrio[FD_SETSIZE]; <span class="comment">/* set of active read buffers */</span></span><br><span class="line">&#125; pool; <span class="comment">//line:conc:echoservers:endpool</span></span><br><span class="line"><span class="comment">/* $end echoserversmain */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">init_pool</span><span class="params">(<span class="keyword">int</span> listenfd, pool *p)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">add_client</span><span class="params">(<span class="keyword">int</span> connfd, pool *p)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">check_clients</span><span class="params">(pool *p)</span></span>;</span><br><span class="line"><span class="comment">/* $begin echoserversmain */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> byte_cnt = <span class="number">0</span>; <span class="comment">/* counts total bytes received by server */</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> listenfd, connfd, port; </span><br><span class="line">    <span class="keyword">socklen_t</span> clientlen = <span class="keyword">sizeof</span>(struct sockaddr_in);</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">clientaddr</span>;</span></span><br><span class="line">    <span class="keyword">static</span> pool pool; </span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (argc != <span class="number">2</span>) &#123;</span><br><span class="line">	<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"usage: %s &lt;port&gt;\n"</span>, argv[<span class="number">0</span>]);</span><br><span class="line">	<span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    port = atoi(argv[<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">    listenfd = Open_listenfd(port);</span><br><span class="line">    init_pool(listenfd, &amp;pool); <span class="comment">//line:conc:echoservers:initpool</span></span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">	<span class="comment">/* Wait for listening/connected descriptor(s) to become ready */</span></span><br><span class="line">	pool.ready_set = pool.read_set;</span><br><span class="line">	pool.nready = Select(pool.maxfd+<span class="number">1</span>, &amp;pool.ready_set, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* If listening descriptor ready, add new client to pool */</span></span><br><span class="line">	<span class="keyword">if</span> (FD_ISSET(listenfd, &amp;pool.ready_set)) &#123; </span><br><span class="line">	    connfd = Accept(listenfd, (SA *)&amp;clientaddr, &amp;clientlen); </span><br><span class="line">	    add_client(connfd, &amp;pool); </span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/* Echo a text line from each ready connected descriptor */</span> </span><br><span class="line">	check_clients(&amp;pool); <span class="comment">//line:conc:echoservers:checkclients</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* $end echoserversmain */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* $begin init_pool */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">init_pool</span><span class="params">(<span class="keyword">int</span> listenfd, pool *p)</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">/* Initially, there are no connected descriptors */</span></span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    p-&gt;maxi = <span class="number">-1</span>;                   <span class="comment">//line:conc:echoservers:beginempty</span></span><br><span class="line">    <span class="keyword">for</span> (i=<span class="number">0</span>; i&lt; FD_SETSIZE; i++)  </span><br><span class="line">	p-&gt;clientfd[i] = <span class="number">-1</span>;        <span class="comment">//line:conc:echoservers:endempty</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Initially, listenfd is only member of select read set */</span></span><br><span class="line">    p-&gt;maxfd = listenfd;            <span class="comment">//line:conc:echoservers:begininit</span></span><br><span class="line">    FD_ZERO(&amp;p-&gt;read_set);</span><br><span class="line">    FD_SET(listenfd, &amp;p-&gt;read_set); <span class="comment">//line:conc:echoservers:endinit</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* $end init_pool */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* $begin add_client */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">add_client</span><span class="params">(<span class="keyword">int</span> connfd, pool *p)</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    p-&gt;nready--;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; FD_SETSIZE; i++)  <span class="comment">/* Find an available slot */</span></span><br><span class="line">	<span class="keyword">if</span> (p-&gt;clientfd[i] &lt; <span class="number">0</span>) &#123; </span><br><span class="line">	    <span class="comment">/* Add connected descriptor to the pool */</span></span><br><span class="line">	    p-&gt;clientfd[i] = connfd;      </span><br><span class="line">	    Rio_readinitb(&amp;p-&gt;clientrio[i], connfd);</span><br><span class="line"></span><br><span class="line">	    <span class="comment">/* Add the descriptor to descriptor set */</span></span><br><span class="line">	    FD_SET(connfd, &amp;p-&gt;read_set); <span class="comment">//line:conc:echoservers:addconnfd</span></span><br><span class="line"></span><br><span class="line">	    <span class="comment">/* Update max descriptor and pool highwater mark */</span></span><br><span class="line">	    <span class="keyword">if</span> (connfd &gt; p-&gt;maxfd) <span class="comment">//line:conc:echoservers:beginmaxfd</span></span><br><span class="line">			p-&gt;maxfd = connfd; <span class="comment">//line:conc:echoservers:endmaxfd</span></span><br><span class="line">	    <span class="keyword">if</span> (i &gt; p-&gt;maxi)       <span class="comment">//line:conc:echoservers:beginmaxi</span></span><br><span class="line">			p-&gt;maxi = i;       <span class="comment">//line:conc:echoservers:endmaxi</span></span><br><span class="line">	    <span class="keyword">break</span>;</span><br><span class="line">	&#125;</span><br><span class="line">    <span class="keyword">if</span> (i == FD_SETSIZE) <span class="comment">/* Couldn't find an empty slot */</span></span><br><span class="line">	app_error(<span class="string">"add_client error: Too many clients"</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* $end add_client */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* $begin check_clients */</span></span><br><span class="line"><span class="comment">// check for every connected rio_t and echo back</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">check_clients</span><span class="params">(pool *p)</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i, connfd, n;</span><br><span class="line">    <span class="keyword">char</span> buf[MAXLINE]; </span><br><span class="line">    <span class="keyword">rio_t</span> rio;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; (i &lt;= p-&gt;maxi) &amp;&amp; (p-&gt;nready &gt; <span class="number">0</span>); i++) &#123;</span><br><span class="line">	connfd = p-&gt;clientfd[i];</span><br><span class="line">	rio = p-&gt;clientrio[i];</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* If the descriptor is ready, echo a text line from it */</span></span><br><span class="line">	<span class="keyword">if</span> ((connfd &gt; <span class="number">0</span>) &amp;&amp; (FD_ISSET(connfd, &amp;p-&gt;ready_set))) &#123; </span><br><span class="line">	    p-&gt;nready--;</span><br><span class="line">	    <span class="keyword">if</span> ((n = Rio_readlineb(&amp;rio, buf, MAXLINE)) != <span class="number">0</span>) &#123;</span><br><span class="line">		byte_cnt += n; <span class="comment">//line:conc:echoservers:beginecho</span></span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">"Server received %d (%d total) bytes on fd %d\n"</span>, </span><br><span class="line">		       n, byte_cnt, connfd);</span><br><span class="line">		Rio_writen(connfd, buf, n); <span class="comment">//line:conc:echoservers:endecho</span></span><br><span class="line">	    &#125;</span><br><span class="line"></span><br><span class="line">	    <span class="comment">/* EOF detected, remove descriptor from pool */</span></span><br><span class="line">	    <span class="keyword">else</span> &#123; </span><br><span class="line">		Close(connfd); <span class="comment">//line:conc:echoservers:closeconnfd</span></span><br><span class="line">		FD_CLR(connfd, &amp;p-&gt;read_set); <span class="comment">//line:conc:echoservers:beginremove</span></span><br><span class="line">		p-&gt;clientfd[i] = <span class="number">-1</span>;          <span class="comment">//line:conc:echoservers:endremove</span></span><br><span class="line">	    &#125;</span><br><span class="line">	&#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* $end check_clients */</span></span><br></pre></td></tr></table></figure>
</li>
<li></li>
</ol>
</li>
</ol>
<h3 id="12-3-Concurrent-Programming-with-Threads"><a href="#12-3-Concurrent-Programming-with-Threads" class="headerlink" title="12.3 Concurrent Programming with Threads"></a>12.3 Concurrent Programming with Threads</h3><ol>
<li>Similar to process, <ol>
<li><img src="/2019/02/25/csapp/E:/hexo\Hexo_Repository\source\_posts\csapp\1564455376725.png" alt="1564455376725"></li>
<li>Start with a <code>main thread</code>, share same virtual address space</li>
</ol>
</li>
</ol>
<h4 id="12-3-2-Posix-Threads"><a href="#12-3-2-Posix-Threads" class="headerlink" title="12.3.2 Posix Threads"></a>12.3.2 Posix Threads</h4><ol>
<li><p>Posix thread function : </p>
<ol>
<li><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// create threads</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">void</span>* (func)(<span class="keyword">void</span>*);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">pthread_create</span><span class="params">(<span class="keyword">pthread_t</span> *tid, pthread_t_attr *attr, func *f, <span class="keyword">void</span> *arg)</span></span></span><br><span class="line"><span class="function"><span class="comment">// return 0 if ok, </span></span></span><br><span class="line"><span class="function">    </span></span><br><span class="line"><span class="function">pthread_t <span class="title">pthread_self</span><span class="params">(<span class="keyword">void</span>)</span></span>; <span class="comment">// return ID of calling thread</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Thread termination :</span></span><br><span class="line"><span class="comment">// 1. thread terminates implicitly</span></span><br><span class="line"><span class="comment">// 2. thread terminates explicilty, main thread call exit then wait for all thread to terminate and return with *thread_return</span></span><br><span class="line"><span class="comment">// 3. some thread call exit, terminates entire process</span></span><br><span class="line"><span class="comment">// 4. pthread_cancel</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">pthread_exit</span><span class="params">(<span class="keyword">void</span> *thread_return)</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">pthread_cancel</span><span class="params">(<span class="keyword">pthread_t</span> tid)</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">pthread_join</span><span class="params">(<span class="keyword">pthread_t</span> tid, <span class="keyword">void</span> ** thread_return)</span> <span class="comment">// wait for tid to terminate</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="comment">// a thread is either detached(terminates implicitly) or joinable(need to be joined)</span></span></span><br><span class="line"><span class="function">    </span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">pthread_detach</span><span class="params">(<span class="keyword">pthread_t</span> tid)</span></span></span><br></pre></td></tr></table></figure>
</li>
</ol>
</li>
<li><p>echo server based on threads:</p>
<ol>
<li><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment"> * echoservert.c - A concurrent echo server using threads</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="comment">/* $begin echoservertmain */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"csapp.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">echo</span><span class="params">(<span class="keyword">int</span> connfd)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">thread</span><span class="params">(<span class="keyword">void</span> *vargp)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> listenfd, *connfdp, port;</span><br><span class="line">    <span class="keyword">socklen_t</span> clientlen=<span class="keyword">sizeof</span>(struct sockaddr_in);</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">clientaddr</span>;</span></span><br><span class="line">    <span class="keyword">pthread_t</span> tid; </span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (argc != <span class="number">2</span>) &#123;</span><br><span class="line">	<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"usage: %s &lt;port&gt;\n"</span>, argv[<span class="number">0</span>]);</span><br><span class="line">	<span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    port = atoi(argv[<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">    listenfd = Open_listenfd(port);</span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">	connfdp = Malloc(<span class="keyword">sizeof</span>(<span class="keyword">int</span>)); <span class="comment">// avoids race</span></span><br><span class="line">	*connfdp = Accept(listenfd, (SA *) &amp;clientaddr, &amp;clientlen); </span><br><span class="line">	Pthread_create(&amp;tid, <span class="literal">NULL</span>, thread, connfdp);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* thread routine */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">thread</span><span class="params">(<span class="keyword">void</span> *vargp)</span> </span></span><br><span class="line"><span class="function"></span>&#123;  </span><br><span class="line">    <span class="keyword">int</span> connfd = *((<span class="keyword">int</span> *)vargp);</span><br><span class="line">    Pthread_detach(pthread_self()); <span class="comment">//line:conc:echoservert:detach</span></span><br><span class="line">    Free(vargp);                    <span class="comment">//line:conc:echoservert:free</span></span><br><span class="line">    echo(connfd);</span><br><span class="line">    Close(connfd);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* $end echoservertmain */</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
</li>
</ol>
<h3 id="12-4-Shared-variables-in-Threaded-Programs"><a href="#12-4-Shared-variables-in-Threaded-Programs" class="headerlink" title="12.4 Shared variables in Threaded Programs"></a>12.4 Shared variables in Threaded Programs</h3><ol>
<li><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* $begin sharing */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"csapp.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> N 2</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">thread</span><span class="params">(<span class="keyword">void</span> *vargp)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">char</span> **ptr;  <span class="comment">/* global variable */</span> <span class="comment">//line:conc:sharing:ptrdec</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i;  </span><br><span class="line">    <span class="keyword">pthread_t</span> tid;</span><br><span class="line">    <span class="keyword">char</span> *msgs[N] = &#123;</span><br><span class="line">	<span class="string">"Hello from foo"</span>,  </span><br><span class="line">	<span class="string">"Hello from bar"</span>   </span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    ptr = msgs; </span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; N; i++)  </span><br><span class="line">        Pthread_create(&amp;tid, <span class="literal">NULL</span>, thread, (<span class="keyword">void</span> *)i); </span><br><span class="line">    Pthread_exit(<span class="literal">NULL</span>); </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">thread</span><span class="params">(<span class="keyword">void</span> *vargp)</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> myid = (<span class="keyword">int</span>)vargp;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">int</span> cnt = <span class="number">0</span>; <span class="comment">//line:conc:sharing:cntdec</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"[%d]: %s (cnt=%d)\n"</span>, myid, ptr[myid], ++cnt); <span class="comment">//line:conc:sharing:stack</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* $end sharing */</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>Each thread has its own <code>separate thread context</code>, which includes a <code>thread ID</code>, <code>stack</code>, <code>stack pointer</code>, <code>program counter</code>, <code>condition codes</code>, and <code>general-purpose register values</code>.</p>
</li>
</ol>
<h4 id="12-4-2-Mapping-Variables-to-Memory"><a href="#12-4-2-Mapping-Variables-to-Memory" class="headerlink" title="12.4.2 Mapping Variables to Memory"></a>12.4.2 Mapping Variables to Memory</h4><ol>
<li><code>GLobal variables</code></li>
<li><code>Local automatic variables</code> : own space</li>
<li><code>Local static variables</code> : </li>
<li></li>
</ol>
<h4 id="12-4-3-Shared-Variables"><a href="#12-4-3-Shared-Variables" class="headerlink" title="12.4.3 Shared Variables"></a>12.4.3 Shared Variables</h4><ol>
<li><code>shared</code> only if referenced by more than one thread</li>
</ol>
<h3 id="12-5-Synchronizing-Threads-with-Semaphores"><a href="#12-5-Synchronizing-Threads-with-Semaphores" class="headerlink" title="12.5 Synchronizing Threads with Semaphores"></a>12.5 Synchronizing Threads with Semaphores</h3><ol>
<li><p>Bad example of threads : </p>
<ol>
<li><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment"> * badcnt.c - An improperly synchronized counter program </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="comment">/* $begin badcnt */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"csapp.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">thread</span><span class="params">(<span class="keyword">void</span> *vargp)</span></span>;  <span class="comment">/* Thread routine prototype */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Global shared variable */</span></span><br><span class="line"><span class="keyword">volatile</span> <span class="keyword">int</span> cnt = <span class="number">0</span>; <span class="comment">/* Counter */</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> niters;</span><br><span class="line">    <span class="keyword">pthread_t</span> tid1, tid2;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Check input argument */</span></span><br><span class="line">    <span class="keyword">if</span> (argc != <span class="number">2</span>) &#123; </span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"usage: %s &lt;niters&gt;\n"</span>, argv[<span class="number">0</span>]);</span><br><span class="line">	<span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    niters = atoi(argv[<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Create threads and wait for them to finish */</span></span><br><span class="line">    Pthread_create(&amp;tid1, <span class="literal">NULL</span>, thread, &amp;niters);</span><br><span class="line">    Pthread_create(&amp;tid2, <span class="literal">NULL</span>, thread, &amp;niters);</span><br><span class="line">    Pthread_join(tid1, <span class="literal">NULL</span>);</span><br><span class="line">    Pthread_join(tid2, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Check result */</span></span><br><span class="line">    <span class="keyword">if</span> (cnt != (<span class="number">2</span> * niters))</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"BOOM! cnt=%d\n"</span>, cnt);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"OK cnt=%d\n"</span>, cnt);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Thread routine */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">thread</span><span class="params">(<span class="keyword">void</span> *vargp)</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i, niters = *((<span class="keyword">int</span> *)vargp);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; niters; i++) <span class="comment">//line:conc:badcnt:beginloop</span></span><br><span class="line">	cnt++;                   <span class="comment">//line:conc:badcnt:endloop</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* $end badcnt */</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><img src="/2019/02/25/csapp/E:/hexo\Hexo_Repository\source\_posts\csapp\1564468705023.png" alt="1564468705023"></p>
</li>
</ol>
</li>
</ol>
<h4 id="12-5-1-Process-Graphs"><a href="#12-5-1-Process-Graphs" class="headerlink" title="12.5.1 Process Graphs"></a>12.5.1 Process Graphs</h4><ol>
<li><code>Process Graphs</code> : n - dimensional Cartesian Space</li>
</ol>
<ol start="2">
<li><img src="/2019/02/25/csapp/E:/hexo\Hexo_Repository\source\_posts\csapp\1564470802877.png" alt="1564470802877"></li>
</ol>
<h4 id="12-5-2-Semaphore"><a href="#12-5-2-Semaphore" class="headerlink" title="12.5.2 Semaphore"></a>12.5.2 Semaphore</h4><h4 id="Week-2-2-Machine-Prog-——-Controls"><a href="#Week-2-2-Machine-Prog-——-Controls" class="headerlink" title="Week 2.2 Machine Prog —— Controls"></a>Week 2.2 Machine Prog —— Controls</h4><h4 id="1-Condition-codes"><a href="#1-Condition-codes" class="headerlink" title="1.Condition codes"></a>1.Condition codes</h4><ol>
<li>Condition codes, 8 bit register(%al),<figure class="highlight plain"><figcaption><span>%al, %eax```.</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">2. set(equals to ) ops have both signed, unsigned versions.</span><br><span class="line">3. Condition code:</span><br><span class="line">    4. CF,overflow of unsigned bit, detect carry out of most sig bit</span><br><span class="line">    5. ZF, the most recent ops yielded zero.</span><br><span class="line">    6. SF, MRO yielded a negative value/(for signed number)</span><br><span class="line">    7. OF, MRO yielded signed overflow</span><br><span class="line">#### 2.Jump</span><br><span class="line">1. Indirect jump, jmp * %eax</span><br><span class="line">2. How to address the jump labels?</span><br><span class="line">    3. PC relative, easy to shift</span><br><span class="line">    4. Direct</span><br><span class="line">3. Comparison and test instructions:</span><br><span class="line"></span><br><span class="line">|cmp S1 S2| S2-S1|</span><br><span class="line">|---|---|</span><br><span class="line">|test S1 S2 |S1&amp;S2|</span><br><span class="line"></span><br><span class="line">4. xor S, D D&lt;-D^S</span><br><span class="line"></span><br><span class="line">#### 3. Procedure</span><br><span class="line">1. Three main idea:</span><br><span class="line">   1. Passing control : where to start and how to return</span><br><span class="line">   2. Passing parameters : including return val</span><br><span class="line">   3. Memory management: allocate memory</span><br><span class="line">2. ![img](https://wdxtub.com/images/14611673348513.jpg)</span><br><span class="line">3. ```push Src```, push src to top of stack, ```pop Dest``` pop stack to Dest</span><br><span class="line">4. </span><br><span class="line">   1. callq, pushes next line to stack, for future return</span><br><span class="line">   2.  retq, pops return address</span><br><span class="line">   3.  leave</span><br><span class="line">5. Registers are shared by all procedures, yet make when one prod calls another, no overlap</span><br><span class="line">6. ![img](https://wdxtub.com/images/14611733132821.jpg)</span><br><span class="line">7. caller-save, callee-save register(save the value before using)</span><br><span class="line">8. Before finishing a prod, use leave of pop to deallocate </span><br><span class="line">9. Two ways to store at esp, push or move %eax, (%esp)</span><br><span class="line"></span><br><span class="line">#### 4. Data</span><br><span class="line">1.Struct, Union(can be accessed through different types and only cost the maximum space)</span><br><span class="line">2.Unions also allows for bit access</span><br><span class="line">```C</span><br><span class="line">1 unsigned float2bit(float f)</span><br><span class="line">2 &#123;</span><br><span class="line">    3 union &#123;</span><br><span class="line">    4 float f;</span><br><span class="line">    5 unsigned u;</span><br><span class="line">    6 &#125; temp;</span><br><span class="line">    7 temp.f = f;</span><br><span class="line">    8 return temp.u;</span><br><span class="line">9 &#125;;</span><br></pre></td></tr></table></figure></li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span> <span class="function"><span class="keyword">double</span> <span class="title">bit2double</span><span class="params">(<span class="keyword">unsigned</span> word0, <span class="keyword">unsigned</span> word1)</span></span></span><br><span class="line"><span class="function">2 </span>&#123;</span><br><span class="line">    <span class="number">3</span> <span class="keyword">union</span> &#123;</span><br><span class="line">    <span class="number">4</span> <span class="keyword">double</span> d;</span><br><span class="line">    <span class="number">5</span> <span class="keyword">unsigned</span> u[<span class="number">2</span>];</span><br><span class="line">    <span class="number">6</span> &#125; temp;</span><br><span class="line">    <span class="number">7</span></span><br><span class="line">    <span class="number">8</span> temp.u[<span class="number">0</span>] = word0;</span><br><span class="line">    <span class="number">9</span> temp.u[<span class="number">1</span>] = word1;</span><br><span class="line">    <span class="number">10</span> <span class="keyword">return</span> temp.d;</span><br><span class="line"><span class="number">11</span> &#125;</span><br></pre></td></tr></table></figure>
<h3 id="Week-X-Exceptional-Control-Flow"><a href="#Week-X-Exceptional-Control-Flow" class="headerlink" title="Week X  Exceptional Control Flow"></a>Week X  Exceptional Control Flow</h3><ol>
<li>Prelude:<ol start="0">
<li>Start from this chapter, we’re diving into system level.</li>
<li>Program counter expects a sequence of values: a_0… a_n, a_i is the address of instruction(Right! Just like what assembly code does). Each transition between a_i and a_i+1 is called <em>control transfer</em>, a sequence of transfer is called <em>flow of control</em>.</li>
<li>Most simple tranfer : <em>Smooth transfer</em> where adjacent sequence is transfered. Abrupt changes(ret, jump, call).</li>
<li><em>Exceptional control flow</em>(abrupts changes caused by factors other than internal program variables)</li>
</ol>
</li>
</ol>
<h3 id="1-Exceptions"><a href="#1-Exceptions" class="headerlink" title="1.Exceptions"></a>1.Exceptions</h3><ol>
<li><p>Exceptions are a form of exceptional control flow that are implemented partly by the <em>hardware</em> and partly by the <em>operating system</em>.</p>
</li>
<li><p><img src="https://wdxtub.com/images/14613541138958.jpg" alt="Anatomy of exception"></p>
</li>
<li><p>When <strong>Event</strong> happens, indirect procedure call made, through jump table (<strong>called exception table</strong>), to an OS subroutine(<strong>the exception handler</strong>).</p>
</li>
<li><p>Each type of possible exception in a system is assigned a unique nonnegative integer exception number(Code). Figure 8.3 shows how the processor uses the exception table to form the address of the appropriate exception handler. The exception number is an index into the exception table, whose starting address is contained in a special CPU register called the exception table base register.</p>
</li>
</ol>
<h4 id="Classes-of-exception"><a href="#Classes-of-exception" class="headerlink" title="Classes of exception"></a>Classes of exception</h4><table>
<thead>
<tr>
<th>类型</th>
<th>原因</th>
<th>行为</th>
<th>示例</th>
</tr>
</thead>
<tbody>
<tr>
<td>陷阱</td>
<td>有意的异常</td>
<td>返回到下一条指令</td>
<td>系统调用，断点</td>
</tr>
<tr>
<td>故障</td>
<td>潜在可恢复的错误</td>
<td>返回到当前指令</td>
<td>页故障(page faults)</td>
</tr>
<tr>
<td>终止</td>
<td>不可恢复的错误</td>
<td>终止当前程序</td>
<td>非法指令</td>
</tr>
</tbody>
</table>
<ol>
<li><em>Interrupts</em> occur <em>asynchronously</em> as a result of signals from I/O device.</li>
<li><em>Traps and sys call</em> provide a procedure like interface between user program and the kernel, known as a system call.<ol>
<li>One major diff bet sys call and normal procedure: in different mode, <em>User mode</em> and <em>Kernal mode</em>, with difference access and stacks.</li>
</ol>
</li>
<li><em>Faulting</em>, might lead to abort</li>
<li><em>Abort</em> never return control<h4 id="System-calls"><a href="#System-calls" class="headerlink" title="System calls"></a>System calls</h4></li>
</ol>
<table>
<thead>
<tr>
<th>Number</th>
<th>Name</th>
<th>Description</th>
<th>Number</th>
<th>Name</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>exit</td>
<td>Terminate process</td>
<td>27</td>
<td>alarm</td>
<td>Set signal delivery alarm clock</td>
</tr>
<tr>
<td>2</td>
<td>fork</td>
<td>Create new process</td>
<td>29</td>
<td>pause</td>
<td>Suspend  process until signal arrives</td>
</tr>
<tr>
<td>3</td>
<td>read</td>
<td>Read file</td>
<td>37</td>
<td>kill</td>
<td>Send signal to another process</td>
</tr>
<tr>
<td>4</td>
<td>write</td>
<td>Write file</td>
<td>48</td>
<td>signal</td>
<td>Install signal handler</td>
</tr>
<tr>
<td>5</td>
<td>open</td>
<td>Open file</td>
<td>63</td>
<td>dup2</td>
<td>Copy file descriptor</td>
</tr>
<tr>
<td>6</td>
<td>close</td>
<td>Close file</td>
<td>64</td>
<td>getppid</td>
<td>Get parent’s process ID</td>
</tr>
<tr>
<td>7</td>
<td>waitpid</td>
<td>Wait for child to terminate</td>
<td>65</td>
<td>getpgrp</td>
<td>Get process group</td>
</tr>
<tr>
<td>11</td>
<td>execve</td>
<td>Load and run program</td>
<td>67</td>
<td>sigaction</td>
<td>Install portable signal handler</td>
</tr>
<tr>
<td>19</td>
<td>lseek</td>
<td>Go to file offset</td>
<td>90</td>
<td>mmap</td>
<td>Map memory page to file</td>
</tr>
<tr>
<td>20</td>
<td>getpid</td>
<td>Get process ID</td>
<td>106</td>
<td>stat</td>
<td>Get information about file</td>
</tr>
</tbody>
</table>
<p>(Linux provides hundreds of system calls. Source: /usr/include/sys/syscall.h.)</p>
<ol>
<li>Each system call has a unique integer number that corresponds to an offset in a jump table in the kernel.</li>
</ol>
<h3 id="2-Processes"><a href="#2-Processes" class="headerlink" title="2.Processes"></a>2.Processes</h3><ol>
<li>Def: a process is an instance of a program in execution.<ol>
<li>In the context of the process,  includes the program’s code and data stored in memory, its stack, the contents of its generalpurpose registers, its program counter, environment variables, and the set of open<br>file descriptors.</li>
</ol>
</li>
</ol>
<h4 id="Logical-control-flow"><a href="#Logical-control-flow" class="headerlink" title="Logical control flow"></a>Logical control flow</h4><ol>
<li>a series of program counter (PC) values that corresponded exclusively to instructions contained in our program’s executable object file or in shared objects linked into our program dynamically at run time.</li>
<li>Concurrency : multiple flow working together (distinct from parallel flows, on diff core)</li>
<li>Multitask : a process taking turns with other processes.</li>
<li>Time slicing : run a portion of its flow</li>
</ol>
<h4 id="Private-address-space"><a href="#Private-address-space" class="headerlink" title="Private address space"></a>Private address space</h4><ol>
<li>User mode and kernel mode, a mode bit is set to distinct.</li>
<li>the only way to switch user mode to kernel mode is via <strong>exceptions</strong>  (such as interrupt, fault and trapping sys call)</li>
</ol>
<h4 id="Context-switches"><a href="#Context-switches" class="headerlink" title="Context switches"></a>Context switches</h4><ol>
<li>Multitask is implemented using <strong><em>Context Switch</em></strong>. Kernal maintains a context for each process. <ol>
<li>saves the context of the current process</li>
<li>restore saved context</li>
<li>pass control to this restored process</li>
</ol>
</li>
<li>Scheduler in Kernel decides to preempt current process and resume previously preempted process.</li>
</ol>
<h3 id="3-Process-Control"><a href="#3-Process-Control" class="headerlink" title="3 Process Control"></a>3 Process Control</h3><ol>
<li>Obtain process ID with getpid and getppid.</li>
<li>For programmer: process can have three stages:<ol>
<li>Running, process is either executing or waiting.</li>
<li>Stopped, execution suspended and will not be scheduled. Proc stops receiving a SIGSTOP, SIGTSTP, SIGTTIN or SIGTTOU signal. Remains stopped until it receives a SIGCONT signal (<strong><em>A signal is software interrupt</em></strong>). </li>
<li>Terminated, </li>
</ol>
</li>
<li><p>Create new process with <strong><em>fork</em></strong> function</p>
<ol>
<li>child process has copy of parent private address space.</li>
<li><p>Reap child process. return exit status to parents.</p>
<ol>
<li>waitpid(pid_t pid, int status, int options);</li>
<li>options:<ol>
<li>waitpid() system call suspends execution of the calling process until a child specified by pid argument has changed  state(Use WUNTRACE).</li>
<li>WNOHANG, return immediately even if none of the child process terminated.<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ***Using the waitpid function to reap zombie children in no particular order***.</span></span><br><span class="line"><span class="number">1</span> <span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"csapp.h"</span></span></span><br><span class="line"><span class="number">2</span> <span class="meta">#<span class="meta-keyword">define</span> N 2</span></span><br><span class="line"><span class="number">3</span></span><br><span class="line"><span class="number">4</span> <span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function">5 </span>&#123;</span><br><span class="line"><span class="number">6</span> <span class="keyword">int</span> status, i;</span><br><span class="line"><span class="number">7</span> <span class="keyword">pid_t</span> pid;</span><br><span class="line"><span class="number">8</span></span><br><span class="line"><span class="number">9</span> <span class="comment">/* Parent creates N children */</span></span><br><span class="line"><span class="number">10</span> <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; N; i++)</span><br><span class="line"><span class="number">11</span> <span class="keyword">if</span> ((pid = Fork()) == <span class="number">0</span>) <span class="comment">/* Child */</span></span><br><span class="line"><span class="number">12</span> <span class="built_in">exit</span>(<span class="number">100</span>+i);</span><br><span class="line"><span class="number">13</span></span><br><span class="line"><span class="number">14</span> <span class="comment">/* Parent reaps N children in no particular order */</span></span><br><span class="line"><span class="number">15</span> <span class="keyword">while</span> ((pid = waitpid(<span class="number">-1</span>, &amp;status, <span class="number">0</span>)) &gt; <span class="number">0</span>) &#123;</span><br><span class="line"><span class="number">16</span> <span class="keyword">if</span> (WIFEXITED(status))</span><br><span class="line"><span class="number">17</span> <span class="built_in">printf</span>(<span class="string">"child %d terminated normally with exit status=%d\n"</span>,</span><br><span class="line"><span class="number">18</span> pid, WEXITSTATUS(status));</span><br><span class="line"><span class="number">19</span> <span class="keyword">else</span></span><br><span class="line"><span class="number">20</span> <span class="built_in">printf</span>(<span class="string">"child %d terminated abnormally\n"</span>, pid);</span><br><span class="line"><span class="number">21</span> &#125;</span><br><span class="line"><span class="number">22</span></span><br><span class="line"><span class="number">23</span> <span class="comment">/* The only normal termination is if there are no more children */</span></span><br><span class="line"><span class="number">24</span> <span class="keyword">if</span> (errno != ECHILD) <span class="comment">//errno returns error number</span></span><br><span class="line"><span class="number">25</span> unix_error(<span class="string">"waitpid error"</span>);</span><br><span class="line"><span class="number">26</span></span><br><span class="line"><span class="number">27</span> <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line"><span class="number">28</span> &#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
</li>
</ol>
<p>c. Check exit status of reaped Child:</p>
<pre><code><figure class="highlight plain"><figcaption><span>true only if exited normally```</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">```WEXITSTATUS:returns exit status</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><figcaption><span>true only if exited normally```</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">```WIFSIGNALED:returns true only if terminated by signal not caught</span><br></pre></td></tr></table></figure>
</code></pre></li>
</ol>
</li>
</ol>
<pre><code>d. Order of reap is unique in each system. To make sure the order of reap:
</code></pre><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span> <span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"csapp.h"</span></span></span><br><span class="line"><span class="number">2</span> <span class="meta">#<span class="meta-keyword">define</span> N 2</span></span><br><span class="line"><span class="number">3</span></span><br><span class="line"><span class="number">4</span> <span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function">5 </span>&#123;</span><br><span class="line"><span class="number">6</span> <span class="keyword">int</span> status, i;</span><br><span class="line"><span class="number">7</span> <span class="keyword">pid_t</span> pid[N], retpid;</span><br><span class="line"><span class="number">8</span></span><br><span class="line"><span class="number">9</span> <span class="comment">/* Parent creates N children */</span></span><br><span class="line"><span class="number">10</span> <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; N; i++)</span><br><span class="line"><span class="number">11</span> <span class="keyword">if</span> ((pid[i] = Fork()) == <span class="number">0</span>) <span class="comment">/* Child */</span></span><br><span class="line"><span class="number">12</span> <span class="built_in">exit</span>(<span class="number">100</span>+i);</span><br><span class="line"><span class="number">13</span></span><br><span class="line"><span class="number">14</span> <span class="comment">/* Parent reaps N children in order */</span></span><br><span class="line"><span class="number">15</span> i = <span class="number">0</span>;</span><br><span class="line"><span class="number">16</span> <span class="keyword">while</span> ((retpid = waitpid(pid[i++], &amp;status, <span class="number">0</span>)) &gt; <span class="number">0</span>) &#123;</span><br><span class="line"><span class="number">17</span> <span class="keyword">if</span> (WIFEXITED(status))</span><br><span class="line"><span class="number">18</span> <span class="built_in">printf</span>(<span class="string">"child %d terminated normally with exit status=%d\n"</span>,</span><br><span class="line"><span class="number">19</span> retpid, WEXITSTATUS(status));</span><br><span class="line"><span class="number">20</span> <span class="keyword">else</span></span><br><span class="line"><span class="number">21</span> <span class="built_in">printf</span>(<span class="string">"child %d terminated abnormally\n"</span>, retpid);</span><br><span class="line"><span class="number">22</span> &#125;</span><br><span class="line"><span class="number">23</span></span><br><span class="line"><span class="number">24</span> <span class="comment">/* The only normal termination is if there are no more children */</span></span><br><span class="line"><span class="number">25</span> <span class="keyword">if</span> (errno != ECHILD)</span><br><span class="line"><span class="number">26</span> unix_error(<span class="string">"waitpid error"</span>);</span><br><span class="line"><span class="number">27</span></span><br><span class="line"><span class="number">28</span> <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line"><span class="number">29</span> &#125;</span><br></pre></td></tr></table></figure>
<p>​              </p>
<ol start="4">
<li>Sleep function </li>
<li>Loading and running program, </li>
</ol>
<h3 id="4-Signal"><a href="#4-Signal" class="headerlink" title="4.Signal"></a>4.Signal</h3><ol>
<li>Signal is a message that notify a process that an event of some type happened in the system.(<em>man 7 signal</em> to check signals list)<ol>
<li>Upon receiving a signal, the process can either ignore, terminate or <strong><em>catch</em></strong>  the signal in user-level application, known as a signal handler.</li>
<li>Signal sent but not yet received is called a pending signal.</li>
<li>/bin/kill program function actually sends a signal to certain process.</li>
</ol>
</li>
<li>Process group(One process has only one group):<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="keyword">pid_t</span> getpgrp(<span class="keyword">void</span>);</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">setpgid</span><span class="params">(<span class="keyword">pid_t</span> pid, <span class="keyword">pid_t</span> pgid)</span></span>; <span class="comment">//Change a process PID to process group pgid</span></span><br><span class="line"><span class="comment">/*Returns: process group ID of calling process*/</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>To switch group id:<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">setpgid</span><span class="params">(<span class="keyword">pid_t</span> pid, <span class="keyword">pid_t</span> pgid)</span></span>;</span><br><span class="line"><span class="comment">/*Returns: 0 on success, −1 on error*/</span></span><br></pre></td></tr></table></figure></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Unix&gt; /bin/kill <span class="number">-9</span> <span class="number">15213</span> <span class="comment">// kills all process in group 15213</span></span><br></pre></td></tr></table></figure>
<ol start="3">
<li>Unix shells use <strong><em>job</em></strong> to represent the <strong><em>processes</em></strong> that are created as a result of eval a command line.</li>
<li>Use kill func to send signal to other process<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">kill</span><span class="params">(<span class="keyword">pid_t</span> pid, <span class="keyword">int</span> sig)</span></span>;</span><br><span class="line">Returns: <span class="number">0</span> <span class="keyword">if</span> OK, −<span class="number">1</span> on error</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>Applies Signal handler <strong><em>Signal</em></strong>, otherwise handle the signal in default way, check man 7 signal<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span> <span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"csapp.h"</span></span></span><br><span class="line"><span class="number">2</span></span><br><span class="line"><span class="number">3</span> <span class="function"><span class="keyword">void</span> <span class="title">handler</span><span class="params">(<span class="keyword">int</span> sig)</span></span></span><br><span class="line"><span class="function">4 </span>&#123;</span><br><span class="line"><span class="number">5</span> <span class="keyword">static</span> <span class="keyword">int</span> beeps = <span class="number">0</span>;</span><br><span class="line"><span class="number">6</span></span><br><span class="line"><span class="number">7</span> <span class="built_in">printf</span>(<span class="string">"BEEP\n"</span>);</span><br><span class="line"><span class="number">8</span> <span class="keyword">if</span> (++beeps &lt; <span class="number">5</span>)</span><br><span class="line"><span class="number">9</span> Alarm(<span class="number">1</span>); <span class="comment">/* Next SIGALRM will be delivered in 1 second */</span></span><br><span class="line"><span class="number">10</span> <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="number">11</span> <span class="built_in">printf</span>(<span class="string">"BOOM!\n"</span>);</span><br><span class="line"><span class="number">12</span> <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line"><span class="number">13</span> &#125;</span><br><span class="line"><span class="number">14</span> &#125;</span><br><span class="line"><span class="number">15</span></span><br><span class="line"><span class="number">16</span> <span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function">17 </span>&#123;</span><br><span class="line"><span class="number">18</span> Signal(SIGALRM, handler); <span class="comment">/* Install SIGALRM handler */</span></span><br><span class="line"><span class="number">19</span> Alarm(<span class="number">1</span>); <span class="comment">/* Next SIGALRM will be delivered in 1s */</span></span><br><span class="line"><span class="number">20</span></span><br><span class="line"><span class="number">21</span> <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line"><span class="number">22</span> ; <span class="comment">/* Signal handler returns control here each time */</span></span><br><span class="line"><span class="number">23</span> &#125;</span><br><span class="line"><span class="number">24</span> <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line"><span class="number">25</span> &#125;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">sighandler_t</span> signal(<span class="keyword">int</span> signum, <span class="keyword">sighandler_t</span> handler);</span><br></pre></td></tr></table></figure>
<p>Unless specified, handler could be in following three forms:<br>1.SIG_IGN<br>2.SIG_DFL<br>3.User defined signal handler</p>
<ol start="3">
<li>For multiple signals receipt:<ol>
<li>Pendings signals are not queued.</li>
</ol>
</li>
<li><p>Posix:</p>
<ol>
<li>Only signals of the type currently being processed by the handler are blocked.</li>
<li>As with all signal implementations, signals are not queued.</li>
<li>Interrupted system calls are automatically restarted whenever possible.</li>
</ol>
</li>
<li>Process is forced to execute hander for pending signal.(Therefore rise the need to block certain signals)</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span> <span class="function"><span class="keyword">void</span> <span class="title">handler</span><span class="params">(<span class="keyword">int</span> sig)</span></span></span><br><span class="line"><span class="function">2 </span>&#123;</span><br><span class="line"><span class="number">3</span> <span class="keyword">pid_t</span> pid;</span><br><span class="line"><span class="number">4</span> <span class="keyword">while</span> ((pid = waitpid(<span class="number">-1</span>, <span class="literal">NULL</span>, <span class="number">0</span>)) &gt; <span class="number">0</span>) <span class="comment">/* Reap a zombie child */</span></span><br><span class="line"><span class="number">5</span> deletejob(pid); <span class="comment">/* Delete the child from the job list */</span></span><br><span class="line"><span class="number">6</span> <span class="keyword">if</span> (errno != ECHILD)</span><br><span class="line"><span class="number">7</span> unix_error(<span class="string">"waitpid error"</span>);</span><br><span class="line"><span class="number">8</span> &#125;</span><br><span class="line"><span class="number">9</span></span><br><span class="line"><span class="number">10</span> <span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span></span></span><br><span class="line"><span class="function">11 </span>&#123;</span><br><span class="line"><span class="number">12</span> <span class="keyword">int</span> pid;</span><br><span class="line"><span class="number">13</span> <span class="keyword">sigset_t</span> mask;</span><br><span class="line"><span class="number">14</span></span><br><span class="line"><span class="number">15</span> Signal(SIGCHLD, handler);</span><br><span class="line"><span class="number">16</span> initjobs(); <span class="comment">/* Initialize the job list */</span></span><br><span class="line"><span class="number">17</span></span><br><span class="line"><span class="number">18</span> <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line"><span class="number">19</span> Sigemptyset(&amp;mask);</span><br><span class="line"><span class="number">20</span> Sigaddset(&amp;mask, SIGCHLD);</span><br><span class="line"><span class="number">21</span> Sigprocmask(SIG_BLOCK, &amp;mask, <span class="literal">NULL</span>); <span class="comment">/* Block SIGCHLD */</span></span><br><span class="line"><span class="number">22</span></span><br><span class="line"><span class="number">23</span> <span class="comment">/* Child process */</span></span><br><span class="line"><span class="number">24</span> <span class="keyword">if</span> ((pid = Fork()) == <span class="number">0</span>) &#123;</span><br><span class="line"><span class="number">25</span> Sigprocmask(SIG_UNBLOCK, &amp;mask, <span class="literal">NULL</span>); <span class="comment">/* Unblock SIGCHLD */</span></span><br><span class="line"><span class="number">26</span> Execve(<span class="string">"/bin/date"</span>, argv, <span class="literal">NULL</span>);</span><br><span class="line"><span class="number">27</span> &#125;</span><br><span class="line"><span class="number">28</span></span><br><span class="line"><span class="number">29</span> <span class="comment">/* Parent process */</span></span><br><span class="line"><span class="number">30</span> addjob(pid); <span class="comment">/* Add the child to the job list */</span></span><br><span class="line"><span class="number">31</span> Sigprocmask(SIG_UNBLOCK, &amp;mask, <span class="literal">NULL</span>); <span class="comment">/* Unblock SIGCHLD */</span></span><br><span class="line"><span class="number">32</span> &#125;</span><br><span class="line"><span class="number">33</span> <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line"><span class="number">34</span> &#125;</span><br></pre></td></tr></table></figure>
<h3 id="5-Non-local-jumps"><a href="#5-Non-local-jumps" class="headerlink" title="5.Non local jumps"></a>5.Non local jumps</h3><ol>
<li>Def : a jump of function to another currently executing function without having to go through the normal call-and-return function.</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;setjmp.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">setjmp</span><span class="params">(jmp_buf env)</span></span>; <span class="comment">//save current env, including program counter, stack pointer, and genera l registers.</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sigsetjmp</span><span class="params">(sigjmp_buf env, <span class="keyword">int</span> savesigs)</span></span>; <span class="comment">// </span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">longjmp</span><span class="params">(jmp_buf env, <span class="keyword">int</span> retval)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">siglongjmp</span><span class="params">(sigjmp_buf env, <span class="keyword">int</span> retval)</span></span>;</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>Goto statement is very useful but limited for cross function jump. setjump and longjump solves such a issue.<ol>
<li>setjump is called once, but return multiple times.</li>
<li>when a <strong><em>longjump</em></strong> is called, it returns to <strong><em>setjump</em></strong> and restore the condition of <strong><em>setjump</em></strong>, except <strong><em>setjump</em></strong> value being set to <strong><em>retval</em></strong></li>
</ol>
</li>
</ol>
<h3 id="Week-X-1-Memory"><a href="#Week-X-1-Memory" class="headerlink" title="Week X+1 Memory"></a>Week X+1 Memory</h3><h4 id="1-Physical-and-Virtual-Addressing"><a href="#1-Physical-and-Virtual-Addressing" class="headerlink" title="1. Physical and Virtual Addressing"></a>1. Physical and Virtual Addressing</h4><p><strong><em>Physical addressing</em></strong> : when CPU executes a <strong><em>load instruction</em></strong> , it maps a physical address directly, passing it to main memory with <em>memory bus</em>.  </p>
<p><img src="/2019/02/25/csapp/Physical Addressing.png" alt="Physical Addressing"></p>
<p><strong><em>Virtual Addressing</em></strong> : CPU accesses main memory by generating a <em>virtual address</em>( <strong>VA</strong> ), which is converted to the appropriate physical address through <em>Memory Management Unit</em> (MMU). Such a task is referred to as <em>address translation</em>. </p>
<p>Notes : Like Exception handling in previous chapter, address translation requires close collaboration between CPU hardware and OS.</p>
<p>MMU uses a  <strong><em>look-up table</em></strong> stored in main memory whose contents are managed by OS.</p>
<p><img src="/2019/02/25/csapp/Virtual Addressing.png" alt="Physical Addressing"></p>
<p># </p>
<h4 id="2-Address-space"><a href="#2-Address-space" class="headerlink" title="2 Address space"></a>2 Address space</h4><ol>
<li><p>Virtual address space</p>
</li>
<li><p>Physical address space</p>
</li>
</ol>
<figure class="highlight"><figcaption><span>idea of virtual memory : Each byte of main memory has a VA from virtual address space, a PA from physical address space.```</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#### 3. VM as a tool for caching</span><br><span class="line"></span><br><span class="line">![How a VM system uses main memory as a cache](VM.png)</span><br><span class="line"></span><br><span class="line"><span class="number">1.</span> VM sys partition virtual memory into fixed size blocks, called ***pages***. Each page is <span class="number">2</span>^p bytes in size. Physical pages called ***page frame***.</span><br><span class="line"></span><br><span class="line"><span class="number">2.</span> At any time, a page is partitioned into three disjoint parts:</span><br><span class="line"></span><br><span class="line">   1. Unallocated, VM hasn't assigned any memory, therefore no data associated with.</span><br><span class="line">   2. Cached, i.e pages 1 4 6</span><br><span class="line">   3. Uncached, i.e pages 2 5 7</span><br><span class="line"></span><br><span class="line"><span class="number">3.</span> ***Page Tables*** :  an array of ***page table entries*** (PTE). <span class="keyword">locate</span> <span class="keyword">and</span> update cached memory</span><br><span class="line"></span><br><span class="line">   1. Valid bit : for cache status</span><br><span class="line">   2. If valid bit not set, then a NULL address indicates that the virtual pages has not yet been allocated. Otherwise, the address points to the ***start of the virtual page*** on disk.</span><br><span class="line">   3. ![Page Table](Page Table.png)</span><br><span class="line"></span><br><span class="line"><span class="number">4.</span> VM page hit</span><br><span class="line"></span><br><span class="line">   1. </span><br><span class="line">   2. ![VM page hit](VM Page Hit.png)</span><br><span class="line"></span><br><span class="line"><span class="number">5.</span> DRAM cache miss is known as a page fault:</span><br><span class="line"></span><br><span class="line">   1. ![VM page fault](VM page fault.png)</span><br><span class="line"></span><br><span class="line">   2. Invokes a page fault handler,  which selects a victim page and copy back to disk.</span><br><span class="line"></span><br><span class="line">       ![VM page fault after](VM page fault after.png)</span><br><span class="line"></span><br><span class="line"><span class="number">6.</span> VM parlance:</span><br><span class="line"></span><br><span class="line">   1. Blocks : Pages</span><br><span class="line">   2. Swapping/paging : transfer between main memory and disk</span><br><span class="line">   3. Write back : demand paging</span><br><span class="line"></span><br><span class="line"><span class="number">7.</span> Locality <span class="keyword">to</span> <span class="keyword">save</span> again</span><br><span class="line"></span><br><span class="line">   1. Tend to work on a smaller set of ***active pages***, known as the working set or resident set.</span><br><span class="line">   2. ***Thrashing***:  working set size exceeds that of physical memory.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#### 4. VM as a tool of memory managment</span><br><span class="line"></span><br><span class="line"><span class="number">1.</span> OS provides separate page table <span class="keyword">and</span> virtual space <span class="keyword">for</span> ***each process***.</span><br><span class="line"><span class="number">2.</span> ![Multi-page mapping](Multi-table.png)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#### 5. VM as a tool for memory protection</span><br><span class="line"></span><br><span class="line"><span class="number">1.!</span>[VM memory protection](VM memory protection.png)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#### 6.  Address translation</span><br><span class="line"></span><br><span class="line">![Address Translation](Address Translation.png)</span><br><span class="line"></span><br><span class="line"> 1. A control register in CPU, points to page table</span><br><span class="line"></span><br><span class="line"> 2. VPA = VPN + VPO</span><br><span class="line"></span><br><span class="line"> 3. PPA = PPN + PPO( = VPO)</span><br><span class="line"></span><br><span class="line">    ​															</span><br><span class="line"></span><br><span class="line">![Page hit and fault](Page hit and fault.png)</span><br><span class="line"></span><br><span class="line"><span class="number">4.</span> ***Translation Lookaside Buffer(TLB)***</span><br><span class="line"><span class="number">5.</span> TLB hit <span class="keyword">and</span> miss:</span><br><span class="line">   1. Step 1: The CPU generates a virtual address.</span><br><span class="line">   2. Steps 2 and 3: The MMU fetches the appropriate PTE from the TLB.</span><br><span class="line">   3. Step 4: The MMU translates the virtual address to a physical address and ends it to the cache/main memory.</span><br><span class="line">   4. Step 5: The cache/main memory returns the requested data word to the CPU</span><br><span class="line">   5. ![TLB hit and miss](TLB hit and miss.png)</span><br><span class="line"></span><br><span class="line">##### 6.1 Multi-level page</span><br><span class="line"></span><br><span class="line"><span class="number">1.</span> ![multi-level table](multi-level table.png)</span><br><span class="line"><span class="number">2.</span> Basic info:</span><br><span class="line">   1. 32-bit virtual address space, partitioned into 4 KB pages, with page table entries that are 4 bytes each.</span><br><span class="line">   2. Virtual address space has the following form: The first 2K pages of memory are allocated for code and data, the next 6K pages are unallocated, the next 1023 pages are also unallocated, and the next page is allocated for the user stack.</span><br><span class="line">   3. Each PTE in the level-1 table is responsible for mapping a 4 MB (4KB * 1024 page ) chunk of the virtual address space, where each chunk consists of 1024 contiguous pages. For example, PTE 0 maps the first chunk, PTE 1 the next chunk, and so on. Given that the address space is 4 GB, 1024 PTEs are sufficient to cover the entire space.</span><br><span class="line"><span class="number">3.</span> k-level page table briefing :</span><br><span class="line">   1. ![k-level page table](k-level page table.png)</span><br><span class="line"><span class="number">4.</span> Putting It Together: <span class="keyword">End</span>-<span class="keyword">to</span>-<span class="keyword">end</span> Address Translation</span><br><span class="line">   1. a concrete example of end-to-end address translation on a small system with a TLB and L1 d-cache.</span><br><span class="line">   2. . Virtual addresses are 14 bits wide (n = 14).</span><br><span class="line">   3. . Physical addresses are 12 bits wide (m = 12).</span><br><span class="line">   4. . The page size is 64 bytes (P = 64).</span><br><span class="line">   5. . The TLB is four-way set associative with 16 total entries.</span><br><span class="line">   6. . The L1 d-cache is physically addressed and direct mapped, with a 4-byte line size and 16 total sets.</span><br><span class="line">   7. ![Addressing of small memory system](Addressing of small memory system.png)</span><br><span class="line">   8. ![detail](detail1.png)</span><br><span class="line">      1. ![detail](detail2.png)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#### 7 Memory mapping</span><br><span class="line"></span><br><span class="line"><span class="number">1.</span> Linux (along with other forms of Unix) initializes the contents of a virtual memory area by associating it with an object <span class="keyword">on</span> disk, a process known as ***memory  mapping***.</span><br><span class="line">   1. Areas can be mapped into two types of objects:</span><br><span class="line">      1. Regular file in the Unix file system.</span><br><span class="line">      2. Anonymous file.</span><br><span class="line"></span><br><span class="line">#### 8 Dynamic Memory Allocation</span><br><span class="line"></span><br><span class="line"><span class="number">1.</span> Dynamic memory allocator maintains an area of a process<span class="comment">'s virtual memory known as the *heap*.</span></span><br><span class="line">   1. ![heap](heap.png)</span><br><span class="line">   2. An allocator maintains the heap as a collection of various-sized blocks. Each</span><br><span class="line">      block is a contiguous chunk of virtual memory that is either allocated or free.</span><br><span class="line">   3. Explicit allocators and implicit allocators( Diff: free mem yourself)</span><br><span class="line">   4. *brk* points to the top of heap</span><br><span class="line"><span class="number">2.</span> The *sbrk* function grows <span class="keyword">or</span> shrinks the heap by adding  *incr* <span class="keyword">to</span> the kernel <span class="comment">'s *brk* pointer. </span></span><br><span class="line">   1. ```void *sbrk(intptr_t incr);</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>If successful, returns the old pointer.</li>
<li>if incr == 0, returns <em>brk</em> pointer</li>
<li><img src="/2019/02/25/csapp/Allocate and free.png" alt="Allocate and free"><ol start="3">
<li>Explicit allocator requirements and goals</li>
</ol>
</li>
<li>Handling arbitrary request sequences</li>
<li>Making immediate responses to requests</li>
<li>Using only the heap, </li>
<li>Aligning blocks (alignment requirement), The allocator must align blocks in<br>such a way that they can hold any type of data object. On most systems, this<br>means that the block returned by the allocator is aligned on an 8-byte (double word) boundary.</li>
<li>Fragmentation :<ol>
<li>Internal fragmentation : payload size less than block size</li>
<li>External fragmentation : occurs when there is enough aggregate free memory to satisfy an allocate request, but no single free block is large enough to handle the request.</li>
</ol>
</li>
<li>Design question :<ol>
<li>Free block organization: How do we keep track of free blocks?</li>
<li>Placement: How do we choose an appropriate free block in which to place a newly allocated block?</li>
<li>Splitting: After we place a newly allocated block in some free block, what do we do with the remainder of the free block?</li>
<li>Coalescing: What do we do with a block that has just been freed?<ol>
<li>Previous free block : boundary tag</li>
</ol>
</li>
</ol>
</li>
</ol>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2019/01/10/Flask-tutorial/" rel="next" title="Flask_tutorial">
                <i class="fa fa-chevron-left"></i> Flask_tutorial
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">Tjianke</p>
              <p class="site-description motion-element" itemprop="description">It's my personal blog.</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">15</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            

            
              
              
              <div class="site-state-item site-state-tags">
                
                  <span class="site-state-item-count">2</span>
                  <span class="site-state-item-name">标签</span>
                
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#Short-intro-to-C"><span class="nav-number">1.</span> <span class="nav-text">Short intro to C:</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Warm-up"><span class="nav-number">1.1.</span> <span class="nav-text">Warm up</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Noisy-pointer"><span class="nav-number">1.2.</span> <span class="nav-text">Noisy pointer</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#String-representation"><span class="nav-number">1.3.</span> <span class="nav-text">String representation</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Shift-operation-in-C"><span class="nav-number">1.4.</span> <span class="nav-text">Shift operation in C:</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#1-A-tour-to-computer-System"><span class="nav-number"></span> <span class="nav-text">1. A tour to computer System</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-1-Information-is-Bits-Context"><span class="nav-number"></span> <span class="nav-text">1.1 Information is Bits + Context</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-2-Programs-are-translated-by-other-Programs-into-Different-forms"><span class="nav-number"></span> <span class="nav-text">1.2 Programs are translated by other Programs into Different forms</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-5-Caches-Matter"><span class="nav-number"></span> <span class="nav-text">1.5 Caches Matter</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-6-Storage-devices-form-a-Hierarchy"><span class="nav-number"></span> <span class="nav-text">1.6 Storage devices form a Hierarchy</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-7-The-Operating-System-Manages-the-Hardware"><span class="nav-number"></span> <span class="nav-text">1.7 The Operating System Manages the Hardware</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1-9-Logical-operations-in-C"><span class="nav-number">1.</span> <span class="nav-text">2.1.9 Logical operations in C</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1-10-Shift-operations-in-C"><span class="nav-number">2.</span> <span class="nav-text">2.1.10 Shift operations in C</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-2-Integer-Representation"><span class="nav-number"></span> <span class="nav-text">2.2 Integer Representation</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-2-Unsigned-Encodings"><span class="nav-number">1.</span> <span class="nav-text">2.2.2 Unsigned Encodings</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-3-Signed-Encodings"><span class="nav-number">2.</span> <span class="nav-text">2.2.3 Signed Encodings</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-4-Conversions-Between-signed-and-unsigned"><span class="nav-number">3.</span> <span class="nav-text">2.2.4 Conversions Between signed and unsigned</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-5-Unsigned-and-signed-in-C"><span class="nav-number">4.</span> <span class="nav-text">2.2.5 Unsigned and signed in C</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-6-Expanding-the-Bit-Representation-of-a-Number"><span class="nav-number">5.</span> <span class="nav-text">2.2.6 Expanding the Bit Representation of a Number</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-7-Truncating-Number"><span class="nav-number">6.</span> <span class="nav-text">2.2.7  Truncating Number</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-8-Advice-on-Signed-vs-Unsigned"><span class="nav-number">7.</span> <span class="nav-text">2.2.8 Advice on Signed vs Unsigned</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-2-3-Notes-on-formatting"><span class="nav-number">8.</span> <span class="nav-text">3.2.3 Notes on formatting</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-3-Data-Formats"><span class="nav-number"></span> <span class="nav-text">3.3 Data Formats</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-4-Accessing-information"><span class="nav-number"></span> <span class="nav-text">3.4 Accessing information</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-4-1-Operand-Specifiers"><span class="nav-number">1.</span> <span class="nav-text">3.4.1 Operand Specifiers</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-4-2-Data-Movement-Instructions"><span class="nav-number">2.</span> <span class="nav-text">3.4.2 Data Movement Instructions</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-4-3-Data-Movement-Example"><span class="nav-number">3.</span> <span class="nav-text">3.4.3 Data Movement Example</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-5-Arithmetic-and-Logical-Operations"><span class="nav-number"></span> <span class="nav-text">3.5 Arithmetic and Logical Operations</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-5-1-Load-Effective-Address"><span class="nav-number">1.</span> <span class="nav-text">3.5.1 Load Effective Address</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-5-2-amp-3-5-3-Unary-Binary-and-Shift-Operation"><span class="nav-number">2.</span> <span class="nav-text">3.5.2 &amp; 3.5.3 Unary, Binary and Shift Operation</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-6-Controls"><span class="nav-number"></span> <span class="nav-text">3.6 Controls</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-6-1-Conditional-code"><span class="nav-number">1.</span> <span class="nav-text">3.6.1 Conditional code</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-6-2-Accessing-Conditional-Code"><span class="nav-number">2.</span> <span class="nav-text">3.6.2 Accessing Conditional Code</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-6-3-Jump-Instructions-and-Their-Encodings"><span class="nav-number">3.</span> <span class="nav-text">3.6.3 Jump Instructions and Their Encodings</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-6-4-Translating-conditional-branches"><span class="nav-number">4.</span> <span class="nav-text">3.6.4 Translating conditional branches</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-6-5-Loops"><span class="nav-number">5.</span> <span class="nav-text">3.6.5 Loops</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-6-6-Conditional-Move-Instructions"><span class="nav-number">6.</span> <span class="nav-text">3.6.6 Conditional Move Instructions</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-6-7-Switch"><span class="nav-number">7.</span> <span class="nav-text">3.6.7 Switch</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-7-Procedures"><span class="nav-number"></span> <span class="nav-text">3.7 Procedures</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-7-1-Stack-Frame-Structure"><span class="nav-number">1.</span> <span class="nav-text">3.7.1 Stack Frame Structure</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-7-2-Transferring-Control"><span class="nav-number">2.</span> <span class="nav-text">3.7.2 Transferring Control</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-7-3-Register-Usage-Convention"><span class="nav-number">3.</span> <span class="nav-text">3.7.3 Register Usage Convention</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-7-4-Procedure-Example"><span class="nav-number">4.</span> <span class="nav-text">3.7.4 Procedure Example</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-7-5-Recursive-Procedures"><span class="nav-number">5.</span> <span class="nav-text">3.7.5 Recursive Procedures</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-8-Array-Allocation-and-Access"><span class="nav-number"></span> <span class="nav-text">3.8 Array Allocation and Access</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-8-1-Basic-Principles"><span class="nav-number">1.</span> <span class="nav-text">3.8.1 Basic Principles</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-8-2-Pointer-Arithmetic"><span class="nav-number">2.</span> <span class="nav-text">3.8.2 Pointer Arithmetic</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-8-3-Nested-Array"><span class="nav-number">3.</span> <span class="nav-text">3.8.3 Nested Array</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-8-4-Fixed-size-array"><span class="nav-number">4.</span> <span class="nav-text">3.8.4 Fixed size array</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-8-5-Variable-size-array"><span class="nav-number">5.</span> <span class="nav-text">3.8.5 Variable size array</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-9-Heterogeneous-Data-Structures"><span class="nav-number"></span> <span class="nav-text">3.9 Heterogeneous Data Structures</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-9-1-Structures"><span class="nav-number">1.</span> <span class="nav-text">3.9.1 Structures</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-9-2-Unions"><span class="nav-number">2.</span> <span class="nav-text">3.9.2 Unions</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-9-3-Data-Alignments"><span class="nav-number">3.</span> <span class="nav-text">3.9.3 Data Alignments</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-10-Understanding-Pointers"><span class="nav-number"></span> <span class="nav-text">3.10 Understanding Pointers</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-11-Gdb-debugger"><span class="nav-number"></span> <span class="nav-text">3.11 Gdb debugger</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-12-Out-of-bounds-memory-reference-and-buffer-overflow"><span class="nav-number"></span> <span class="nav-text">3.12 Out-of-bounds memory reference and buffer overflow</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-12-1-Thwarting-Buffer-Overflow-Attacks"><span class="nav-number">1.</span> <span class="nav-text">3.12.1 Thwarting Buffer Overflow Attacks</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-13-Extending-to-64-bit"><span class="nav-number"></span> <span class="nav-text">3.13 Extending to 64 bit</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#4-Processor-Architecture"><span class="nav-number"></span> <span class="nav-text">4. Processor Architecture</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#5-Optimizing-Code-Performance"><span class="nav-number"></span> <span class="nav-text">5. Optimizing Code Performance</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#6-Memory-Hierarchy"><span class="nav-number"></span> <span class="nav-text">6. Memory Hierarchy</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#6-1-Storage-Technology"><span class="nav-number"></span> <span class="nav-text">6.1 Storage Technology</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#6-1-1-Random-Access-Memory"><span class="nav-number">1.</span> <span class="nav-text">6.1.1 Random Access Memory</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-1-2-Disk-Storage"><span class="nav-number">2.</span> <span class="nav-text">6.1.2 Disk Storage</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-1-3-Solid-State-Disks"><span class="nav-number">3.</span> <span class="nav-text">6.1.3 Solid State Disks</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-1-4-Storage-Tech-Trends"><span class="nav-number">4.</span> <span class="nav-text">6.1.4 Storage Tech Trends</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-2-Locality"><span class="nav-number"></span> <span class="nav-text">6.2 Locality</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-3-Memory-Hierarchy"><span class="nav-number"></span> <span class="nav-text">6.3 Memory Hierarchy</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#6-3-1-Caching-in-the-Memory-Hierarchy"><span class="nav-number">1.</span> <span class="nav-text">6.3.1 Caching in the Memory Hierarchy</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-3-2-Summary-of-Memory-Hierarchy"><span class="nav-number">2.</span> <span class="nav-text">6.3.2 Summary of Memory Hierarchy</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-4-Cache-Memories"><span class="nav-number"></span> <span class="nav-text">6.4 Cache Memories</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#6-4-1-Generic-Cache-Memory-Organization"><span class="nav-number">1.</span> <span class="nav-text">6.4.1 Generic Cache Memory Organization</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-4-2-Direct-Mapped-Caches"><span class="nav-number">2.</span> <span class="nav-text">6.4.2 Direct Mapped Caches</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-4-3-Set-Associative-Caches"><span class="nav-number">3.</span> <span class="nav-text">6.4.3 Set Associative Caches</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-4-4-Fully-Associative-Caches"><span class="nav-number">4.</span> <span class="nav-text">6.4.4 Fully Associative Caches</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-4-5-Issues-with-Writes"><span class="nav-number">5.</span> <span class="nav-text">6.4.5 Issues with Writes</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#7-Linking"><span class="nav-number"></span> <span class="nav-text">7. Linking</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#7-1-Compiler-Driver"><span class="nav-number"></span> <span class="nav-text">7.1 Compiler Driver</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#7-2-Static-Linking"><span class="nav-number"></span> <span class="nav-text">7.2 Static Linking</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#7-3-Object-Files"><span class="nav-number"></span> <span class="nav-text">7.3 Object Files</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#7-4-Relocatable-Object-Files"><span class="nav-number"></span> <span class="nav-text">7.4 Relocatable Object Files</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#7-5-Symbols-and-symbol-table"><span class="nav-number"></span> <span class="nav-text">7.5 Symbols and symbol table</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#7-6-Symbol-Resolution"><span class="nav-number"></span> <span class="nav-text">7.6 Symbol Resolution</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#7-6-1-How-Linkers-solve-Multiply-Defined-Global-Symbols"><span class="nav-number">1.</span> <span class="nav-text">7.6.1 How Linkers solve Multiply Defined Global Symbols</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-6-2-Linking-with-Static-Libraries"><span class="nav-number">2.</span> <span class="nav-text">7.6.2 Linking with Static Libraries</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-6-3-How-linkers-use-Static-Libraries-to-Resolve-References"><span class="nav-number">3.</span> <span class="nav-text">7.6.3 How linkers use Static Libraries to Resolve References</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#7-7-Relocation"><span class="nav-number"></span> <span class="nav-text">7.7 Relocation</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#7-7-1-Relocation-Entries"><span class="nav-number">1.</span> <span class="nav-text">7.7.1 Relocation Entries</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-7-2-Relocating-Symbol-References-disdetailed-in-15213"><span class="nav-number">2.</span> <span class="nav-text">7.7.2 Relocating Symbol References(disdetailed in 15213)</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#7-8-Executable-Object-Files"><span class="nav-number"></span> <span class="nav-text">7.8 Executable Object Files</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#7-9-Loading-Executable-Object-Files-Get-back-after-chapter-9"><span class="nav-number"></span> <span class="nav-text">7.9 Loading Executable Object Files(Get back after chapter 9)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#7-10-Dynamic-Linking-with-Shared-Libraries"><span class="nav-number"></span> <span class="nav-text">7.10 Dynamic Linking with Shared Libraries</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#7-11-Loading-and-linking-shared-libraries-from-app"><span class="nav-number"></span> <span class="nav-text">7.11 Loading and linking shared libraries from app</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#7-12-Position-Independent-Code-PIC"><span class="nav-number"></span> <span class="nav-text">7.12 Position Independent Code(PIC)</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#7-12-1-PIC-Data-Reference"><span class="nav-number">1.</span> <span class="nav-text">7.12.1 PIC Data Reference</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-12-2-PIC-Function-calls"><span class="nav-number">2.</span> <span class="nav-text">7.12.2 PIC Function calls</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#8-Exceptional-Control-Flow"><span class="nav-number"></span> <span class="nav-text">8. Exceptional Control Flow</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#8-1-Exceptions"><span class="nav-number"></span> <span class="nav-text">8.1 Exceptions</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#8-1-1-Exception-handling"><span class="nav-number">1.</span> <span class="nav-text">8.1.1 Exception handling</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-1-2-Classes-of-Exceptions"><span class="nav-number">2.</span> <span class="nav-text">8.1.2 Classes of Exceptions</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-1-3-Examples-Exceptions-in-Linux-IA32-System"><span class="nav-number">3.</span> <span class="nav-text">8.1.3 Examples : Exceptions in Linux/IA32 System</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#8-2-Processes"><span class="nav-number"></span> <span class="nav-text">8.2 Processes</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#8-2-1-Logical-Control-Flow"><span class="nav-number">1.</span> <span class="nav-text">8.2.1 Logical Control Flow</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-2-2-Concurrent-Flow"><span class="nav-number">2.</span> <span class="nav-text">8.2.2 Concurrent Flow</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-2-3-Private-Address-Space"><span class="nav-number">3.</span> <span class="nav-text">8.2.3 Private Address Space</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-2-4-User-and-Kernel-Mode"><span class="nav-number">4.</span> <span class="nav-text">8.2.4 User and Kernel Mode</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-2-5-Context-Switches"><span class="nav-number">5.</span> <span class="nav-text">8.2.5 Context Switches</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#8-3-System-Call-Error-Handling"><span class="nav-number"></span> <span class="nav-text">8.3 System Call Error Handling</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#8-4-Process-Control"><span class="nav-number"></span> <span class="nav-text">8.4 Process Control</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#8-4-1-Obtaining-Process-IDs"><span class="nav-number">1.</span> <span class="nav-text">8.4.1 Obtaining Process IDs</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-4-2-Creating-and-Terminating-Processes"><span class="nav-number">2.</span> <span class="nav-text">8.4.2 Creating and Terminating Processes</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-4-3-Reaping-Child-Process"><span class="nav-number">3.</span> <span class="nav-text">8.4.3 Reaping Child Process</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-4-4-Putting-Processes-to-Sleep"><span class="nav-number">4.</span> <span class="nav-text">8.4.4 Putting Processes to Sleep</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-4-5-Loading-and-Running-Program"><span class="nav-number">5.</span> <span class="nav-text">8.4.5 Loading and Running Program</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-4-6-Using-fork-and-execve-to-Run-Programs"><span class="nav-number">6.</span> <span class="nav-text">8.4.6 Using fork  and execve to Run Programs</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#8-5-Signals"><span class="nav-number"></span> <span class="nav-text">8.5 Signals</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#8-5-1-Signals-Terminology"><span class="nav-number">1.</span> <span class="nav-text">8.5.1 Signals Terminology</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-5-2-Sending-Signals"><span class="nav-number">2.</span> <span class="nav-text">8.5.2 Sending Signals</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-5-3-Receiving-Signals"><span class="nav-number">3.</span> <span class="nav-text">8.5.3 Receiving Signals</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-5-4-Signal-Handling-Issues"><span class="nav-number">4.</span> <span class="nav-text">8.5.4 Signal Handling Issues</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-5-5-Portable-Signal-Handling"><span class="nav-number">5.</span> <span class="nav-text">8.5.5 Portable Signal Handling</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-5-6-Explicitly-Blocking-and-Unblocking-Signals"><span class="nav-number">6.</span> <span class="nav-text">8.5.6 Explicitly Blocking and Unblocking Signals</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-5-7-Synchronizing-Flows-to-Avoid-Nasty-Concurrency-Bugs"><span class="nav-number">7.</span> <span class="nav-text">8.5.7 Synchronizing Flows to Avoid Nasty Concurrency Bugs</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#9-Virtual-Memory"><span class="nav-number"></span> <span class="nav-text">9. Virtual Memory</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#9-1-Physical-and-Virtual-Addressing"><span class="nav-number">1.</span> <span class="nav-text">9.1 Physical and Virtual Addressing</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#9-2-Address-Space"><span class="nav-number">2.</span> <span class="nav-text">9.2 Address Space</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#9-3-VM-as-a-tool-for-caching"><span class="nav-number">3.</span> <span class="nav-text">9.3 VM as a tool for caching</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#9-4-VM-as-a-tool-for-memory-management"><span class="nav-number">4.</span> <span class="nav-text">9.4 VM as a tool for memory management</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#9-5-VM-as-a-tool-for-memory-protection"><span class="nav-number">5.</span> <span class="nav-text">9.5 VM as a tool for memory protection</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#9-6-Address-translation"><span class="nav-number">6.</span> <span class="nav-text">9.6 Address translation</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#9-7-Case-study-The-intel-Corei7-Linux-memory-system"><span class="nav-number">7.</span> <span class="nav-text">9.7 Case study : The intel Corei7/Linux memory system</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#9-8-1-Shared-Objects-Revisited"><span class="nav-number">7.1.</span> <span class="nav-text">9.8.1 Shared Objects Revisited</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#9-9-Dynamic-Memory-Allocation"><span class="nav-number">8.</span> <span class="nav-text">9.9 Dynamic Memory Allocation</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#9-9-1-The-malloc-and-free-functions"><span class="nav-number">8.1.</span> <span class="nav-text">9.9.1 The malloc and free functions</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#9-9-2-Why-dynamic-memory-allocation"><span class="nav-number">8.2.</span> <span class="nav-text">9.9.2 Why dynamic memory allocation</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#9-9-3-Allocator-requirements-and-goal"><span class="nav-number">8.3.</span> <span class="nav-text">9.9.3 Allocator requirements and goal</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#9-9-4-Fragmentation"><span class="nav-number">8.4.</span> <span class="nav-text">9.9.4 Fragmentation</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#9-9-5-Implementation-issues"><span class="nav-number">8.5.</span> <span class="nav-text">9.9.5 Implementation issues</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#9-9-6-Implicit-free-list"><span class="nav-number">8.6.</span> <span class="nav-text">9.9.6 Implicit free list</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#9-9-7-Placing-Allocated-Blocks"><span class="nav-number">8.7.</span> <span class="nav-text">9.9.7 Placing Allocated Blocks</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#9-9-8-Splitting-Free-Blocks"><span class="nav-number">8.8.</span> <span class="nav-text">9.9.8 Splitting Free Blocks</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#9-9-9-Getting-Additional-Heap-Memory"><span class="nav-number">8.9.</span> <span class="nav-text">9.9.9 Getting Additional Heap Memory</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#9-9-10-Coalescing-free-blocks"><span class="nav-number">8.10.</span> <span class="nav-text">9.9.10 Coalescing free blocks</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#9-9-11-Coalescing-with-Boundary-Tags"><span class="nav-number">8.11.</span> <span class="nav-text">9.9.11 Coalescing with Boundary Tags</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#9-9-13-Explicit-free-lists"><span class="nav-number">8.12.</span> <span class="nav-text">9.9.13 Explicit free lists</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#9-9-14-Segregated-Free-Lists"><span class="nav-number">8.13.</span> <span class="nav-text">9.9.14 Segregated Free Lists</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#9-10-Garbage-Collection"><span class="nav-number">9.</span> <span class="nav-text">9.10 Garbage Collection</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#9-10-1-Garbage-Collector-Basics"><span class="nav-number">9.1.</span> <span class="nav-text">9.10.1 Garbage Collector Basics</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#9-10-2-Mark-amp-Sweep-Garbage-Collectors"><span class="nav-number">9.2.</span> <span class="nav-text">9.10.2 Mark&amp;Sweep Garbage Collectors</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#10-System-level-I-O"><span class="nav-number"></span> <span class="nav-text">10. System-level I/O</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#11-Network-Programming"><span class="nav-number"></span> <span class="nav-text">11 Network Programming</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#11-1-The-Client-server-programming-model"><span class="nav-number">1.</span> <span class="nav-text">11.1 The Client-server programming model</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#11-2-Networks"><span class="nav-number">2.</span> <span class="nav-text">11.2 Networks</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#11-3-Global-IP-Internet"><span class="nav-number">3.</span> <span class="nav-text">11.3 Global IP Internet</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#11-3-1-IP-Address"><span class="nav-number">3.1.</span> <span class="nav-text">11.3.1 IP Address</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#11-3-2-Internet-Domain-Names"><span class="nav-number">3.2.</span> <span class="nav-text">11.3.2 Internet Domain Names</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#11-3-3-Internet-Connections"><span class="nav-number">3.3.</span> <span class="nav-text">11.3.3 Internet Connections</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#11-4-The-Sockets-Interface"><span class="nav-number">3.4.</span> <span class="nav-text">11.4 The Sockets Interface</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#11-4-1-Socket-Address-Structure"><span class="nav-number">3.5.</span> <span class="nav-text">11.4.1 Socket Address Structure</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#11-4-2-The-Socket-Function"><span class="nav-number">3.6.</span> <span class="nav-text">11.4.2 The Socket Function</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#11-4-3-The-Connect-Function"><span class="nav-number">3.7.</span> <span class="nav-text">11.4.3 The Connect Function</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#11-4-4-The-open-clientfd-function"><span class="nav-number">3.8.</span> <span class="nav-text">11.4.4 The open_clientfd function</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#11-4-5-The-bind-Function"><span class="nav-number">3.9.</span> <span class="nav-text">11.4.5 The bind Function</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#11-4-6-The-listen-Function"><span class="nav-number">3.10.</span> <span class="nav-text">11.4.6 The listen Function</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#11-4-7-The-open-listenfd-Function"><span class="nav-number">3.11.</span> <span class="nav-text">11.4.7 The open_listenfd Function</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#11-4-8-The-accept-function"><span class="nav-number">3.12.</span> <span class="nav-text">11.4.8 The accept function</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#11-5-Web-Servers"><span class="nav-number">4.</span> <span class="nav-text">11.5 Web Servers</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#11-5-1-Web-Basics"><span class="nav-number">4.1.</span> <span class="nav-text">11.5.1 Web Basics</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#11-5-2-Web-Content"><span class="nav-number">4.2.</span> <span class="nav-text">11.5.2 Web Content</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#12-1-1-A-Concurrent-Server-Based-on-Process"><span class="nav-number">4.3.</span> <span class="nav-text">12.1.1 A Concurrent Server Based on Process</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#12-1-2-Pros-and-cons"><span class="nav-number">4.4.</span> <span class="nav-text">12.1.2 Pros and cons</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#12-2-Concurrent-programming-with-IO-multiplexing"><span class="nav-number">5.</span> <span class="nav-text">12.2 Concurrent programming with IO multiplexing</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#12-2-1-A-Concurrent-Event-driven-Server-based-on-I-O-Multiplexing"><span class="nav-number">5.1.</span> <span class="nav-text">12.2.1 A Concurrent Event-driven Server based on I/O Multiplexing</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#12-3-Concurrent-Programming-with-Threads"><span class="nav-number">6.</span> <span class="nav-text">12.3 Concurrent Programming with Threads</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#12-3-2-Posix-Threads"><span class="nav-number">6.1.</span> <span class="nav-text">12.3.2 Posix Threads</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#12-4-Shared-variables-in-Threaded-Programs"><span class="nav-number">7.</span> <span class="nav-text">12.4 Shared variables in Threaded Programs</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#12-4-2-Mapping-Variables-to-Memory"><span class="nav-number">7.1.</span> <span class="nav-text">12.4.2 Mapping Variables to Memory</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#12-4-3-Shared-Variables"><span class="nav-number">7.2.</span> <span class="nav-text">12.4.3 Shared Variables</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#12-5-Synchronizing-Threads-with-Semaphores"><span class="nav-number">8.</span> <span class="nav-text">12.5 Synchronizing Threads with Semaphores</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#12-5-1-Process-Graphs"><span class="nav-number">8.1.</span> <span class="nav-text">12.5.1 Process Graphs</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#12-5-2-Semaphore"><span class="nav-number">8.2.</span> <span class="nav-text">12.5.2 Semaphore</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Week-2-2-Machine-Prog-——-Controls"><span class="nav-number">8.3.</span> <span class="nav-text">Week 2.2 Machine Prog —— Controls</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-Condition-codes"><span class="nav-number">8.4.</span> <span class="nav-text">1.Condition codes</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Week-X-Exceptional-Control-Flow"><span class="nav-number">9.</span> <span class="nav-text">Week X  Exceptional Control Flow</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-Exceptions"><span class="nav-number">10.</span> <span class="nav-text">1.Exceptions</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Classes-of-exception"><span class="nav-number">10.1.</span> <span class="nav-text">Classes of exception</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#System-calls"><span class="nav-number">10.2.</span> <span class="nav-text">System calls</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-Processes"><span class="nav-number">11.</span> <span class="nav-text">2.Processes</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Logical-control-flow"><span class="nav-number">11.1.</span> <span class="nav-text">Logical control flow</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Private-address-space"><span class="nav-number">11.2.</span> <span class="nav-text">Private address space</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Context-switches"><span class="nav-number">11.3.</span> <span class="nav-text">Context switches</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-Process-Control"><span class="nav-number">12.</span> <span class="nav-text">3 Process Control</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-Signal"><span class="nav-number">13.</span> <span class="nav-text">4.Signal</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-Non-local-jumps"><span class="nav-number">14.</span> <span class="nav-text">5.Non local jumps</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Week-X-1-Memory"><span class="nav-number">15.</span> <span class="nav-text">Week X+1 Memory</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-Physical-and-Virtual-Addressing"><span class="nav-number">15.1.</span> <span class="nav-text">1. Physical and Virtual Addressing</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-Address-space"><span class="nav-number">15.2.</span> <span class="nav-text">2 Address space</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Tjianke</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
